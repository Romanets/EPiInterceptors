//>>built
define("epi/packaging/ModulesList",["dojo","dijit","dojo/cookie","dijit/_Widget","dijit/_TemplatedMixin","dojox/widget/Standby","epi/packaging/ModuleSummary","epi/i18n!epi/packaging/nls/EPiServer.Packaging.UI.ModulesList"],function(_1,_2,_3,_4,_5,_6,_7,_8){return _1.declare("epi.packaging.ModulesList",[_4,_5],{res:_8,antiForgeryData:null,templateString:"<div class=\"epi-listingContainer\"><ul data-dojo-attach-point=\"_modulesListPlaceholder\" class=\"epi-advancedListing\"></ul></div>",listItemTemplateString:null,listingUrl:null,feedName:null,hideModuleInListOnAction:false,emptyListMessage:"No add-on found.",_dataStore:null,_listItems:null,_standbyWigdet:null,startup:function(){if(this._started){return;}this._standbyWigdet=this._createStandbyWidget();document.body.appendChild(this._standbyWigdet.domNode);this._standbyWigdet.startup();this.inherited(arguments);},_createStandbyWidget:function(){return new dojox.widget.Standby({target:this._modulesListPlaceholder});},destroy:function(){this._standbyWigdet.destroyRecursive(false);this.inherited(arguments);},updateView:function(){this._listModules(true);},onSiteRestartRequired:function(){},onError:function(_9){},onSuccess:function(_a){},onModuleActionPerformed:function(){},_listModules:function(_b){if(this.listingUrl==""){return;}if(!this._dataStore||_b){var _c={feedName:this.feedName};this.antiForgeryData.AddAntiforgeryToken(_c);this._standbyWigdet.show();_1.xhrPost({content:_c,url:this.listingUrl,handleAs:"json",load:_1.hitch(this,function(_d,_e){if(!_d){return;}else{if(_d.errors&&_d.errors.length>0){this._showErrors(_d.errors);}this._dataStore=new _1.store.Memory({data:_d.modules});this._buildModuleList();}}),error:_1.hitch(this,function(_f,_10){var _11=_1.replace(this.res.addonlistreaderror,{error:_f});this._showErrors([_11]);_1.publish("onServerError",[_10]);}),handle:_1.hitch(this,function(_12,_13){this._standbyWigdet.hide();})});}else{this._buildModuleList();}},_buildModuleList:function(){var _14=this._dataStore.query({},{sort:[{attribute:"title",descending:false},{attribute:"versionMajor",descending:true},{attribute:"versionMinor",descending:true},{attribute:"versionBuild",descending:true},{attribute:"versionRevision",descending:true},{attribute:"versionSpecial",descending:false}]});this._renderModules(_14);},_createModuleSummary:function(_15,_16){var li=_1.create("li",{"class":"clearfix"},_16);var div=_1.create("div",{},li);return new _7(_15,div);},_renderModules:function(_17){_1.empty(this._modulesListPlaceholder);this._destroyModuleList();if(_17.length==0){this._showEmptyListMessage();return;}_1.forEach(_17,function(_18,i){var _19={module:_18,antiForgeryData:this.antiForgeryData,itemIndex:i};if(this.listItemTemplateString){_19.templateString=this.listItemTemplateString;}var _1a=this._createModuleSummary(_19,this._modulesListPlaceholder);_1a.startup();this._connectModuleSummaryEvents(_1a);},this);},_connectModuleSummaryEvents:function(_1b){var _1c=this.connect(_1b,"onInstall",function(_1d){this._onModuleAction(_1d);var _1e=_1.replace(this.res.installsuccess,_1d.module);this.onSuccess([_1e]);this._ensureReload();});var _1f=this.connect(_1b,"onUninstall",function(_20){this._onModuleAction(_20);var _21=_1.replace(this.res.uninstallsuccess,_20.module);this.onSuccess([_21]);this._ensureReload();});var _22=this.connect(_1b,"onUpdate",function(_23){this._onModuleAction(_23);var _24=_1.replace(this.res.updatesuccess,_23.module);this.onSuccess([_24]);this._ensureReload();});var _25=this.connect(_1b,"onInstallError",function(_26){this.onModuleActionPerformed();var _27=this._getErrorMessages(this.res.installationerror,_26.module);this._showErrors(_27);});var _28=this.connect(_1b,"onUninstallError",function(_29){this.onModuleActionPerformed();var _2a=this._getErrorMessages(this.res.uninstallationerror,_29.module);this._showErrors(_2a);});var _2b=this.connect(_1b,"onUpdateError",function(_2c){this.onModuleActionPerformed();var _2d=this._getErrorMessages(this.res.updateerror,_2c.module);this._showErrors(_2d);});var _2e={widget:_1b,handlers:[_1c,_1f,_22,_25,_28,_2b]};this._listItems.push(_2e);},_getErrorMessages:function(_2f,_30){var _31=[_1.replace(_2f,_30)];if(_30.errors&&_30.errors.length){_31=_31.concat(_30.errors);}return _31;},_ensureReload:function(){_1.publish("onReloadRequired");},_onModuleAction:function(_32){if(this.hideModuleInListOnAction){this._removeModuleFromList(_32);}this.onSiteRestartRequired();this.updateView();this.onModuleActionPerformed();},_removeModuleFromList:function(_33){var _34=_1.filter(this._listItems,function(_35){return _35.widget==_33;});_1.forEach(_34,function(_36,i){var _37=_36.widget.domNode.parentNode;this._destroyListItem(_36);var _38=_1.indexOf(this._listItems,_36);if(_38>-1){this._listItems.splice(_38,1);}_1.destroy(_37);},this);if(this._listItems.length==0){this._showEmptyListMessage();}},_destroyModuleList:function(){_1.forEach(this._listItems,function(_39,i){this._destroyListItem(_39);},this);this._listItems=[];},_destroyListItem:function(_3a){_1.forEach(_3a.handlers,function(_3b){this.disconnect(_3b);},this);_3a.widget.destroyRecursive(false);},_showErrors:function(_3c){this.onError(_3c);},_showEmptyListMessage:function(){var li=_1.create("li",{},this._modulesListPlaceholder);var div=_1.create("div",{innerHTML:"<span>"+this.emptyListMessage+"</span>"},li);_1.addClass(div,"emptyListMessageContainer");}});});