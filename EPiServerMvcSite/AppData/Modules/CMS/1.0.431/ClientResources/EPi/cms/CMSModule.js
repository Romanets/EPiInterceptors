//>>built
define("epi/cms/CMSModule",["epi","dojo","dojo/_base/declare","epi/_Module","epi/routes","epi/cms/Application","epi/cms/BackContextHistory","epi/cms/ContextSynchronizer","epi/cms/conversion/ContentLightUriConverter","epi/cms/conversion/PropertyDateConverter","epi/cms/core/ContentReference","epi/cms/store/CustomQueryEngine","epi/cms/store/PageVersionQueryEngine","epi/cms/component/command/GlobalToolbarCommandProvider","epi/cms/contentediting/EditorFactory","epi/cms/contentediting/ContentActionSupport","epi/cms/contentediting/ViewSettingsManager","epi/cms/contentediting/command/Editing","epi/cms/contentediting/commandproviders/ContentDetails","epi/cms/contentediting/commandproviders/PublishMenu","epi/cms/contentediting/commandproviders/PublishMenuGlobal","epi/cms/contentediting/viewsettings/ResolutionViewSetting","epi/cms/contentediting/viewsettings/VisitorGroupViewSetting","epi/cms/contentediting/viewsettings/ChannelViewSetting","epi/cms/contentediting/InUseNotificationManager","epi/dependency","epi/shell/store/JsonRest","epi/shell/store/Throttle","./legacy/navigationSupport"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b,_1c,_1d){return _3([_4],{_settings:null,_hashWrapper:null,_firstTimeHashUpdated:false,constructor:function(_1e){this._settings=_1e;},initialize:function(){this.inherited(arguments);this.registerDependency("epi.cms.Application",new _6(this._settings));this.registerDependency("epi.cms.BackContextHistory",new _7());this.registerDependency("epi.cms.ContextSynchronizer",new _8(),undefined,function(_1f){_1f.destroy();});this.registerDependency("epi.cms.contentEditing.command.Editing",_12);this._hashWrapper=_1a.resolve("epi.shell.HashWrapper");var _20=_1a.resolve("epi.globalcommandregistry");var _21=new _15();_20.registerProvider("epi.cms.publishmenu",_21);var _22=this.resolveDependency("epi.shell.ContextService");if(!_22.initialUri){_22.initialUri="epi.cms.contentdata:///"+this._settings.startPage;}_22.registerRoute("epi.cms.contentdata",_2.hitch(this,this._redirectPageDataContext));var _23=this.resolveDependency("epi.shell.ViewComponentDictionary");_2.mixin(_23,{"epi.cms.contentdata":"epi/cms/contentediting/PageDataController","epi.cms.pagedata.wastebasket":"epi/cms/component/Trash","epi.cms.pagedata.root":"epi/cms/contentediting/PageDataController"});this._initializeEditorFactory();this._initializeStores();this._initializeSystemTrash();this._setupConverters(_1a);this._setupViewSettings();_20.registerProvider("epi.cms.globalToolbar",new _e());this._setupInUseNotificationManager(_20);_1d.registerFor(window.top);},_redirectPageDataContext:function(_24,_25,uri){var _26=_1a.resolve("epi.shell.controller.Views");if(_26.viewName=="/episerver/dashboard"){var _27=_1a.resolve("epi.cms.Application");if(_27.isLegacyEditMode()){var url=_5.getActionPath({moduleArea:"LegacyCMS",path:"edit/default.aspx",id:uri.getId()});this._redirect(url);}else{var _28=_5.getActionPath({moduleArea:"CMS",controller:"Home",action:""});_28=_28.substring(0,_28.length-1);var _29=_28+"#"+this._hashWrapper.extractHash(_24,_25);this._redirect(_29);}}else{if(_24.hasSiteChanged){var _2a=_24.fullHomeUrl+"#"+this._hashWrapper.extractHash(_24,_25);this._redirect(_2a);}else{if(_25&&_25.trigger=="internal"&&this._firstTimeHashUpdated){return;}this._firstTimeHashUpdated=true;this._hashWrapper.onContextChange(_24,_25);}}},_redirect:function(url){window.location=url;},_setupConverters:function(_2b){var _2c=this.resolveDependency("epi.objectconverterregistry"),_2d=new _9(),_2e=new _a();_2d.registerConverter(_2c);_2e.registerConverter(_2c);},_setupViewSettings:function(){var _2f=new _11({viewSettings:[new _16(),new _17(),new _18()]});this.registerDependency("epi.viewsettingsmanager",_2f);},_initializeStores:function(){var _30=this.resolveDependency("epi.storeregistry"),_31=_30.create("epi.cms.contentdata",this._getRestPath("contentdata"),{idProperty:"contentLink"}),_32=_30.create("epi.cms.content.light",this._getRestPath("contentstructure"),{idProperty:"contentLink",queryEngine:_c}),_33=_30.create("epi.cms.contentreferences",this._getRestPath("contentreferences"),{idProperty:"ownerContentLink"}),_34=_30.create("epi.cms.contentversion",this._getRestPath("contentversion"),{idProperty:"contentLink",queryEngine:_d});var _35=new _1b(_2.mixin({target:this._getRestPath("contentstructure"),preventCache:true},{idProperty:"contentLink"}));_30.add("epi.cms.content.search",new _1c(_35));_31.addDependentStore(_32,{refreshOnPatch:true,refresh:function(_36){var id=_31.getIdentity(_36);var _37=new _b(id).createVersionUnspecificReference().toString();_32.refresh(_37);}});_31.addDependentStore(_34,{transformDelegate:function(_38){if(_38.capabilities&&!_38.capabilities.supportsVersions){return null;}if(!_38.properties){return null;}var _39={"pageChangedBy":"savedBy","pageSaved":"savedDate","pageLanguageBranch":"language","pageName":"name","name":"name","icontent_name":"name"};var _3a=_2.mixin({},_38);for(var p in _39){if(p in _3a.properties){_3a[_39[p]]=_3a.properties[p];}}return _3a;}});_30.create("epi.cms.contenttype",this._getRestPath("contenttype"));_30.create("epi.cms.category",this._getRestPath("categories"));var _3b=_30.create("epi.cms.inusenotification",this._getRestPath("inusenotification"));_3b.addDependentStore(_31);_30.create("epi.cms.visitorgroup",this._getRestPath("visitorgroup"));_30.create("epi.cms.sitestructure",this._getRestPath("sitestructure"),{idProperty:"url"});_30.create("epi.cms.displaychannels",this._getRestPath("channel"));_30.create("epi.cms.wastebasket",this._getRestPath("wastebasket"));_30.create("epi.cms.xform",this._getRestPath("xform"));},_getRestPath:function(_3c){return _5.getRestPath({moduleArea:"cms",storeName:_3c});},_initializeEditorFactory:function(){this.registerDependency("epi.cms.contentediting.EditorFactory",function(){var _3d=new _f();_3d.registerEditorWrapper("inline","epi.cms.contentediting.InlineEditorWrapper",function(_3e,_3f){});_3d.registerEditorWrapper("flyout","epi.cms.contentediting.FlyoutEditorWrapper",function(_40,_41){});_3d.registerEditorWrapper("floating","epi.cms.contentediting.FloatingEditorWrapper",function(_42,_43){});_3d.registerEditorWrapper("dialog","epi.cms.contentediting.DialogEditorWrapper",function(_44,_45){_44.closeOnChange=false;_44.showButtons=true;});_3d.registerEditorWrapper("legacyProperty","epi.cms.contentediting.DialogEditorWrapper",function(_46,_47){_46.closeOnChange=true;_46.showButtons=false;});return _3d;});},_initializeSystemTrash:function(){var app=_1a.resolve("epi.cms.Application");var _48=app.getGlobalBlockFolder(),_49=app.getSiteBlockFolder();this.registerDependency("epi.cms.contentediting.systemtrash",{pages:{typeIdentifiers:["epi.cms.page"],contentSearchAreas:["CMS/Pages"],restoreRoot:app.getRootPage()},blocks:{typeIdentifiers:["epi.cms.folder","epi.cms.block"],contentSearchAreas:["CMS/Blocks"],restoreRoot:_48!==_49?[_48,_49]:_48}});},_setupInUseNotificationManager:function(_4a){var _4b=new _19();this.registerDependency("epi.cms.contentediting.inUseNotificationManager",_4b);_4a.registerProvider("epi.cms.publishmenu",new _14());_4a.registerProvider("epi.cms.contentdetailsmenu",new _13());}});});