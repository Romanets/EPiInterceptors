//>>built
define("epi/cms/widget/BlockList",["dojo/_base/declare","dojo/dom-construct","dojo/_base/lang","dojo/_base/array","dojo/_base/Deferred","dojo/_base/connect","dojo/dnd/Source","dojo/dom-style","dojo/store/Memory","dojo/dom-class","dojo/query","dojo/aspect","dojo/Stateful","dojox/html/entities","dijit/_Widget","dijit/layout/_LayoutWidget","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dgrid/OnDemandGrid","dgrid/Selection","dgrid/Keyboard","epi","epi/dependency","epi/shell/command/_WidgetCommandProviderMixin","epi/shell/command/withConfirmation","epi/shell/selection","epi/shell/dgrid/Formatter","epi/shell/_StatefulGetterSetterMixin","epi/cms/command/CopyContent","epi/cms/command/CutContent","epi/cms/command/DeleteContent","epi/cms/component/command/ChangeContext","epi/cms/contentediting/ContentActionSupport","epi/cms/widget/BlockListViewModel","epi/cms/widget/ContextMenu","epi/cms/widget/sharedContentDialogHandler","epi/cms/dgrid/DnD","epi/i18n!epi/cms/nls/episerver.cms.components.sharedblockscomponent"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,epi,_16,_17,_18,_19,_1a,_1b,_1c,_1d,_1e,_1f,_20,_21,_22,_23,DnD,res){return _1("epi.cms.widget.BlockList",[_f,_17,_d,_1b],{clipboardManager:null,_source:null,selectedFolder:null,currentContext:null,contentActionSupport:null,_res:res,dndTypes:["epi.cms.blockreference","epi.cms.contentreference"],_mouseOverClass:"epi-dgrid-mouseover",_contentTypeStore:null,store:null,constructor:function(){this.selection=new _19();},postMixInProperties:function(){this.inherited(arguments);var _24=_16.resolve("epi.storeregistry");this._contentTypeStore=_24.get("epi.cms.contenttype");var _25=function(){return _24.get("epi.cms.content.light");};this.store=this.store||_25();this.contentActionSupport=this.contentActionSupport||_20;},buildRendering:function(){this.inherited(arguments);var _26=this;var _27=_1([_13,_14,_15,DnD,_1a]);this.grid=new _27({columns:{icon:{renderCell:function(_28,_29,_2a,_2b){_2a.innerHTML="<span class='dijitInline dijitIcon epi-iconObjectSharedBlock'></span>";}},name:{renderCell:function(_2c,_2d,_2e,_2f){_2d=_e.encode(_2d);_5.when(_26._contentTypeStore.get(_2c.contentTypeID),function(_30){var _31=_2d+" ("+_30.localizedName+")";var _32="<div class=\"dojoxEllipsis\" title=\"{0}\">{1}</div>";_2e.innerHTML=_3.replace(_32,[_31,_2d]);});}},"contextmenu":{renderCell:function(_33,_34,_35,_36){var _37="<div class='epi-blockListEditAction' title='{0}'>                                            <span class='dijitInline dijitIcon epi-iconContextMenu' title ='{1}'>&nbsp;</span><div>";_35.innerHTML=_3.replace(_37,[epi.resources.action.edit,res.blockmenu]);}}},noDataMessage:this._getNoDataMessage(),selectionMode:"single",deselectOnRefresh:false,dndSourceType:_26.dndTypes,dndParams:{creator:_26._blockNodeCreator,copyOnly:true,selfAccept:false,accept:[]}},this.domNode);this.grid.set("showHeader",false);},postCreate:function(){this.inherited(arguments);var _38=this;this.watch("selectedFolder",_3.hitch(this,function(){this.model.contentData=this.selectedFolder;this.grid.set("noDataMessage",this._getNoDataMessage());_5.when(this._bindingData(),_3.hitch(this,function(){this._updateCuttingRowUI();}));}));this.contextMenu=new _22();this.contextMenu.addProvider(this);this.grid.on(".epi-createBlock:click",function(){_38.createCommand.execute();});this.grid.on(".dgrid-row:click",function(_39){var row=_38.grid.row(_39);_38.onSelectionChange(row.data);});this.grid.on(".dgrid-row:dblclick",_3.hitch(this,function(_3a){if(this._editCommand.canExecute){this._editCommand.execute();}}));this.grid.on(".dgrid-row:mouseover",function(_3b){_a.add(this,_38._mouseOverClass);});this.grid.on(".dgrid-row:mouseout",function(_3c){_a.remove(this,_38._mouseOverClass);});this.grid.on(".epi-iconContextMenu:click",function(evt){_38.contextMenu.scheduleOpen(this,null,{x:evt.pageX,y:evt.pageY});});this.connect(this.store,"onItemChanged","_onItemChanged");this.connect(this.getParent(),"onFocus","_onParentFocused");},startup:function(){if(this._started){return;}this.inherited(arguments);this.model=new _21({store:this.store});_6.connect(this.model,"onDelete",this,this._onDeleted);this._setupCommands();},destroy:function(){if(this.grid){this.grid.destroy();this.grid=null;}if(this.contextMenu){this.contextMenu.destroyRecursive();this.contextMenu=null;}this.inherited(arguments);},_onParentFocused:function(){this._selectActiveBlock();},_bindingData:function(){var _3d=this,_3e=new _5();if(_3d.model){_5.when(_3d.model.fetchData(),function(_3f){var _40=new _9({data:_3f,idProperty:"contentLink"});_3d.grid.set("store",_40);_3e.resolve();});}return _3e;},_setupCommands:function(){var _41={category:"context",model:this.model,selection:this.selection,clipboard:this.clipboardManager};this._editCommand=new _1f({category:"context",forceContextChange:true});this.set("commands",[this._editCommand,new _1d(_41),new _1c(_41),_18(new _1e(_41),_23,{selection:this.selection})]);},_blockNodeCreator:function(_42,_43){node=_2.create("div").appendChild(document.createTextNode(_42.name));return {"node":node,"type":_3.clone(this.dndTypes),"data":_42};},_selectActiveBlock:function(){this.grid.clearSelection();var _44=this._selectedBlockContentLink?this._selectedBlockContentLink:(this.currentContext?this.currentContext.id:null);if(_44){var row=this._getRow(_44);if(row){this.grid.select(row);if(row.data){this.onSelectionChange(row.data);}return;}}},restore:function(){this.resize();},onSelectionChange:function(_45){var _46=_45?[{type:"epi.cms.contentdata",data:_45}]:[];if(_45){this._selectedBlockContentLink=_45.contentLink;}this._editCommand.set("model",_45);this.selection.set("data",_46);},_onPaste:function(){},_onDeleted:function(_47){var _48=this.clipboardManager.getDataObject(),_49=_48?_48[0]:null;if(_49&&_49.data.contentLink===_47.contentLink){this.clipboardManager.clear();}_5.when(this._bindingData(),_3.hitch(this,function(){this.onSelectionChange();}));},_onItemChanged:function(id,_4a){_5.when(this._bindingData(),_3.hitch(this,function(){this._updateCuttingRowUI();}));},highlightItem:function(_4b){if(_4b){this._selectedBlockContentLink=_4b;this._selectActiveBlock();}},showCommands:function(){this._setCommandVisbility(true);},hideCommands:function(){this._setCommandVisbility(false);},_setCommandVisbility:function(_4c){_4.forEach(this.commands,function(_4d){_4d.set("isAvailable",_4c);});},_getRow:function(_4e){return this.grid.row(_4e.match("^[0-9]*")[0]);},toggleCuttingRowUI:function(_4f,_50){if(_4f!=null){var row=this._getRow(_4f.contentLink);if(row&&row.element){_a.toggle(row.element,"epi-opacity50",_50);}}},_updateCuttingRowUI:function(){if(!this.clipboardManager.isCopy()){var _51=this.clipboardManager.getDataObject(),_52=_51!=null?_51[0].data:null;this.toggleCuttingRowUI(_52,true);}},_setCreateCommandAttr:function(_53){this._set("createCommand",_53);if(this.commandHandle){this.commandHandle.unwatch();}this.commandHandle=_53.watch("canExecute",_3.hitch(this,function(){this.grid.set("noDataMessage",this._getNoDataMessage());}));},_getNoDataMessage:function(){var _54="";if(this.createCommand&&this.createCommand.canExecute){_54="<span class=\"epi-createBlock\">                        <span class=\"dijitReset dijitInline dijitIcon epi-iconPlus\"></span>                        <span class=\"dijitReset dijitInline\">"+res.linktocreateblock+"</span>                    </span>";}return _54;}});});