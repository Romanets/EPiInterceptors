//>>built
define("epi/cms/widget/viewmodel/TrashViewModel",["dojo/_base/array","dojo/_base/declare","dojo/_base/Deferred","dojo/_base/lang","dojo/topic","dojo/Stateful","epi/shell/_StatefulGetterSetterMixin","epi/dependency","epi/i18n!epi/cms/nls/episerver.cms.components.trash"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){return _2([_6,_7],{resources:null,trashes:null,currentFeeder:null,queryOptions:null,isEmptyTrash:false,storeRegistry:null,contentStore:null,trashStore:null,showAllLanguages:true,postscript:function(){this.inherited(arguments);this.resources=this.resources||_9;this.storeRegistry=_8.resolve("epi.storeregistry");this.contentStore=this.contentStore||this._getStore();this.trashStore=this.trashStore||this.storeRegistry.get("epi.cms.wastebasket");if(!this.trashes){this._createTrashes();}},_getStore:function(){var _a=this.storeRegistry.get("epi.cms.content.light"),_b=this;var _c=_4.delegate(_a,{getChildren:function(_d,_e){var _f=_b.get("currentFeeder"),_10=_b._createQueryOptions(_f);_4.mixin(_10.query,{referenceId:_d.contentLink});return this.query(_10.query,_10.options);},mayHaveChildren:function(_11){return _11.hasChildren;}});return _c;},_createFeederFromTrash:function(_12){var _13=_8.resolve("epi.cms.contentediting.systemtrash");if(_12.isDefaultProvider&&_13){var _14=[],_15,_16;for(_15 in _13){_16=_13[_15];_14=_14.concat([_4.mixin(_4.clone(_12),_4.clone(_16),{name:this.resources[_15],isRequireLoad:true})]);}return _14;}else{return [_4.mixin(_4.clone(_12),{contentSearchAreas:["CMS/Pages","CMS/Blocks"],isRequireLoad:true})];}},_createTrashes:function(){_3.when(this.trashStore.query(),_4.hitch(this,function(_17){var _18=_4.clone(_17);_1.forEach(_18,function(_19){_19.feeders=this._createFeederFromTrash(_19);if(_19.isDefaultProvider){_19.name=this.resources.defaulttrash;}},this);this.set("trashes",_18);}));},_setCurrentFeederAttr:function(_1a){this._set("currentFeeder",_1a);if(_1a.isRequireLoad){this.updateFeeder(_1a);_1a.isRequireLoad=false;}},updateFeeder:function(_1b){if(_1b&&_1b.active){this.set("queryOptions",this._createQueryOptions(_1b));}else{this.set("queryOptions",null);}},_createQueryOptions:function(_1c){var _1d={referenceId:_1c.wasteBasketLink,query:"getchildren"};var _1e={ignore:["query"]};if(this.showAllLanguages){_4.mixin(_1d,{allLanguages:this.showAllLanguages});_1e.ignore.push("allLanguages");}if(_1c.typeIdentifiers){_4.mixin(_1d,{typeIdentifiers:_1c.typeIdentifiers});_4.mixin(_1e,{comparers:this._createComparer()});}if(_1c.deletedBy){_4.mixin(_1d,{deletedBy:_1c.deletedBy});}if(_1c.isSearchable){_4.mixin(_1d,{isSearchable:_1c.isSearchable});_1e.ignore.push("isSearchable");}if(_1c.contentSearchAreas){_4.mixin(_1d,{contentSearchAreas:_1c.contentSearchAreas});_1e.ignore.push("contentSearchAreas");}if(_1c.queryText){_4.mixin(_1d,{query:"searchcontent"});_4.mixin(_1d,{matchProvider:true});_4.mixin(_1d,{queryText:_1c.queryText});}return {query:_1d,options:_1e};},_createComparer:function(){var _1f={};_1f["typeIdentifiers"]=function(_20,_21){return _1.some(_20,function(_22){return _22===_21.typeIdentifier;});};_1f["queryText"]=function(_23,_24){return _24.name.toLowerCase().indexOf(_23.toLowerCase())!=-1;};_1f["referenceId"]=function(_25,_26){return _25===_26.parentLink;};return _1f;},emptyTrash:function(_27){if(_27){_3.when(this.trashStore.executeMethod("Empty",_27),_4.hitch(this,function(_28){var _29=_1.filter(this.get("trashes"),function(_2a){return _2a&&_2a.wasteBasketLink===_27;});_1.forEach(_29,function(_2b){_2b.deletedByUsers=[];_1.forEach(_2b.feeders,function(_2c){_2c.isRequireLoad=true;_2c.deletedByUsers=[];});});if(_28.isSuccess){this.isEmptyTrash=true;}if(this.currentFeeder.wasteBasketLink===_27){this.set("currentFeeder",this.currentFeeder);}this.set("actionResponse",{message:_9.emptytrash.accessdenied,isSuccess:_28?_28.isSuccess:false});}));}},restore:function(_2d,_2e){if(_2d&&_2d.contentLink&&_2d.isDeleted&&_2e){_3.when(this.contentStore.move(_2d.contentLink,{targetId:_2e}),_4.hitch(this,function(_2f){if(_2f){this.contentStore.refresh(_2d.contentLink);this.contentStore.refresh(_2d.parentLink).then(_4.hitch(this,function(){this.updateFeeder(this.get("currentFeeder"));}));var _30=this.contentStore.get(_2e);if(_30&&!_30.hasChildren){this.contentStore.refresh(_2e).then(function(_31){_5.publish("/epi/cms/contentdata/restored",_31);});}}this.set("actionResponse",{message:_2f.message?_2f.message:_9.restore.error,isSuccess:_2f?_2f.isSuccess:false});}));}},getOldParent:function(_32){var df=new _3();_3.when(this.contentStore.query({referenceId:_32,query:"getrestorepoint",allLanguages:true}),function(_33){var _34=_33&&_4.isArray(_33)&&_33.length>0?_33[0]:null;df.resolve(_34);});return df;}});});