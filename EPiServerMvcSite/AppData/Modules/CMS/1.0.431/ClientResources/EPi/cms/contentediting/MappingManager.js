//>>built
define("epi/cms/contentediting/MappingManager",["dojo","dojo/_base/lang","dojo/_base/array","dojo/_base/json","dojo/_base/connect","dojo/dom-attr","dojox/encoding/digests/SHA1"],function(_1,_2,_3,_4,_5,_6,_7){return _1.declare("epi.cms.contentediting.MappingManager",[],{BODY_NODE_HASH:"#BODY#",_mappings:null,domUtils:null,attrNames:["data-epi-property-name","data-epi-property-display-names","data-epi-property-customsettings-customtag","data-epi-use-mvc","data-epi-disabled","data-epi-useoverlay","data-epi-overlay-z-index","data-epi-property-type","data-epi-property-edittype","data-epi-property-editorsetting","data-epi-property-editor","data-epi-property-render"],constructor:function(){this._mappings=[];this.domUtils=_6;},clear:function(){var _8=this._mappings;this._mappings=[];_3.forEach(_8,function(_9){_3.forEach(["updateController","wrapper","overlayItem"],function(_a){if(_9[_a]){if(_2.isFunction(_9[_a].destroyRecursive)){_9[_a].destroyRecursive();}else{_9[_a].destroy();}}});for(var _b in _9){delete _9[_b];}},this);},_calculateNodeHash:function(_c){if(_c.tagName==="BODY"){return this.BODY_NODE_HASH;}var _d=_1.map(this.attrNames,_1.hitch(this,function(n){return this.domUtils.get(_c,n)||"";}));return _7(_4.toJson(_d));},update:function(_e,_f){_2.mixin(_e,_f);if(_f.node){_e.nodeHash=this._calculateNodeHash(_f.node);}},add:function(_10){if(_10.node){_10.nodeHash=this._calculateNodeHash(_10.node);}if(_10.blockPropertyInfo&&!_10.propertyName){_10.propertyName=_10.blockPropertyInfo.name;}this._mappings.push(_10);},_tryRemapNode:function(_11,_12,_13){if(_11.nodeHash===this.BODY_NODE_HASH){_11.node=_13;_11.updateController.displayNode=_13;return {success:true};}if(this._calculateNodeHash(_12.node)===_11.nodeHash){_11.node=_12.node;_11.updateController.displayNode=_12.node;_11.updateController.checkEmptyHtml();if(_11.overlayItem){_11.overlayItem.set("disabled",false);_11.overlayItem.set("sourceItemNode",_12.node);_11.overlayItem.refresh();}return {success:true,mappedNode:_12};}return {success:false};},remap:function(_14,_15){var _16=[];_3.forEach(_14,function(_17){_16.push(_17);});_3.forEach(this._mappings,_1.hitch(this,function(_18){if(!_18.updateController){return;}var _19=null;var _1a=_3.some(_16,_1.hitch(this,function(_1b){var _1c=this._tryRemapNode(_18,_1b,_15);_19=_19||_1c.mappedNode;return _1c.success;}));if(_1a){if(_19){_16.splice(_3.indexOf(_16,_19),1);}}else{_18.updateController.destroy();delete _18.updateController;if(_18.overlayItem){_18.overlayItem.destroyRecursive();delete _18.overlayItem;}delete _18.node;delete _18.nodeHash;}}));return _16;},findOne:function(_1d,_1e){var _1f;_3.some(this._mappings,function(m){if(m[_1d]===_1e){_1f=m;return true;}});return _1f;},find:function(){var _20;if(arguments[0]===undefined){return this._mappings;}else{if(_2.isFunction(arguments[0])){_20=arguments[0];}else{var _21=arguments[0],_22=arguments[1];_20=function(m){return m[_21]===_22;};}}return _3.filter(this._mappings,_20);}});});