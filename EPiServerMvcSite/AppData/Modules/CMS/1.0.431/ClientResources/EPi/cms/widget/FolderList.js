//>>built
define("epi/cms/widget/FolderList",["dojo","dojo/dom-class","dojo/_base/array","dijit/_Widget","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","epi/dependency","epi/cms/command/CopyContent","epi/cms/command/CutContent","epi/cms/command/DeleteContent","epi/cms/command/NewContent","epi/cms/command/PasteContent","epi/cms/component/ContentFilter","epi/cms/widget/command/NewFolder","epi/cms/widget/command/RenameFolder","epi/cms/widget/ContextMenu","epi/cms/widget/FolderTree","epi/cms/widget/FolderTreeStoreModel","epi/shell/command/_WidgetCommandProviderMixin","epi/shell/selection","epi/i18n!epi/cms/nls/episerver.cms.components.createblock"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15){return _1.declare("epi.cms.widget.FolderList",[_4,_5,_6,_13],{_application:null,_renamingNode:null,_store:null,isTreeLoaded:null,deferredSelectedItem:null,templateString:"<div>                              <div data-dojo-attach-point=\"treeNode\" id=\"${id}_treeNode\"></div>                         </div>",postMixInProperties:function(){this.inherited(arguments);this._application=_7.resolve("epi.cms.Application");this.siteBlockFolder=this._application.getSiteBlockFolder();this.globalBlockFolder=this._application.getGlobalBlockFolder();this.selection=new _14();},postCreate:function(){this.inherited(arguments);var _16=_7.resolve("epi.storeregistry");this._store=_16.get("epi.cms.content.light");this._bindingTree();this.connect(this._tree,"onResize",_1.hitch(this,this._onResize));this.connect(this._tree,"onLoad","_onTreeLoaded");this.connect(this._tree,"onFolderSelected","_onTreeNodeSelected");this.connect(this._tree,"_onCopyOrCut","_executeCopyOrCut");this.connect(this._tree,"_onPaste","_executePaste");this.connect(this._tree,"_onDelete","_executeDelete");},_onResize:function(){this.onResize();},onResize:function(){},startup:function(){if(this._started){return;}this.inherited(arguments);var _17=this._tree.model,_18={category:"context",model:_17,selection:this.selection,clipboard:this._tree.clipboardManager};this.connect(_17,"onAdd","_onAdded");this.connect(_17,"onDelete","_onDeleted");this._newBlockCommand=new _b({category:"context",contentType:_d.BlockType,iconClass:"epi-iconSharedBlock",label:_15.command.label,resources:_15,showForRoot:true});this._newFolderCommand=new _e({category:"context",model:_17,selection:this.selection,showForRoot:true});this._renameCommand=new _f({category:"context"});this._copyCommand=new _8(_18);this._cutCommand=new _9(_18);this._pasteCommand=new _c(_1.mixin({showForRoot:true},_18));this._deleteCommand=new _a(_18);this.set("commands",[this._newFolderCommand,this._newBlockCommand,this._cutCommand,this._copyCommand,this._pasteCommand,this._renameCommand,this._deleteCommand]);},_bindingTree:function(){var _19=new _10();_19.addProvider(this);this._tree=new _11({model:new _12({store:this._store,additionalQueryOptions:{sort:[{attribute:"name",descending:false}]}}),contextMenu:_19,showRoot:false},this.treeNode);},onFolderChanged:function(_1a){var _1b=_1a?[{type:"epi.cms.contentdata",data:_1a.item}]:[];this._renameCommand.set("model",_1a);this._newBlockCommand.set("model",_1a.item);this.selection.set("data",_1b);},_onTreeLoaded:function(){this.isTreeLoaded=true;this._selectFolderNode();},_selectFolderNode:function(_1c){if(!this.isTreeLoaded){this.deferredSelectedItem=_1c;return;}var _1d=_1c?_1c:this.deferredSelectedItem?this.deferredSelectedItem:this.siteBlockFolder.toString();this._tree.selectContent(_1d,true);},_onTreeNodeSelected:function(_1e){if(_1e&&_1e.item){this.onFolderChanged(_1e);if(this._renamingNode&&this._renamingNode===_1e.item.contentLink){this._renameCommand.execute();this._renamingNode=null;}}},_onAdded:function(_1f){if(_1f){var _20=this.selection,_21=_20.data&&_20.data[0];_1f=_1f.replace(new RegExp("_.*"),"");this._renamingNode=_1f;_1.publish("/epi/cms/blocktree/childrenchanged",[_21.data,_1f]);}},_onDeleted:function(_22){this._selectFolderNode(_22.parentLink);},_executeDelete:function(){this._deleteCommand.execute();},_executeCopyOrCut:function(_23){if(_23){this._copyCommand.execute();}else{this._cutCommand.execute();}},_executePaste:function(){this._pasteCommand.execute();},highlightNode:function(_24){var _25=new _1.Deferred();if(!_24){_25.resolve();}_1.when(_24,_1.hitch(this,function(id){if(!id){var _26=this._tree.get("SelectedNode");if(_26){this._tree.selectContent(_26.item.contentLink,true);}}else{this._selectFolderNode(id);}_25.resolve();}));return _25;},showCommands:function(_27){_3.forEach(this.commands,function(_28){_28.set("isAvailable",!_27||_28.showForRoot);});},hideCommands:function(){_3.forEach(this.commands,function(_29){_29.set("isAvailable",false);});},toggleCuttingNodeUI:function(_2a,_2b){var _2c=this._tree.getNodesByItem(_2a)[0];if(_2c){_2.toggle(_2c.rowNode,"epi-opacity50",_2b);}}});});