//>>built
require({cache:{"url:epi/cms/component/templates/CreateContent.html":"<div class=\"epi-createContent\">\r\n    <div class=\"epi-listingTopContainer\" data-dojo-attach-point=\"selectTypeNode\">\r\n        <h1 data-dojo-attach-point=\"titleNode\"></h1>\r\n        <div class=\"epi-breadCrumb\" data-dojo-attach-point=\"breadcrumbNode\" data-dojo-type=\"epi.cms.widget.Breadcrumb\" data-dojo-props=\"showLastBracket:true\"></div>\r\n        <label data-dojo-attach-point=\"contentNameLabelNode\"></label>\r\n        <input type=\"text\" size=\"40\" data-dojo-attach-point=\"contentNameNode\" data-dojo-type=\"dijit.form.TextBox\" />\r\n        <div class=\"epi-cancelLink\">\r\n            <button data-dojo-type=\"dijit.form.Button\" data-dojo-attach-point=\"cancelButton\" data-dojo-attach-event=\"onClick: _onCancelClick\">${resources.cancel}</button>\r\n        </div>\r\n    </div>\r\n    <div class=\"epi-listingTopContainer\" data-dojo-attach-point=\"requiredPropertiesNode\" style=\"display:none\">\r\n        <h1 data-dojo-attach-point=\"selectedTypeTitle\"></h1>\r\n        <div data-dojo-attach-point=\"breadcrumbRequiredNode\" data-dojo-type=\"epi.cms.widget.Breadcrumb\"></div>\r\n        <span class=\"epi-contentName\" data-dojo-attach-point=\"contentName\"></span>\r\n    </div>\r\n    <div data-dojo-attach-point=\"stackContainer\">\r\n        <h4 data-dojo-attach-point=\"requiredPropTitleNode\" class=\"epi-formsDescriptionHeader\"></h4>\r\n    </div>\r\n</div>"}});define("epi/cms/component/CreateContent",["dojo/_base/array","dojo/_base/declare","dojo/_base/Deferred","dojo/_base/lang","dojo/_base/window","dojo/dom-attr","dojo/dom-geometry","dojo/dom-style","dojo/dom-class","dojo/dom-construct","dojo/topic","dijit/_Widget","dijit/layout/StackContainer","dijit/form/Button","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","epi","epi/cms/_ContentContextMixin","epi/cms/widget/ContentTypeList","epi/dependency","epi/shell/widget/dialog/Alert","epi/string","epi/shell/widget/FormContainer","epi/cms/component/ContentFilter","epi/cms/contentediting/ContentModelServerSync","epi/cms/widget/Breadcrumb","epi/cms/contentediting/NewContentNameInputDialog","epi/shell/widget/dialog/Dialog","epi/cms/core/ContentReference","dojo/text!./templates/CreateContent.html","epi/i18n!epi/cms/nls/shell.common.buttons","epi/i18n!epi/cms/nls/episerver.cms.components.requiredproperties"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,epi,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b,_1c,_1d,_1e,_1f){return _2("epi.cms.component.CreateContent",[_c,_f,_10,_11],{resources:_1e,contentTypeList:null,templateString:_1d,container:null,selectedContentType:null,contentDataStore:null,parentContent:null,metadataManager:null,defaultContainerWidget:"epi.cms.widget.CreateContentFormLayout",res:null,requestedTypes:[],type:null,skipContentTypeSelection:false,requiredPropertiesTitleNode:null,saveButton:null,postMixInProperties:function(){this.inherited(arguments);var _20=_13.resolve("epi.storeregistry");if(!this.contentDataStore){this.contentDataStore=_20.get("epi.cms.contentdata");}if(!this.contentVersionStore){this.contentVersionStore=_20.get("epi.cms.contentversion");}if(!this.metadataManager){this.metadataManager=_13.resolve("epi.shell.MetadataManager");}},postCreate:function(){this.container=new _d({"class":"epi-newContentContainer"},this.stackContainer);if(!this.skipContentTypeSelection){var _21=new _12({onContentTypeSelected:_4.hitch(this,this._onContentTypeSelected),requestedTypes:this.requestedTypes,type:this.type});this.contentTypeList=_21;this.container.selectedChildWidget=_21;this.container.addChild(_21);}_6.set(this.requiredPropTitleNode,"innerHTML",_1f.title);},destroy:function(){if(this.container){this.container.destroyRecursive();delete this.container;}this.inherited(arguments);},resize:function(_22){if(_22){_7.setMarginBox(this.domNode,_22);}},_setContentNameTextBoxDefaultName:function(){this.contentNameNode.set("value",this.res.defaultname);this.contentNameNode.focus();this.contentNameNode.focusNode.select();},updateView:function(_23){this.addToDestination=null;for(var key in _23){this.set(key,_23[key]);}this._setContentNameTextBoxDefaultName();if(this._formContainer){this.container.removeChild(this._formContainer);this._formContainer.destroyRecursive();this._formContainer=null;this.container.selectChild(this.contentTypeList);this._changeTitle();}if(this.saveButton){_8.set(this.saveButton.domNode,"display","none");this.saveButton.set("disabled",true);}_8.set(this.requiredPropTitleNode,"display","none");_9.remove(this.stackContainer,"epi-containerLayout");_9.add(this.stackContainer,"epi-newContentContainer");},getContentName:function(){var _24=this.contentNameNode.get("value");return _4.trim(_24);},_setRequestedTypesAttr:function(_25){this.requestedTypes=_25;if(this.contentTypeList){this.contentTypeList.set("requestedTypes",_25);}},_setTypeAttr:function(_26){this.type=_26;if(this.contentTypeList){this.contentTypeList.set("type",_26);}},_setResAttr:function(_27){this.res=_27;this._setupWidgetTemplate();},_setupWidgetTemplate:function(){_6.set(this.titleNode,"innerHTML",this.res.title);_6.set(this.contentNameLabelNode,"innerHTML",epi.resources.header.name);if(this.saveButton){this.saveButton.set("label",epi.resources.action.done);}},_setParentAttr:function(_28){if(this.contentTypeList){this.contentTypeList.set("parent",_28);}this.breadcrumbNode.set("contentLink",_28.contentLink);this.breadcrumbRequiredNode.set("content",_28);this.parentContent=_28;},_onContentTypeSelected:function(_29){var _2a=function(_2b,_2c,_2d){_2d._tryCreateContent(_2b,_2c);_2d.contentTypeList.clear();};this.selectedContentType=_29;var _2e=this.getContentName();if(_2e.length>0){if(_2e==this.res.defaultname){var _2f=new _1a({defaultContentName:this.res.defaultname});var _30=new _1b({defaultActionsVisible:false,content:_2f,title:_2f.title});dojo.connect(_30,"onExecute",_4.hitch(this,function(){var _31=_2f.get("value");this.contentNameNode.set("value",_31);_2a(_31,_29,this);}));_30.show();}else{_2a(_2e,_29,this);}}else{this._showNotificationMessage(this.res.emptynameerror);}},_onButtonSaveClick:function(_32){this.saveButton.set("disabled",true);if(this._formContainer.validate()){_32.properties=this._formContainer.get("value");this._saveContentChanges(_32);}else{this.saveButton.set("disabled",false);}},_onCancelClick:function(){_3.when(this.getCurrentContent(),_4.hitch(this,function(_33){this._redirectToViewMode(_33.contentLink);}));},_tryCreateContent:function(_34,_35){var _36={name:_34,parentLink:this.parentContent.contentLink,contentTypeId:_35.id};_3.when(this._getNewContentMetadata(_36.parentLink,_36.contentTypeId),_4.hitch(this,function(_37){var _38=_1.filter(_37.properties,_4.hitch(this,function(_39){return this._filterMandatoryProperties(_37,_39);}));if(_38.length<=0){this._saveContentChanges(_36);}else{_36.resourceFolderId=_37.additionalValues.resourceFolderId;this._editMandatoryProperties(_37,_36);}}));},_redirectToViewMode:function(_3a){_b.publish("/epi/shell/context/request",{uri:"epi.cms.contentdata:///"+_3a},{sender:this});},_saveContentChanges:function(_3b){var _3c=function(_3d){this.contentDataStore.refresh(_3d);var _3e=new _1c(_3d);if(this.addToDestination){this.addToDestination.save({contentLink:_3e.createVersionUnspecificReference().toString(),name:_3b.name});_b.publish("/epi/shell/action/changeview","epi/cms/contentediting/PageDataController",null);}else{this._redirectToViewMode(_3e.createVersionUnspecificReference());}};var _3f=function(_40){if(this.saveButton){this.saveButton.set("disabled",false);}};_3.when(this.contentDataStore.put(_3b),_4.hitch(this,_3c),_4.hitch(this,_3f));},_changeTitle:function(){if(this.container.selectedChildWidget&&this.container.selectedChildWidget.declaredClass=="epi.cms.widget.ContentTypeList"){_8.set(this.selectTypeNode,"display","block");_8.set(this.requiredPropertiesNode,"display","none");}else{_8.set(this.selectTypeNode,"display","none");_8.set(this.requiredPropertiesNode,"display","block");}},_editMandatoryProperties:function(_41,_42){_41.layoutType=this.defaultContainerWidget;this._formContainer=this._setupForm(_41);this._formContainer.startup();this.container.addChild(this._formContainer);this.container.forward();this._changeTitle();this.contentName.innerHTML="";this.contentName.appendChild(_5.doc.createTextNode(this.getContentName()));this.selectedTypeTitle.innerHTML=this.res.contenttypetitle.replace("{0}",this.selectedContentType.localizedName);if(!this.saveButton){this.saveButton=new _e({label:epi.resources.action.done});}_8.set(this.saveButton.domNode,"display","");this.saveButton.onClick=_4.hitch(this,"_onButtonSaveClick",_42);this.saveButton.set("disabled",false);this.saveButton.placeAt(this.container,"last");_9.add(this.stackContainer,"epi-containerLayout");_9.remove(this.stackContainer,"epi-newContentContainer");_8.set(this.requiredPropTitleNode,"display","");},_filterMandatoryProperties:function(_43,_44){var _45=_1.filter(_43.groups,function(_46){return _46.displayui===false;});var _47=function(_48){if(_48.name=="PageName"||_48.name=="icontent_name"||!_48.showForEdit){return false;}var _49=_1.some(_45,function(_4a){return (_4a.title===_48.groupName);});return !_49;};var _4b=function(obj){return (_4.isObject(obj)&&obj.properties.length>0?true:false);};var _4c=this;var _4d=function(_4e){var _4f=false;_1.forEach(_4e,function(_50){if(_4b(_50)){_4f=_4d(_50.properties);}else{if(_4c._isPropertyRequired(_50)){if(_47(_50)&&!_50.additionalValues.hasValue){_4f=true;}}}});return _4f;};if(_4b(_44)){if(_4d(_44.properties)){return true;}}else{if(_4c._isPropertyRequired(_44)){if(_47(_44)&&!_44.additionalValues.hasValue){return true;}}}return false;},_isPropertyRequired:function(_51){return _51.settings&&_51.settings.required;},_setupForm:function(_52){var _53=_4.hitch(this,function(_54,_55){});var _56=_4.hitch(this,function(_57){});return new _16({metadata:_52,propertyFilter:_4.hitch(this,this._filterMandatoryProperties),onFieldCreated:_53,onFormCreated:_56});},_getNewContentMetadata:function(_58,_59){return this.metadataManager.getMetadataForType("EPiServer.Core.ContentData",{parentLink:_58,contentTypeId:_59});},_showNotificationMessage:function(_5a){var _5b=new _14({description:_15.toHTML(_5a)});_5b.show();}});});