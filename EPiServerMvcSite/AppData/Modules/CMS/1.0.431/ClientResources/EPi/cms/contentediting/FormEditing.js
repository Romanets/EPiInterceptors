//>>built
define("epi/cms/contentediting/FormEditing",["dojo","dojo/_base/Deferred","dojo/i18n","dijit","dijit/_Contained","dijit/_Container","dijit/layout/BorderContainer","dijit/layout/TabContainer","epi","epi/cms/contentediting/EditingBase","epi/cms/contentediting/SideBySideEditorWrapper","epi/shell/widget/FormContainer"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c){return _1.declare("epi.cms.contentediting.FormEditing",[_a],{_formWidgets:null,_formEditorWrappers:null,_formContainer:null,_formPane:null,_formPaneRegion:null,_formPaneWidth:null,_watchHandles:null,postMixInProperties:function(){this.inherited(arguments);this._formPaneWidth="100%";this._formPaneRegion="right";this._watchHandles=[];},destroy:function(){_1.forEach(this._watchHandles,function(_d){_d.unwatch();});this._watchHandles=null;if(this._formPane){this.layoutContainer.removeChild(this._formPane);this._formPane.destroyRecursive();}this.layoutContainer.layout();this.inherited(arguments);},_setupForm:function(){if(this._formContainer){this.layoutContainer.removeChild(this._formPane);this._formContainer.destroyRecursive();this._formPane.destroyRecursive();}this._formWidgets={};var _e=_1.hitch(this,function(_f,_10){this._formWidgets[_f]=_10;this._addStateWatch(_10);});var _11=_1.hitch(this,function(_12,_13){if(_13.contentViewModel!==undefined){_13.set("contentViewModel",this.viewModel);}});var _14=_1.hitch(this,function(_15){this.layoutContainer.addChild(this._formPane);this._createFormEditorWrappers(_15);this.onSetupEditModeComplete();this.connect(this.layoutContainer.getSplitter(this._formPaneRegion),"_stopDrag",_1.hitch(this,function(){if(this.get("noPreview")){this.onReloadRequired();this.set("noPreview",false);}else{var pos=_1.position(this.iFrame.domNode);if(pos.w===0){this.set("noPreview",true);}}}));});this._formPane=new _7({splitter:this.viewModel.contentData.hasTemplate,gutters:false,region:this._formPaneRegion,style:{width:this._formPaneWidth}});this._formContainer=new _c({splitter:false,region:"center",readOnly:!this.viewModel.canChangeContent(),metadata:this.viewModel.metadata,onFieldCreated:_e,onGroupCreated:_11,onFormCreated:_14});this._formPane.addChild(this._formContainer);this._formPane.startup();_1.addClass(this._formContainer.domNode,"epi-cmsEditingForm");},_createFormEditorWrappers:function(_16){this._formEditorWrappers={};for(var _17 in this._formWidgets){var _18={name:_17,metadata:this.viewModel.getPropertyMetaData(_17)};var _19=_1.clone(this.viewModel.getProperty(_18.name),true);var _1a=new _b({property:_18,propertyName:_17,value:_19,editorWidget:this._formWidgets[_17],contentModel:this.viewModel.contentModel});_1a.editorWidget.set("parent",_1a);_1a.editorWidget.set("editMode","formedit");this.connect(_1a,"onValueChange","_onWrapperValueChange");this.connect(_1a,"onDoubleValueChange","_onDoubleValueChange");this.connect(_1a,"onCancel","_onWrapperCancel");this.connect(_1a,"onStopEdit","_onWrapperStopEdit");this._formEditorWrappers[_17]=_1a;this._connectWrappersToBlocks(_17,_1a);}},_connectWrappersToBlocks:function(_1b,_1c){var _1d=_1b.split(".");var _1e=false;while(_1d.length>0){var _1f=_1d.join(".");var _20=this._mappingManager.find("propertyName",_1f);_1.forEach(_20,function(_21){_1e=true;_21.propertyName=_1b;_21.wrapper=_21.wrapper||_1c;});_1d.pop();}if(!_1e){this._mappingManager.add({propertyName:_1b,wrapper:_1c});}},_addStateWatch:function(_22){var _23=_22.get("name");this._watchHandles.push(_22.watch("state",_1.hitch(this,function(_24,_25,_26){if(_25==="Error"&&_26!=="Error"){this.viewModel.validator.clearPropertyErrors(_23,this.viewModel.validator.validationSource.client);}else{if(_25!=="Error"&&_26==="Error"){this.viewModel.validator.setPropertyErrors(_23,[{"severity":this.viewModel.validator.severity.error,"errorMessage":_22.getErrorMessage()}],this.viewModel.validator.validationSource.client);}}})));},onReadySetupEditMode:function(){this.inherited(arguments);this.toolbar.setItemProperty("editmodeswitch","checked",true);this.set("noPreview",true);this._setupForm();},remapEditMode:function(){this.inherited(arguments);this._formContainer.set("readOnly",!this.viewModel.canChangeContent());},_createEditorWrapperForBlock:function(_27,_28,_29){return this._formEditorWrappers[_27.name];}});});