//>>built
define("epi/cms/contentediting/UpdateController",["dojo","dojo/_base/declare","dojo/dom-style","dojo/dom-geometry","dojo/dom-attr","dijit"],function(_1,_2,_3,_4,_5,_6){return _2("epi.cms.contentediting.UpdateController",[],{_showEmptyNode:true,_hasEmptyHtml:false,emptyValue:"&nbsp;",minWidth:18,minHeight:14,displayNode:null,contentModel:null,contentLink:null,modelPropertyName:null,nodePropertyName:null,renderManager:null,displayName:null,renderSettings:null,rendererClass:null,constructor:function(_7){_1.mixin(this,_7);},postscript:function(){if(this.contentModel){this._modelWatchHandle=[];_1.forEach(_1.isArray(this.modelPropertyName)?this.modelPropertyName:[this.modelPropertyName],_1.hitch(this,function(_8){this._modelWatchHandle.push(this.contentModel.watch(_8,_1.hitch(this,this._renderNode)));}));}this.checkEmptyHtml();},destroy:function(){_1.forEach(this._modelWatchHandle,function(_9){_9.unwatch();});_1.disconnect(this._renderDisplayNodeConnect);delete this.srcNodeRef;delete this.displayNode;this.inherited(arguments);},onReloadRequired:function(_a){},onRender:function(_b){},_renderNode:function(_c,_d,_e){if(this.displayNode.tagName=="IMG"){if(_1.isChrome){this.displayNode.src=_e+(_e&&_e.indexOf("?")>=0?"&":"?")+new Date().getTime();}else{this.displayNode.src=_e;}if(this._isEmptyHtml(this.displayNode)){this._updateRendering("");}if(!this._renderDisplayNodeConnect){this._renderDisplayNodeConnect=_1.connect(this.displayNode,"onload",this,function(){this.onRender(this);});}return false;}var _f=this.contentLink;var _10=this.renderSettings;var _11=this.rendererClass;var _12=this.nodePropertyName||this.modelPropertyName;var def=this.renderManager.renderValue(_f,_12,_e,_10,_11);if(def!==this._lastRenderDeferred){this._lastRenderDeferred=def;_1.when(def,_1.hitch(this,function(_13){if(this._lastRenderDeferred){if(_13.doReload!==undefined&&_13.doReload){this.onReloadRequired(this);}else{if(_1.isString(_13)){this._updateRendering(_13);}else{if(_13.content!==undefined){this._updateRendering(_13.content);}else{if(_13.error!==undefined){this._handleValidationError(_13.error);}}}}if(def==this._lastRenderDeferred){this._lastRenderDeferred=null;}}}));}},_isEmptyHtml:function(_14){var _15="";if(_14.tagName=="IMG"){_15=_1.attr(_14,"src")||"";}else{_15=_14.innerHTML;}_15=_15.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"");return (typeof _15=="string")&&(_15.replace(/\s*/g,"").length===0);},checkEmptyHtml:function(){var _16;if(!this._showEmptyNode){return;}_16=this._isEmptyHtml(this.displayNode);if(_16){this.displayNode.innerHTML=_1.string.substitute(this.emptyValue,this);}this._ensureSize();},_ensureSize:function(){try{this._clearComputedStyle();this._computeStyle();}catch(e){}},_clearComputedStyle:function(){var _17=this._originalStyle;if(_17){for(var _18 in _17){if(_17.hasOwnProperty(_18)){_3.set(this.displayNode,_18,this._originalStyle[_18]);}}this._originalStyle=null;}},_computeStyle:function(){var _19=_3.get(this.displayNode),_1a={"minWidth":_3.toPixelValue(this.displayNode,_19.minWidth),"minHeight":_3.toPixelValue(this.displayNode,_19.minHeight),"display":_19.display},_1b={},_1c=_1a.minHeight===0,_1d=_1a.minWidth===0,_1e=_1a.display==="inline",_1f=_4.getMarginBox(this.displayNode,_19);if(_1f.h<(_1c?this.minHeight:_1a.minHeight)||_1f.w<(_1d?this.minWidth:_1a.minWidth)){if(_1c){_1b.minHeight=this.minHeight+"px";}if(_1d){_1b.minWidth=this.minWidth+"px";}if(_1e){_1b.display="inline-block";}if(_1e||_1c||_1d){this._originalStyle=_1a;_3.set(this.displayNode,_1b);}}},_updateRendering:function(_20){this.displayNode.innerHTML=_20;this._hasEmptyHtml=this._isEmptyHtml(this.displayNode);if(this._hasEmptyHtml){this.checkEmptyHtml();if(!this._showEmptyNode){_3.set(this.displayNode,"display","none");}}else{if(this._showEmptyNode){this._ensureSize();}}this.onRender(this);},_handleValidationError:function(_21){},render:function(){var val=this.contentModel.get(this.modelPropertyName);this._renderNode(this.modelPropertyName,val,val);},focus:function(){_6.focus(this.displayNode);},setShowEmptyNode:function(val){this._showEmptyNode=val;if(this._hasEmptyHtml){this._updateRendering("");}}});});