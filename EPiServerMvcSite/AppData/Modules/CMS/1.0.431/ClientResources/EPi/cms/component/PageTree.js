//>>built
define("epi/cms/component/PageTree",["dojo/_base/declare","dojo/_base/lang","dojo/_base/Deferred","dojo/_base/connect","dojo/dom-class","epi/dependency","epi/string","epi/shell/ClipboardManager","epi/shell/command/_WidgetCommandProviderMixin","epi/shell/widget/dialog/Alert","epi/shell/widget/dialog/Confirmation","epi/cms/_ContentContextMixin","epi/cms/contentediting/PageShortcutTypeSupport","epi/cms/widget/ContextMenu","epi/cms/command/NewContent","epi/cms/component/command/ShowAllLanguages","epi/cms/component/command/ViewTrash","epi/cms/component/_PageTreeNode","epi/cms/component/ContentFilter","epi/cms/component/SiteTreeModel","epi/cms/contentediting/ContentActionSupport","epi/cms/contentediting/command/Editing","epi/cms/core/ContentReference","epi/cms/widget/ContentTree","./command/_GlobalToolbarCommandProvider","../command/CopyContent","../command/CutContent","../command/PasteContent","../command/DeleteContent","epi/shell/selection","epi/cms/component/ContentContextMenuCommandProvider","epi/i18n!epi/cms/nls/episerver.cms.components.createpage","epi/i18n!epi/cms/nls/episerver.cms.components.pagetree"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b,_1c,_1d,_1e,_1f,_20,res){return _1("epi.cms.component.PageTree",[_18,_c,_9],{res:res,contextTypeName:"epi.cms.contentdata",isMultiLingual:false,showAllLanguages:false,_separatorBeforeCssClass:"rowSeparatorBefore",_separatorAfterCssClass:"rowSeparatorAfter",_clipboardManager:null,_contextMenu:null,_contextMenuCommandProvider:null,_focusNode:null,betweenThreshold:5,accept:["epi.cms.page.lighturi"],typeIdentifiers:["epi.cms.page"],nodeConstructor:_12,postMixInProperties:function(){this.inherited(arguments);this.application=_6.resolve("epi.cms.Application");this.model.root=this.application.getRootPage();this.model.notAllowToDelete=[this.application.getRootPage(),this.application.getWastebasketPage(),this.application.getStartPage()];this.model.notAllowToCopy=[this.application.getRootPage(),this.application.getWastebasketPage()];this.checkAcceptance=_2.hitch(this,this.checkAcceptance);this.checkItemAcceptance=_2.hitch(this,this.checkItemAcceptance);this._clipboardManager=new _8();this.selection=new _1e();this._startupCommands();this._contextMenuCommandProvider=new _1f({treeModel:this.model,clipboardManager:this._clipboardManager});},postCreate:function(){this.inherited(arguments);if(this.dndController){this.dndController.itemTreeNodeType="epi.cms.page.lighturi";}this.connect(this,"onClick","_onTreeNodeClicked");var _21=_2.hitch(this,"_resetSelectionToLastSelected");this.subscribe("/epi/dnd/dropdata",_21);this.subscribe("/dnd/cancel",_21);},startup:function(){this.inherited(arguments);_3.when(this.getCurrentContext(),_2.hitch(this,function(_22){this.contextChanged(_22);}));var _23=_6.resolve("epi.storeregistry");var _24=_23.get("epi.cms.sitestructure");var _25=new _14(_24);_3.when(_25.getAllLanguagesForCurrentSite(),_2.hitch(this,function(_26){this.set("isMultiLingual",_26.length>=2);}));},_resetSelectionToLastSelected:function(){if(!this._lastSelectedContentId||!this.selectedItem){return;}if(this.selectedItem.contentLink!==this._lastSelectedContentId){this.selectContent(this._lastSelectedContentId);}},checkAcceptance:function(_27,_28){var _29=true;_27.forInSelectedItems(function(_2a){if(!_29){return;}if(_2a.type.indexOf(this.dndController.itemTreeNodeType)==-1){_29=false;}},this);return _29;},checkItemAcceptance:function(_2b,_2c,_2d,_2e){var _2f=true;var _30=dijit.getEnclosingWidget(_2b),_31=_30&&_30.item;if(!_31){return false;}_2c.forInSelectedItems(function(_32){if(!_2f){return;}var _33=_32.data,_34=_33.dndData,_35=_33.getParent(),_36=_35.item;_2f=this.model.canPasteItem(_34,_36,_31,_2e,_2d);},this);return _2f;},_onCopyOrCut:function(_37){this.inherited(arguments);if(_37){this._copyCommand.execute();}else{this._cutCommand.execute();}},_onPaste:function(){this.inherited(arguments);this._pasteCommand.execute();},_onDelete:function(){this.inherited(arguments);if(this._deleteCommand.canExecute){this._deleteCommand.execute();}else{this._showNotificationMessage(this.res.cannotdelete);}},_startupCommands:function(){this._createCommand=new _f({order:10,contentType:_13.PageType,iconClass:"epi-iconPlus",label:_20.command.label,resources:_20});this._showLanguagesCommand=new _10({model:this});this._viewTrashCommand=new _11({typeIdentifiers:this.typeIdentifiers});var _38={category:"context",model:this.model,clipboard:this._clipboardManager,selection:this.selection};this._pasteCommand=new _1c(_38);this._copyCommand=new _1a(_38);this._cutCommand=new _1b(_38);this._deleteCommand=new _1d(_38);this.commands=[this._createCommand,_16.translate,this._showLanguagesCommand,this._viewTrashCommand,this._copyCommand,this._cutCommand,this._pasteCommand,this._deleteCommand];},_setShowAllLanguagesAttr:function(_39){this._set("showAllLanguages",_39);this.model.set("showAllLanguages",_39);},_onTreeNodeClicked:function(_3a,_3b,_3c){var _3d=this,_3e=this.currentContext?_17.compareIgnoreVersion(_3a.contentLink,this.currentContext.id):true;function _3f(){var _40={uri:_3a.uri};dojo.publish("/epi/shell/context/request",[_40,{sender:_3d,forceContextChange:true,reSelect:!_3e}]);};if(!_3e){_3f();return;}if(this.selectContentThrottle){clearTimeout(this.selectContentThrottle);this.selectContentThrottle=null;}this.selectContentThrottle=setTimeout(_3f,300);},contentContextChanged:function(_41,_42){this.inherited(arguments);if(_42&&_42.sender===this&&!_42.reSelect){return;}var _43=new _17(_41.id);var _44=_43.createVersionUnspecificReference().toString();if(_44===this.application.getWastebasketPage().toString()){return;}this._lastSelectedContentId=_44;var _45=_42&&_42.trigger!=="internal";this.selectContent(_44,_45);},selectContent:function(){_3.when(this.inherited(arguments),_2.hitch(this,function(_46){this._updateGlobalToolbarButtons();}));},_updateGlobalToolbarButtons:function(){var _47=this.get("selectedNode"),_48=_47?[{type:"epi.cms.contentdata",data:_47.item}]:[];this._createCommand.set("model",_47&&_47.item);this.selection.set("data",_48);},contextChangeFailed:function(_49,_4a,_4b){this.inherited(arguments);if(_49){if(_4b&&_4b.sender===this){this.selectContent(_49.contentLink);}}},_removeHighlightClass:function(){if(this._focusNode&&this._focusNode!=this.selectedNode&&this._focusNode.rowNode){_5.remove(this._focusNode.rowNode,"dijitTreeRowSelected");}},_onContextMenuClose:function(){this._removeHighlightClass();},_onContextMenuOpen:function(){if(this._focusNode){_5.add(this._focusNode.rowNode,"dijitTreeRowSelected");}},_set_focusNodeAttr:function(_4c){this._removeHighlightClass();this._focusNode=_4c;},_ellipsisContentText:function(_4d){var _4e="...";if(!_4d){return;}var _4f=_4d.innerText?_4d.innerText:_4d.textContent;if(_4f.length<=50){return;}_4d.textContent=_4d.innerText=_4f.substring(0,47)+_4e;},_showContextMenu:function(evt){if(!this._contextMenu){this._contextMenu=new _e({leftClickToOpen:true});this._contextMenu.addProvider(this._contextMenuCommandProvider);_4.connect(this._contextMenu,"onClose",this,"_onContextMenuClose");_4.connect(this._contextMenu,"onOpen",this,"_onContextMenuOpen");}this._contextMenuCommandProvider.updateCommandModel(evt.node.item);this._contextMenu.scheduleOpen(evt.target,null,{x:evt.x,y:evt.y});},_createTreeNode:function(){var _50=this.inherited(arguments);if(_50.item.contentLink==this.tree.model.rootPage){var _51=dojo.filter(_50.domNode.children,_2.hitch(this,function(_52){return _52.className==this._separatorAfterCssClass;}));}_50.on("onContextMenuClick",_2.hitch(this,function(_53){this.set("_focusNode",_53.node);this._showContextMenu(_53);}));return _50;},getIconClass:function(_54,_55){if(this.model.root==this.model.getIdentity(_54)){return "epi-iconObjectRoot";}else{if(_54.isWastebasket){return "epi-iconObjectTrash";}else{if(_54.isStartPage){return "epi-iconObjectStart";}else{switch(_54.properties.pageShortcutType){case _d.pageShortcutTypes.Shortcut:return "epi-iconObjectInternalLink";case _d.pageShortcutTypes.External:return "epi-iconObjectExternalLink";case _d.pageShortcutTypes.Inactive:return "epi-iconObjectNoLink";case _d.pageShortcutTypes.FetchData:return !_54.hasTemplate?"epi-iconObjectContainerFetchContent":"epi-iconObjectFetchContent";default:return !_54.hasTemplate?"epi-iconObjectContainer":"epi-iconObjectPage";}}}}},enableDrop:function(_56,_57){_56._droppable=_57;},_showNotificationMessage:function(_58){var _59=new _a({destroyOnHide:true,description:_7.toHTML(_58)});_59.show();}});});