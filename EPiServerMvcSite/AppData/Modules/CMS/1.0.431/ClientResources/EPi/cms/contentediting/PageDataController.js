//>>built
require({cache:{"url:epi/cms/contentediting/templates/PageDataController.html":"<div style=\"width: 100%; height: 100%;\">\r\n    <div data-dojo-attach-point=\"layoutContainer\" data-dojo-type=\"dijit.layout.BorderContainer\" data-dojo-props=\"gutters: false, livesplitters: false\" style=\"width: 100%; height: 100%\">\r\n        <div data-dojo-attach-point=\"toolbarContainer\" data-dojo-type=\"dijit.layout.ContentPane\" data-dojo-props=\"region:'top'\">\r\n            <div data-dojo-attach-point=\"toolbar\" data-dojo-type=\"epi.cms.contentediting.EditToolbar\"></div>\r\n            <div data-dojo-attach-point=\"notificationBar\" data-dojo-type=\"epi.cms.contentediting.NotificationBar\"></div>\r\n        </div>\r\n        <div data-dojo-attach-point=\"iframeWithOverlay\" data-dojo-type=\"epi.shell.widget.IframeWithOverlay\" data-dojo-props=\"region: 'center'\"></div>\r\n    </div>\r\n</div>"}});define("epi/cms/contentediting/PageDataController",["dojo","dojo/i18n","dojo/_base/Deferred","dojo/_base/lang","dojo/DeferredList","dijit/_TemplatedMixin","dijit/_Widget","dijit/_WidgetsInTemplateMixin","dijit/layout/BorderContainer","epi/Url","epi/dependency","epi/routes","epi/string","epi/shell/widget/dialog/Alert","epi/shell/widget/Iframe","epi/shell/widget/IframeWithOverlay","epi/shell/widget/Toolbar","epi/cms/_ContentContextMixin","epi/cms/contentediting/EditToolbar","epi/cms/contentediting/ContentViewModel","epi/cms/contentediting/ContentActionSupport","epi/cms/contentediting/ExpirationNotification","epi/cms/contentediting/NotificationBar","epi/cms/contentediting/ContentReferencesNotification","epi/cms/contentediting/LanguageNotification","epi/cms/contentediting/ShortcutNotification","epi/cms/contentediting/ViewSettingsNotification","epi/cms/contentediting/command/Editing","epi/cms/core/ContentReference","epi/i18n!epi/cms/nls/episerver.cms.contentediting","dojo/text!./templates/PageDataController.html"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b,_1c,_1d,res,_1e){return _1.declare("epi.cms.contentediting.PageDataController",[_7,_6,_8,_12],{templateString:_1e,contextTypeName:"epi.cms.contentdata",pendingNotificationTimeOutId:null,isActive:true,_startViewName:"view",_defaultEditViewName:"onpageedit",_currentViewComponent:null,_viewModels:null,_notificationHandlerId:null,_messageService:null,_editingCommands:null,_currentViewModel:null,_pageDataStore:null,_contentReferencesNotification:null,_shortcutNotification:null,_languageNotification:null,_viewMap:{"view":"epi.cms.contentediting.ContentPreview","onpageedit":"epi.cms.contentediting.OnPageEditing","formedit":"epi.cms.contentediting.FormEditing","readonly":"epi.cms.contentediting.ReadOnlyView"},_previewQueryParameters:null,_viewSettingsManager:null,_inUseNotificationManager:null,_showOverlay:true,postMixInProperties:function(){this.inherited(arguments);this._viewSettingsManager=_b.resolve("epi.viewsettingsmanager");this.connect(this._viewSettingsManager,"onReloadRequired","_onViewRequireReload");this._messageService=this._messageService||_b.resolve("epi.shell.MessageService");this._profile=this._profile||_b.resolve("epi.shell.Profile");var _1f=_b.resolve("epi.storeregistry");this._pageDataStore=_1f.get("epi.cms.contentdata");this._editingCommands=_1c;if(!this._viewModels){this._viewModels=[];}this._previewQueryParameters={epiworkspaceactive:!this._profile.get("view_publicsite")};this._inUseNotificationManager=this.inUseNotificationManager||_b.resolve("epi.cms.contentediting.inUseNotificationManager");this._contentReferencesNotification=new _18();this._languageNotification=new _19();this._expirationNotification=new _16();this._shortcutNotification=new _1a();this._viewSettingsNotification=new _1b();},postCreate:function(){this.inherited(arguments);this._profile.watch("view_publicsite",_1.hitch(this,function(){var _20=!this._profile.get("view_publicsite");if(this._previewQueryParameters){if(this._previewQueryParameters.epiworkspaceactive!=_20){this._previewQueryParameters.epiworkspaceactive=_20;}}}));this.subscribe("/epi/cms/action/switcheditmode",_1.hitch(this,this._switchEditMode));this.subscribe("/epi/cms/action/displaypreview",_1.hitch(this,function(){var _21=this._currentContentContext;var _22=this._getPreviewUrl(_21,"view");this._previousEditMode=this._currentViewModel.viewName;this._ensurePreviewReady(this.setView("view"),_22);}));var cs=_b.resolve("epi.shell.ContextService");this._interceptorHandle=cs.registerRequestInterceptor(_1.hitch(this,this._interceptRequestContext));this.notificationBar.on("notificationsChanged",_1.hitch(this,function(){this.layoutContainer.layout();}));this._contentReferencesNotification.watch("notification",_1.hitch(this,function(_23,_24,_25){if(_24){this.notificationBar.remove(_24);}if(_25&&_25.content){this.notificationBar.add(_25);}this.notificationBar.set("viewModel",this._currentViewModel.contentData);}));this._languageNotification.watch("notification",_4.hitch(this,"_defaultNotificationWatchHandler"));this._expirationNotification.watch("notification",_4.hitch(this,"_defaultNotificationWatchHandler"));this._shortcutNotification.watch("notification",_4.hitch(this,"_shortcutNotificationWatchHandler"));this._viewSettingsNotification.watch("notification",_4.hitch(this,"_defaultNotificationWatchHandler"));},startup:function(){if(this._started){return;}this.inherited(arguments);var url=new _a(window.location.href);var _26=url.getQueryParameterValue("view");this.iFrame=this.iframeWithOverlay.iframe;this.connect(this.iFrame,"onLoad","_iFrameLoaded");this.connect(this.iFrame,"onUnload","_iFrameUnLoaded");this.connect(this.iFrame,"onLoading","_iFrameLoading");_1.addClass(this.toolbar.domNode,"epi-localToolbar");this._injectCssRules();if(_26 in this._viewMap){this._startViewName=_26;}_3.when(this.getCurrentContext(),_1.hitch(this,function(_27){this.contextChanged(_27);}));},_shortcutNotificationWatchHandler:function(_28,_29,_2a){this._defaultNotificationWatchHandler(_28,_29,_2a);this._showOverlay=_1a.LinkTypes[_2a.shortcutType]!=="fetchdata";},_defaultNotificationWatchHandler:function(_2b,_2c,_2d){if(_2c){this.notificationBar.remove(_2c);}if(_2d&&_2d.content){this.notificationBar.add(_2d);}},_switchEditMode:function(_2e,_2f){var _30;var _31=this._currentViewModel.viewName;if(_2e&&_31==="view"){_30=this._previousEditMode;}else{if(_31==="formedit"){_30=this._currentViewModel.canChangeContent()?"onpageedit":"readonly";}else{_30="formedit";}}var _32=null;if(this._currentViewComponent&&this._currentViewComponent.get("noPreview")){_32=this._currentContentContext.previewUrl;}this._ensurePreviewReady(this.setView(_30,_2f),_32,function(_33){});},destroy:function(){this._interceptorHandle.remove();this._destroyCurrentViewComponent();this._viewModels=null;this.inherited(arguments);},_iFrameLoading:function(url){if(this._currentViewComponent){this._currentViewComponent.onPreviewLoading();}},_iFrameLoaded:function(url,_34){var _35=this.iFrame.isInspectable();if(!_35){return;}if(!_34){this._requestContextChangeByUrl(url,true,true);}},_iFrameUnLoaded:function(url){this.iframeWithOverlay.overlay.set("enabled",false);},_destroyCurrentViewComponent:function(){if(this._currentViewComponentReloadRequireHandle){this._currentViewComponentReloadRequireHandle.remove();}if(this._currentViewComponent){this._currentViewComponent.destroyRecursive();delete this._currentViewComponent;}},_getViewModelIndex:function(id){var _36=-1;_1.some(this._viewModels,function(_37,idx){if(_37.contentLink==id){_36=idx;return true;}});return _36;},_getViewModel:function(id){var _38=this._getViewModelIndex(id);if(_38>=0){return this._viewModels[_38];}else{return null;}},_removeViewModel:function(id){var _39=this._getViewModelIndex(id);if(_39>=0){var _3a=this._viewModels.splice(_39,1)[0];_3a.clear();}},_createViewModel:function(_3b,ctx){var _3c=new _14({contentLink:_3b.contentLink,contextTypeName:this.contextTypeName});_3c.setContentData(_3b,ctx);this._viewModels.push(_3c);return _3c;},contentContextChanged:function(ctx,_3d,_3e){if(!this.isActive){return;}this.inherited(arguments);if(_3d&&_3d.contentLinkSyncChange){this._pageDataStore.refresh(ctx.id).then(_1.hitch(this,function(_3f){this._currentViewModel.setContentData(_3f,ctx);this._currentViewComponent.onContentLinkSyncChange();this.toolbar.set("contentViewModel",this._currentViewModel);this._editingCommands.set("model",this._currentViewModel);}));}else{this._previousEditMode=null;if(this._currentViewModel){this._currentViewModel.suspend();}var _40=_3d?_3d.viewName:null;if(!_40&&this._currentViewComponent&&this._currentViewComponent.isSticky){_40=this._currentViewModel.viewName;}var _41=this._getPreviewUrl(ctx,_40);if(_3d&&_3d.triggeredByPreview){_41=null;}this._ensurePreviewReady(this._loadContentDataAndSetView(ctx.id,_40,ctx),_41);}},contentContextUpdated:function(ctx,_42){var _43=ctx.id;this._pageDataStore.refresh(_43).then(_1.hitch(this,function(_44){if(this._currentViewModel){this._currentViewModel.set("contentData",_44);}}));},_getPreviewUrl:function(_45,_46){var _47=(_46==="view"&&!_45.capabilities.isBlock&&_45.hasTemplate)?_45.publicUrl:_45.previewUrl;var _48=new _a(_47);_48.query.id=_45.id;return _48.toString();},_ensurePreviewReady:function(_49,_4a){var _4b=[];if(_49){_4b.push(_49);}if(_4a!==null&&_4a!==undefined){_4b.push(this._changeUrl(_4a));}var dl=new _5(_4b);_3.when(dl,_1.hitch(this,function(){var doc=this.iFrame.getDocument();var _4c=this.connect(this._currentViewComponent,"onPrepareOverlayComplete",function(){this.disconnect(_4c);this.iframeWithOverlay.overlay.set("enabled",this._showOverlay&&this.iFrame.isInspectable());this.iframeWithOverlay.layout(true);});this._viewSettingsManager.onPreviewReady(this.iframeWithOverlay);this._currentViewComponent.onPreviewReady(this._currentViewModel,doc);this._viewSettingsNotification.set("model",{viewModel:this._currentViewModel,viewSetting:this._viewSettingsManager});}));},_loadContentDataAndSetView:function(_4d,_4e,ctx){var def=new _3();this._pageDataStore.refresh(_4d).then(_1.hitch(this,function(_4f){if(!_4f){return;}this._currentViewModel=this._getViewModel(_4f.contentLink);this.notificationBar.clear();if(!this._currentViewModel){this._currentViewModel=this._createViewModel(_4f,ctx);}else{this._currentViewModel.setContentData(_4f,ctx);}this._inUseNotificationManager.updateCommandModel(this._currentViewModel);this._editingCommands.set("model",this._currentViewModel);this._contentReferencesNotification.set("contentData",_4f);this._languageNotification.set("contentData",_4f);this._shortcutNotification.set("viewModel",this._currentViewModel);this._expirationNotification.update(this._currentViewModel);_3.when(this.setView(_4e),function(){def.resolve();},function(){def.cancel();});}),function(){def.cancel();});return def;},itemChanged:function(id,_50){if(this._currentViewComponent){this._currentViewComponent.set("page",_50);}},setView:function(_51,_52){var def=new _3();if(_51&&!(_51 in this._viewMap)){return;}var _53=_1.hitch(this,function(){_3.when(this._setView(_51,_52),function(){def.resolve();},function(){def.cancel();});});var _54=_1.hitch(this,function(){_1.publish("/epi/cms/action/showerror");def.cancel();});_3.when(this._savePendingChanges(),_53,_54);return def;},_setView:function(_55,_56){var def=new _3();_55=_55||this._getDefaultView(this._currentViewModel);var _57=this._currentViewComponent;var _58=_57&&_57.viewModel&&_57.viewModel.viewName===_55;if(_58){this._currentViewModel.viewName=_55;def.resolve();}else{if(_55!=="view"){_1.publish("/epi/cms/action/disablepreview");}this._destroyCurrentViewComponent();var _59=_d.slashName(this._viewMap[_55]);require([_59],_1.hitch(this,function(_5a){this._currentViewComponent=new _5a(_4.mixin({layoutContainer:this.layoutContainer,iframeWithOverlay:this.iframeWithOverlay,contextTypeName:this.contextTypeName,toolbar:this.toolbar},_56));this._currentViewComponentReloadRequireHandle=this.connect(this._currentViewComponent,"onReloadRequired",_1.hitch(this,this._onViewRequireReload));this._currentViewComponent.startup();this._currentViewModel.viewName=_55;def.resolve();}));}this.toolbar.set("contentViewModel",this._currentViewModel);return def;},_onViewRequireReload:function(){this._ensurePreviewReady(null,this._currentContentContext.previewUrl);},resize:function(_5b){this.inherited(arguments);this.layoutContainer.resize(_5b);},onShow:function(){this.iframeWithOverlay.overlay.set("enabled",this._showOverlay);},onHide:function(){this.iframeWithOverlay.overlay.set("enabled",false);},_clearNotifications:function(){if(this._currentViewModel&&this._currentViewModel.validator){this._currentViewModel.validator.clear();}},_requestContextChangeByUrl:function(url,_5c,_5d,_5e,_5f){var _60=new _a(url,_5e,_5f);var _61={url:_60.toString()};_1.publish("/epi/shell/context/request",[_61,{sender:this,forceContextChange:_5c,triggeredByPreview:_5d}]);},_changeUrl:function(url){var _62=_4.mixin(this._previewQueryParameters,this._viewSettingsManager.get("previewParams"));return this.iFrame.load(url,{query:_62},true);},_getDefaultView:function(_63){return _63.contentData.hasTemplate?(_63.canChangeContent()?this._defaultEditViewName:"readonly"):"formedit";},_interceptRequestContext:function(_64,_65){if(!(_65&&_65.sender&&_65.sender===this)){return this._savePendingChanges();}else{var def=new _3();def.resolve();return def;}},_savePendingChanges:function(){if(this._currentViewModel&&!this._currentViewModel.isSaved){return this._currentViewModel.save();}else{var def=new _3();def.resolve();return def;}},savePendingChanges:function(){return this._savePendingChanges();},_injectCssRules:function(){this.iFrame.addCssRules([{selector:".epi-injected-minSize",css:"min-height: 30px;"},{selector:".epi-injected-minSize-inline",css:"min-height: 30px; min-width: 100px; display: inline-block !important;"}]);}});});