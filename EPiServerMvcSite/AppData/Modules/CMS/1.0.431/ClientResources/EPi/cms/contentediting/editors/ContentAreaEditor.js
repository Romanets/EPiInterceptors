//>>built
require({cache:{"url:epi/cms/contentediting/editors/templates/ContentAreaEditor.html":"<div class=\"dijitInline\" data-dojo-attach-point=\"stateNode\">\r\n    <div data-dojo-attach-point=\"itemContainer\" class=\"epi-content-area-itemcontainer\"></div>\r\n    <div data-dojo-attach-point=\"actionsContainer\" class=\"epi-content-area-actionscontainer\"></div>            \r\n</div>"}});define("epi/cms/contentediting/editors/ContentAreaEditor",["dojo/_base/array","dojo/_base/connect","dojo/_base/declare","dojo/_base/Deferred","dojo/_base/event","dojo/_base/lang","dojo/dnd/Manager","dojo/dom-construct","dojo/dom-class","dojo/dom-style","dojo/NodeList-dom","dojo/NodeList-traverse","dojo/NodeList-manipulate","dojo/on","dojo/query","dojo/topic","dojox/html/entities","dijit/registry","dijit/_Widget","dijit/_TemplatedMixin","dijit/_CssStateMixin","dijit/_Container","dijit/focus","epi/shell/dnd/Source","epi/shell/widget/TextWithActionLinks","epi/cms/contentediting/editors/ContentAreaEditorViewModel","epi/cms/contentediting/editors/ContentBlockEditor","epi/cms/widget/ContextMenu","epi/shell/widget/_ValueRequiredMixin","epi/cms/widget/overlay/Block","epi/cms/widget/command/CreateNewBlockSelector","dojo/text!./templates/ContentAreaEditor.html","epi/i18n!epi/cms/nls/episerver.cms.components.sharedblockscomponent","epi/i18n!epi/cms/nls/episerver.cms.contentediting.editors.contentarea","epi/i18n!epi/cms/nls/episerver.cms.widget.overlay.blockarea"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,on,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b,_1c,_1d,_1e,_1f,_20,_21,_22){return _3("epi.cms.contentediting.editors.ContentAreaEditor",[_12,_13,_15,_14,_1c],{baseClass:"epi-content-area-editor",res:_6.mixin(_21,_20),templateString:_1f,value:null,multiple:true,parent:null,overlayItem:null,model:null,_selectedEditor:null,intermediateChanges:true,editMode:"onpageedit",updateUI:false,_subscribeHandlers:null,dndTypes:["epi.cms.content.light"],_setReadOnlyAttr:function(_23){this._set("readOnly",_23);_a.set(this.actionsContainer,"display",_23?"none":"");if(this._source){this._source.isSource=!this.readOnly;}if(this._selectedEditor&&this.readOnly){this._selectedEditor.model.set("selected",false);}},_checkAcceptance:function(_24,_25){return this.readOnly?false:this._source.defaultCheckAcceptance(_24,_25);},focus:function(){var _26=this._getChildEditors();if(_26.length===0){this.textWithLinks.focus();}else{var _27=_26[0];_16.focus(_27);}},_onChange:function(_28){if(this.validate()){this.onChange(_28);}},onChange:function(_29){},onBlur:function(){},onDoubleChange:function(_2a,_2b,_2c){},startEdit:function(_2d,_2e){this.set(_2e);if(this._started){this.refresh();if(_2e.overlayItem){var _2f=_2e.overlayItem.get("selectedBlockIndex");if(_2f>=0){var _30=_11.getEnclosingWidget(this._getChildEditors()[_2f]);this.selectEditor(_30);}}return;}this._renderEditors();},postCreate:function(){this.inherited(arguments);this.set("emptyMessage",_21.emptymessage);this.model=new _19();this._subscribeHandlers=[];this._source=new _17(this.stateNode,{accept:this.dndTypes,creator:_6.hitch(this,this._createDndSourceItem),alwaysCopy:false,isSource:!this.readOnly,singular:true,parent:this.itemContainer});this._source.defaultCheckAcceptance=this._source.checkAcceptance;this._source.checkAcceptance=_6.hitch(this,this._checkAcceptance);if(this.parent){this.connect(this.parent,"onStartEdit","startEdit");}this._subscribeHandlers.push(_2.subscribe("/dnd/start",this.itemContainer,_6.hitch(this,"_startDrag")));this._subscribeHandlers.push(_2.subscribe("/dnd/cancel",this.itemContainer,_6.hitch(this,function(){this._updateDnDSourceUI(false);})));this._subscribeHandlers.push(_2.subscribe("/dnd/drop",this.itemContainer,_6.hitch(this,"_onDrop")));this._subscribeHandlers.push(_2.subscribe("/dnd/drop/before",this.itemContainer,_6.hitch(this,"_onDropping")));this.connect(this.model,"onChildrenChange","_onChildrenChange");this._watchHandle=this.watch("value",this.refresh);this.contextMenu=new _1b();this.contextMenu.addProvider(this.model);this.connect(this.contextMenu,"onOpen","_contextMenuOnOpen");},buildRendering:function(){this.inherited(arguments);var _31=new _18({contentString:_22.emptyactions.template,namedActions:_22.emptyactions.actions});this.textWithLinks=_31;this._connects.push(on(_31,"onActionClick",_6.hitch(this,function(_32){if(_32==="createnewblock"){var _33=new _1e();_33.set("model",{save:_6.hitch(this,function(_34){var _35=_6.clone(this.get("value"),true)||[];_35.push(_34);this.set("value",_35);this._onChange(_35);this.onBlur();})});_33.execute();}else{_f.publish("/epi/layout/pinnable/"+_32+"/toggle",true);}})));_31.placeAt(this.actionsContainer);},_setValueAttr:function(_36){this._set("value",_36||[]);},_startDrag:function(_37,_38,_39){var _3a=_11.getEnclosingWidget(_38[0]);this.selectEditor(_3a);if(_3a.isInstanceOf(_1d)&&this.parent["cancel"]){this.parent.set("isModified",false);this.parent.cancel();}this._updateDnDSourceUI(true);var _3b=_11.getEnclosingWidget(_37.node);if(_3b==this){this._updateIndicator(_3a);}else{this._resetIndicator();}},_onChildrenChange:function(){if(this._started){this.set("value",this.model.getValue());this.refresh();if(this.updateUI){this.updateUI=false;return;}this._commitValue();}},_ellipsisContentText:function(_3c){var _3d="...",_3e=30;var _3f=_3c;if(_3f.length<=_3e){return _3f;}return _3f.substring(0,_3e-_3d.length)+_3d;},_createDndSourceItem:function(_40,_41){var _42,_43,_44;if(_41=="avatar"){var _45=_8.create("div",{innerHTML:_10.encode(this._ellipsisContentText(_40.name))});return {"node":_45,"data":_40,"type":this.dndTypes};}if(_40.getNormalizedData){_42=_40.getNormalizedData().data;}else{_42=_40;}_43={contentLink:_42.contentLink,name:_42.name,index:_40.index};_44=new _1a({modelData:_43,contextMenu:this.contextMenu});this.model.add(_44.model);this.model.resetItemIndex();if(_40.selected===true){this.selectEditor(_44);}this.connect(_44,"onClick","_onItemOnClick");return {"node":_44.domNode,"data":_43,"type":this.dndTypes};},_contextMenuOnOpen:function(){this.model.updateCommandModel(this.model);this.onFocus();},_renderEditors:function(){this.model.clear();if(this.get("value")){_1.forEach(this.get("value"),function(_46,_47){if(_46.name===null||_46.name===""){return;}var _48={contentLink:_46.contentLink,name:_46.name||""};if(this.model.selectedItem&&this.model.selectedItem.index==_47){_6.mixin(_48,{selected:true,index:_47});}this._source.insertNodes(false,[_48]);},this);this.model.resetItemIndex();}this._updateDnDSourceUI(false);},onDropping:function(){},_updateDnDSourceUI:function(_49){if(this.itemContainer){var _4a=this._getChildEditors().length===0;_9.toggle(this.itemContainer,"epi-content-area-empty-dnd-source",_49&&_4a);}},_onDropping:function(_4b,_4c,_4d){if(this.id===_7.manager().target.id){this.onDropping();}},_onBlur:function(e){this.validate();if(e&&e.preventDefault){_5.stop(e);}},_getChildEditors:function(){return _e(".dojoDndItem",this.itemContainer);},_onDrop:function(_4e,_4f,_50,_51){var _52=_11.getEnclosingWidget(_4e.node),_53=_11.getEnclosingWidget(_51.node);this._updateDnDSourceUI(false);if(_52!=this&&_53!=this){return;}var _54=_11.getEnclosingWidget(_4f[0]);if(!_54.isInstanceOf(_1a)){this._updateItemModelIndexByDom();this.saveChanges(this,this._buildContentAreaData());return;}if(_52==this&&_53==this){_1.forEach(this._getChildEditors(),function(dom,_55){var _56=_11.getEnclosingWidget(dom);this.model.move(_56.model,_55);},this);this.saveChanges(this,this._buildContentAreaData());return;}if(_52!=this&&_53==this){_53._updateItemModelIndexByDom();_52.updateUI=true;_52.model.remove(_54.model);_52.model.resetItemIndex();_52.set("value",_52._buildContentAreaData());this.saveChanges(_53,_53._buildContentAreaData(),{source:_52.parent});return;}},saveChanges:function(_57,_58,_59){if(!_57||!_57.model||!_58){return;}if(_57.model.resetItemIndex){_57.model.resetItemIndex();}_57.set("value",_58);if(_57._commitValue){_57._commitValue(_59);}},_updateItemModelIndexByDom:function(){_1.forEach(this._getChildEditors(),function(dom,_5a){var _5b=_11.getEnclosingWidget(dom);this.model.move(_5b.model,_5a);},this);},_buildContentAreaData:function(){return this.model.getValue();},_commitValue:function(_5c){switch(this.editMode){case "formedit":if(_5c&&_5c.source&&_5c.source.editorWidget&&this._doubleSave(_5c.source.editorWidget)){return;}this._singleSave();this.onBlur();break;case "createcontent":this._onChange();break;default:this._singleSave();break;}},_doubleSave:function(_5d){if(_5d["validate"]&&_5d.validate()){this.onDoubleChange(this.get("value"),_5d.parent,_5d.parent.getEditorValue());this.onFocus();return true;}return false;},_singleSave:function(){if(this.parent&&this.parent.hasPendingChanges()){this._onChange(this.get("value"));}},refresh:function(){this._getChildEditors().orphan();this._renderEditors();this.validate();},_onItemOnClick:function(_5e){this.selectEditor(_5e);},selectEditor:function(_5f){if(_5f==null||!_5f.isInstanceOf(_1a)||this.readOnly){return;}if(this._selectedEditor){this._selectedEditor.model.set("selected",false);}this._selectedEditor=_5f;this._selectedEditor.model.set("selected",true);this.model.setSelectedItem(_5f.model);},_updateIndicator:function(_60){if(!_60&&!_60.isInstanceOf(_1a)){return;}var _61=this.model.getNext(_60.model),_62=this.model.getPrev(_60.model);_1.forEach(this._getChildEditors(),function(dom,_63){var _64=_11.getEnclosingWidget(dom);_9.toggle(dom,"epi-dndDisableTopIndicator",_61&&_64&&_64.model==_61);_9.toggle(dom,"epi-dndDisableBottomIndicator",_62&&_64&&_64.model==_62);_9.remove(dom,"epi-dndDisableIndicator");});_9.add(_60.domNode,"epi-dndDisableIndicator");},_resetIndicator:function(){_1.forEach(this._getChildEditors(),function(dom,_65){_9.remove(dom,"epi-dndDisableTopIndicator");_9.remove(dom,"epi-dndDisableBottomIndicator");_9.remove(dom,"epi-dndDisableIndicator");});},destroy:function(){if(this._subscribeHandlers){_1.forEach(this._subscribeHandlers,function(_66){_2.unsubscribe(_66);});delete this._subscribeHandlers;}this._watchHandle&&this._watchHandle.unwatch();if(this.contextMenu){this.contextMenu.destroyRecursive();delete this.contextMenu;}if(this.textWithLinks){this.textWithLinks.destroyRecursive();this.textWithLinks=null;}this.inherited(arguments);},isValid:function(){var _67=this._getChildEditors();return (!this.required||(_67&&_67.length>0));}});});