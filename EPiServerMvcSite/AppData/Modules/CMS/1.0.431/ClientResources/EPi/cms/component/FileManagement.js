//>>built
require({cache:{"url:epi/cms/component/templates/FileManagement.html":"<div style=\"position: relative;\">\r\n    <iframe frameborder=\"0\" data-dojo-attach-point=\"containerIframe\" style=\"display: block; width: 100%; height: 100%\"></iframe>\r\n    <div data-dojo-attach-point=\"dndItemOverlay\" style=\"display: none; overflow:hidden; position: absolute; background: rgba(0, 0, 0, 0.01);\"></div>\r\n    <div data-dojo-attach-point=\"dndIFrameOverlay\" style=\"display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.01);\"></div>\r\n</div>"}});define("epi/cms/component/FileManagement",["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/event","dojo/_base/connect","dojo/dnd/Source","dojo/dom-attr","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/Evented","dojo/keys","dojo/NodeList-dom","dojo/on","dojo/query","dijit/layout/_LayoutWidget","dijit/_TemplatedMixin","dijit/form/Button","epi","epi/dependency","epi/routes","epi/shell/widget/dialog/Dialog","epi/cms/widget/FilesUploadDropZone","epi/cms/widget/MultipleFileUpload","epi/cms/widget/UploadUtil","dojo/text!./templates/FileManagement.html","epi/i18n!epi/cms/nls/episerver.cms.widget.uploadmultiplefiles.uploadform"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,on,_e,_f,_10,_11,epi,_12,_13,_14,_15,_16,_17,_18,_19){return _1("epi.cms.component.FileManagement",[_f,_10,_b],{container:null,_source:null,_dialog:null,_navigatorArea:null,_fileManagementBody:null,_addFileButton:null,_filesUploadDropZone:null,_uploadDirectory:null,_breadcrumbParts:null,_dropZoneCreated:false,_disableDndOnUpload:false,_uploading:false,templateString:_18,constructor:function(){this._connections=[];},postCreate:function(){this.inherited(arguments);this.subscribe("/epi/shell/context/changed",_2.hitch(this,function(_1a){if(!_1a.capabilities.contentResources){return;}if(typeof this.containerIframe.contentWindow.virtualPathChanged=="function"){this.containerIframe.contentWindow.virtualPathChanged("pageAndVersionId:"+_1a.id);}}));this._source=new _6(this.dndItemOverlay,{creator:_2.hitch(this,this._dndSourceItemCreator),copyOnly:true,selfAccept:false,selfCopy:false,accept:[]});this.connect(this.dndItemOverlay,"onmouseout",function(evt){this._updateItemOverlay(null);});this.connect(this.dndItemOverlay,"onclick",function(evt){_4.stop(evt);var _1b=this.currentOverlayItem,_1c=this.containerIframe;_1c.contentWindow.handleClick({target:_1b,currentTarget:_1b,bubbles:true,cancelable:true,which:1,ctrlKey:_5.isCopyKey(evt)});});this.connect(this.dndItemOverlay,"oncontextmenu",this._onContextMenu);this.connect(this.dndItemOverlay,"dblclick",this._handleDblClick);this.subscribe("/dnd/start",function(){this._updateIframeOverlay(true);});this.subscribe("/dnd/cancel",function(){this._updateIframeOverlay(false);});this.subscribe("/dnd/drop",function(){this._updateIframeOverlay(false);});},startup:function(){if(this._started){return;}var _1d=_12.resolve("epi.shell.ContextService");var _1e=(_1d.currentContext!=null)?_1d.currentContext.id:"";var _1f=_13.getActionPath({moduleArea:"LegacyCMS",path:"Edit/FileManagerBrowser.aspx",IsInLegacyWrapper:true,id:_1e});_7.set(this.containerIframe,"src",_1f);this.connect(this.containerIframe,"onload",_2.hitch(this,this._onIframeLoad));this.inherited(arguments);},destroy:function(){this._detachEvents();delete this._connections;this.inherited(arguments);},currentOverlayItem:null,currentOverlayItemHtml:"",setCurrentOverlayItem:function(_20,_21){this._updateItemOverlay(_20);this._source.selectAll();this._source.deleteSelectedNodes();this._source.insertNodes(true,[{type:["fileurl"],data:_21}]);},_dndSourceItemCreator:function(_22,_23){var _24;if(_23=="avatar"){_24=_8.create("div",{innerHTML:this.currentOverlayItemHtml});}else{_24=_8.create("div",{innerHTML:"&nbsp;"});_a.set(_24,{"background":"rgba(0, 0, 0, 0.01)","position":"absolute","top":"0","left":"0","right":"0","bottom":"0"});}return {"node":_24,"type":_22.type,"data":_22.data};},_updateItemOverlay:function(_25){this.currentOverlayItem=_25;this.currentOverlayItemHtml=_25?String(_25.innerHTML):"";if(this.currentOverlayItem){var pos=_9.position(this.currentOverlayItem,true);_a.set(this.dndItemOverlay,{left:pos.x+"px",top:pos.y+"px",width:pos.w+"px",height:pos.h+"px",display:"block"});}else{_a.set(this.dndItemOverlay,"display","none");}},_updateIframeOverlay:function(_26){_a.set(this.dndIFrameOverlay,"display",(_26?"block":"none"));},_getMousePositionInFrame:function(evt){var _27=this.currentOverlayItem;var _28=this.containerIframe;var _29=_9.position(_28,true);var pos=_9.position(_27,true);var _2a={x:Math.floor(evt.clientX-_29.x),y:Math.floor(evt.clientY-_29.y)};return _2a;},_onContextMenu:function(evt){var _2b=this.currentOverlayItem;var _2c=this.containerIframe;var _2d=this._getMousePositionInFrame(evt);_a.set(this.dndItemOverlay,"display","none");_4.stop(evt);_2c.contentWindow.handleItemClick({target:_2b,currentTarget:_2b,clientX:_2d.x,clientY:_2d.y,preventDefault:function(){},stopPropagation:function(){},metaKey:0,ctrlKey:0},true);},_handleDblClick:function(evt){var _2e=this.currentOverlayItem;var _2f=this.containerIframe;var _30=this._getMousePositionInFrame(evt);_a.set(this.dndItemOverlay,"display","none");_4.stop(evt);_2f.contentWindow.handleDblClick({target:_2e,currentTarget:_2e,clientX:_30.x,clientY:_30.y,preventDefault:function(){},stopPropagation:function(){},metaKey:0,ctrlKey:0});},_onIframeLoad:function(){this._detachEvents();var _31=this;function _32(evt){var url=this.attributes["dhtmlpath"].value;_31.setCurrentOverlayItem(this,url);};this.get("fileManagementBody").query("a.FM-FileLink[dhtmltype=\"File\"]").connect("onmouseover",_32);this.get("fileManagementBody")[0].className+="Sleek";this._setupMultipleFileUpload();},_setupMultipleFileUpload:function(){var _33=_2.hitch(this,function(evt){this._showUploadForm(null);});var _34=this.get("addFileButton");if(_34){_5.connect(_34,"onclick",_2.hitch(this,function(evt){_4.stop(evt);_33(evt);}));}var _35=this.containerIframe.contentWindow.handleItemClick;this.containerIframe.contentWindow.handleItemClick=_2.hitch(this,function(e,_36){_35(e,_36);if(_36){var _37=_e(".epi-contextMenu-NewFile");if(_37){_3.forEach(_37,function(_38){var _39=_7.get(_38,"data-clickEventConnected");if(!_39){EPi.RemoveEventListener(_38,"click",_38.handleOpenMenuItem);_5.connect(_38,"onclick",_2.hitch(this,function(evt){var _3a=evt.currentTarget;if(!_3a.fEnabled){_4.stop(evt);return;}_33(evt);var _3b=document.createEvent("HTMLEvents");_3b.initEvent("click",false,true);EPi.GetDocument(window.top).dispatchEvent(_3b);}));_7.set(_38,"data-clickEventConnected","true");}},this);}}});if(_17.supportNativeDndFiles()){var _3c=this.get("navigatorArea");if(_3c){_a.set(_3c,"marginBottom","100px");}if(!this._dropZoneCreated){var _3d=new _15({outsideDomNode:this.get("fileManagementBody")[0]});_8.place(_3d.domNode,this.domNode,"last");this.connect(_3d,"onClick",_2.hitch(this,function(){this._showUploadForm(null);}));this.connect(_3d,"onDrop",this._onDrop);this._dropZoneCreated=true;}this.set("toggleDropZone",!(!_34||_7.get(_34,"disabled")));}},_getNavigatorAreaAttr:function(){var _3e=this.get("fileManagementBody");if(!_3e){return;}return this._navigatorArea=_3e.query("#navigatorArea")[0];},_getFileManagementBodyAttr:function(){return this._fileManagementBody=_e(this.containerIframe.contentDocument.body);},_getAddFileButtonAttr:function(){var _3f=this.get("fileManagementBody");if(!_3f){return;}return this._addFileButton=_3f.query(".epi-fileManagement-NewFile")[0];},_getFilesUploadDropZoneAttr:function(){return this._filesUploadDropZone=_e(".epi-filesUploadDropZone",this.domNode)[0];},_setToggleDropZoneAttr:function(_40){var _41=this.get("filesUploadDropZone");if(_41){_17.toggleVisibility(_41,_40);}},_onDrop:function(evt,_42){_42=_17.filterFileOnly(_42);if(!_42||_42.length<=0){return;}this._showUploadForm(_42);},_getUploadDirectoryAttr:function(){var _43=this.get("fileManagementBody");var _44=_43.query("input[type=hidden][name$=\"curDirectory\"]")[0];if(_44){return this._uploadDirectory=_44.value;}return null;},_getBreadcrumbPartsAttr:function(){var _45=this.get("fileManagementBody");var _46=_e(".FM-BreadCrumb >",_45[0]);if(_46){return this._breadcrumbParts=_3.map(_46,function(_47){return _e(_47).text();});}return null;},_showUploadForm:function(_48){var _49=new _16();this._dialog=new _14({title:_19.addfiles,content:_49,defaultActionsVisible:false,closeIconVisible:false});_49.on("beforeUploaderChange",_2.hitch(this,function(){this._uploading=true;}));_49.on("uploadComplete",_2.hitch(this,function(){if(typeof this.containerIframe.contentWindow.DoEmptyPostback==="function"){this.containerIframe.contentWindow.DoEmptyPostback();if(this._dialog&&!this._dialog.open){this._dialog.destroy();}}this._uploading=false;}));_49.on("close",_2.hitch(this,function(_4a){if(this._dialog){if(_4a){this._dialog.hide();}else{this._dialog.destroy();}}}));this._dialog.definitionConsumer.add({name:"close",label:epi.resources.action.close,action:function(){_49.close();}});this._dialog.resize({w:700});this._dialog.show();if(!this._disableDndOnUpload){this._disableMultipleFileUploadDnd();this._disableDndOnUpload=true;}_49.set("breadcrumb",this.get("breadcrumbParts"));_49.set("uploadDirectory",this.get("uploadDirectory"));_49.upload(_48);},_detachEvents:function(){_3.forEach(this._connections,function(_4b,_4c){try{_5.disconnect(_4b);}catch(e){}});this._connections=[];},_disableMultipleFileUploadDnd:function(){var _4d=_2.hitch(this,function(evt){if(this._uploading){if(evt.preventDefault){evt.preventDefault();}try{evt.dataTransfer.effectAllowed="none";}catch(ex){}evt.dataTransfer.dropEffect="none";return false;}});this.connect(dijit._underlay.domNode,"dragover",_4d);this.connect(this._dialog.domNode,"dragover",_4d);}});});