//>>built
define("epi/cms/legacy/LegacyDialogWrapper",["dojo","dojo/_base/declare","dojo/_base/lang","dojo/has","dojo/_base/sniff","dijit","dijit/a11y","dijit/focus","dijit/layout/_LayoutWidget","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_Contained","dijit/form/Button","epi/Url","epi/cms/legacy/_LegacyDialogObject","epi/cms/legacy/LegacyDialogPopup","epi/shell/widget/_ActionProviderWidget"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11){return _2("epi.cms.legacy.LegacyDialogWrapper",[_9,_a,_b,_11,_c],{_currentUrl:null,dialogArguments:null,callbackArguments:null,features:null,autoFit:false,showLoadingOverlay:false,_isIframeInitialLoad:true,_iframeFocusRegistration:null,templateString:"        <div style=\"position: relative;\" tabindex=\"0\">            <iframe data-dojo-attach-point=\"containerIframe\" tabindex=\"-1\" frameborder=0 width=\"${features.width}\" height=\"${features.height}\" style=\"border: none; position: absolute, top:0, left: 0;\" src=\"about:blank\" ></iframe>            <div data-dojo-attach-point=\"loadingOverlay\" style=\"position: absolute; top: 0; left: 0; width: ${features.width}px; height: ${features.height}px;\" class=\"epiLoadingOverlay\"></div>        </div>",constructor:function(_12,_13){this.editorparams=_12||{};this.metadata=_13||{};this._isIframeInitialLoad=true;},postMixInProperties:function(){this.inherited(arguments);this.features=_1.mixin({width:320,height:240},this.features);this.buttonsMap=this.buttonsMap||[];},postCreate:function(){this.inherited(arguments);if(!this.showLoadingOverlay){_1.style(this.loadingOverlay,{display:"none"});}this._legacyDialog=this._createLegacyDialogObject(_1.hitch(this,function(){this.onCallback.apply(this,arguments);}),this.callbackArguments,this.dialogArguments,window);},startup:function(){this.inherited(arguments);if(this.containerIframe.attachEvent){this.containerIframe.attachEvent("onload",_1.hitch(this,this._onIframeLoad));}else{this.connect(this.containerIframe,"onload",_1.hitch(this,this._onIframeLoad));}this.connect(window,"onresize",_1.hitch(this,function(){if(!this.autoFit){return;}this._calculateAndSetActualSize();}));},resize:function(){this.inherited(arguments);if(this._started){this._calculateAndSetActualSize();}},_setUrlAttr:function(_14){var url=_14||"about:blank";this._currentUrl=url;_1.attr(this.containerIframe,"src",url);},onCallback:function(_15){},onLoad:function(){},onCancel:function(){},onFocus:function(){this.inherited(arguments);this._focusIframeContent();},getLegacyDialog:function(){return this._legacyDialog;},_focusIframeContent:function(){var _16=this.containerIframe.contentWindow;var doc=_16&&_16.document;var _17=(doc&&_7.getFirstInTabbingOrder(doc))||this.containerIframe;if(_4("ie")!==9){_6.focus(_17);}},_onIframeLoad:function(){_1.subscribe("/IsInLegacyWrapper/NeedToBeCloseOnLoad",_1.hitch(this,function(_18){this.onCancel();}));var _19=this.containerIframe.contentWindow;this._iframeFocusRegistration=_8.registerIframe(this.containerIframe);this._focusIframeContent();this._overrideLegacyDialogUtilities();if(_19.EPi&&_19.EPi.AddWindowLoadListener){_19.EPi.AddWindowLoadListener(_1.hitch(this,this._mapDialogButtons));}else{this._mapDialogButtons();}this._setTitle();this._hideLoadingOverlay();this._calculateAndSetActualSize();if(this._isIframeInitialLoad){this.onResize();}if(this.onLoad){this.onLoad.apply(this,arguments);}this._isIframeInitialLoad=false;},_hideLoadingOverlay:function(){var _1a=this.containerIframe.contentWindow;_1.style(this.loadingOverlay,{display:"none"});if(_1a.EPi&&_1a.EPi.AddWindowLoadListener){_1a.EPi.AddEventListener(_1a,"beforeunload",_1.hitch(this,function(){if(this.showLoadingOverlay===true){_1.style(this.loadingOverlay,{display:"block"});}}));}},_setTitle:function(){var _1b=this.containerIframe.contentWindow;var _1c=_1.query("title",_1b.document);if(_1c&&_1c.length>0){this.title=_1.string.trim(_1c[0].innerHTML);}},_calculateAndSetActualSize:function(){var _1d=this.containerIframe.contentWindow;var pos=_1.position(this.containerIframe);var _1e=null;try{_1e=_1d.document.body.parentNode;}catch(e){_1e=null;}if(!_1e){return;}var _1f={w:Math.max(pos.w,_1e.scrollWidth),h:Math.max(pos.h,_1e.scrollHeight)};var _20={w:window.top.innerWidth||window.top.document.documentElement.clientWidth,h:window.top.innerHeight||window.top.document.documentElement.clientHeight};var _21=Math.abs(_1e.scrollWidth-_1e.clientWidth);_21=_21!==0?30:0;var _22={w:Math.min(_1f.w+_21,_20.w-25),h:Math.min(_1f.h,_20.h-125)};this._adjustSize(_22);},_adjustSize:function(_23){if(this.autoFit){_1.style(this.containerIframe,"width",_23.w+"px");_1.style(this.containerIframe,"height",_23.h+"px");}var _24=this.containerIframe.contentWindow;var _25=_24.document.body;_1.style(_25,"height","auto");},_mapDialogButtons:function(){var _26=this.containerIframe.contentWindow;var _27=_1.query("[data-epi-dialog-button]",_26.document);this.removeActions(this.getActions());_1.forEach(_27,_1.hitch(this,function(_28){var _29=_1.attr(_28,"data-epi-dialog-button");var _2a;switch(_29){case "functioner":return;case "container":var _2b=_1.query("[data-epi-dialog-button=\"functioner\"]",_28);_2a=_2b.length>0?_2b[0]:null;break;default:_2a=_28;break;}var _2c=_2a.tagName=="INPUT"?_2a.value:_2a.innerHTML;var _2d=_2a.tagName=="INPUT"?_1.attr(_2a,"title"):_2a.innerHTML;var _2e={name:_2a.id,label:_2c,disabled:_2a.disabled,title:_2d,action:function(){_2a.click();}};this.addActions(_2e);_1.style(_28,"display","none");}));if(this._buttonChangedHandle){_1.disconnect(this._buttonChangedHandle);}this._buttonChangedHandle=this.connect(this._legacyDialog,"ButtonChanged",function(_2f){this.setActionProperty(_2f.id,"disabled",_2f.disabled);this.setActionProperty(_2f.id,"visible",_2f.style.display!="none");this.setActionProperty(_2f.id,"label",_2f.value||_2f.innerHTML);});},_overrideLegacyDialogUtilities:function(){var _30=this.containerIframe.contentWindow;if(!_30.EPi){_30.EPi={};}_30.EPi.CreateDialog=_3.hitch(this,this._createLegacyDialogFnc);_30.EPi.GetDialog=_3.hitch(this,function(win){if(win){return win.EPi.GetDialog();}return this._legacyDialog;});},_createLegacyDialogFnc:function(url,_31,_32,_33,_34,_35){var _36=new _10({url:url,dialogArguments:_33,callbackArguments:_32,features:_34,autoFit:this.autoFit});_36.on("Callback",_3.hitch(this,function(){if(_31){_31.apply(this,arguments);}}));_36.show();return _36.legacyDialogObject;},_createLegacyDialogObject:function(_37,_38,_39,_3a){var obj=new _f({callbackMethod:_37,callbackArguments:_38,dialogArguments:_39,_opener:_3a?_3a.top:window.top});try{obj._dialog=this.containerIframe.contentWindow;}catch(e){obj._dialog=null;}return obj;},_reloadUrl:function(_3b){this._isIframeInitialLoad=_3b;if(this._isIframeInitialLoad){this._resetIframeContainerSize();}var url=new _e(this._currentUrl);_1.mixin(url.query,{"epi.preventCache":new Date().valueOf()});this.set("url",url.toString());},_resetIframeContainerSize:function(){_1.style(this.containerIframe,"width",this.features.width+"px");_1.style(this.containerIframe,"height",this.features.height+"px");},cleanup:function(){if(this._legacyDialog&&!this._legacyDialog.IsCleaned()){this._legacyDialog.Cleanup();}},destroy:function(){this.cleanup();if(this._iframeFocusRegistration){this._iframeFocusRegistration.remove();this._iframeFocusRegistration=null;}this.inherited(arguments);}});});