//>>built
require({cache:{"url:epi/cms/widget/templates/CategorySelector.html":"<div class=\"dijitReset dijitInputField dijitInputContainer dijitInline epi-resourceInputContainer epi-categorySelector\" id=\"widget_${id}\">\r\n    <div data-dojo-attach-point=\"categoriesGroupContainer\" class=\"dijit dijitReset dijitInline dijitInlineTable dijitLeft dijitTextBox displayNode epi-categoriesGroup\">\r\n    </div> \r\n    <div data-dojo-type=\"dijit.form.Button\" data-dojo-attach-event=\"onClick: _onButtonClick\" data-dojo-attach-point=\"button\" class=\"epi-categoriesSelectorButton\" data-dojo-props=\"label:'+'\"></div>\r\n</div>"}});define("epi/cms/widget/CategorySelector",["dojo/_base/array","dojo/_base/declare","dojo/_base/Deferred","dojo/_base/lang","dojo/DeferredList","dojo/dom-attr","dojo/dom-class","dojo/dom-construct","dojo/dom-style","dojo/query","dijit/_TemplatedMixin","dijit/_Widget","dijit/_WidgetsInTemplateMixin","dijit/form/Button","dijit/Tooltip","dojox/html/entities","epi/cms/widget/_HasChildDialogMixin","epi/cms/widget/CategorySelectorDialog","epi/shell/widget/_ValueRequiredMixin","epi/dependency","epi/epi","epi/shell/widget/dialog/Dialog","dojo/text!./templates/CategorySelector.html","epi/i18n!epi/cms/nls/episerver.cms.widget.CategorySelector"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,epi,_15,_16,res){return _2("epi.cms.widget.CategorySelector",[_c,_b,_d,_11,_13],{templateString:_16,localization:res,multiple:true,value:null,store:null,_categories:null,_categoriesParentsName:{},_displayUpdateDfd:null,onChange:function(_17){},postMixInProperties:function(){this.inherited(arguments);if(!this.store){var _18=_14.resolve("epi.storeregistry");this.store=_18.get("epi.cms.category");}},postCreate:function(){this.inherited(arguments);this._updateDisplayNode();},destroyDescendants:function(){if(this._tooltip){this._tooltip.destroy();delete this._tooltip;}this.inherited(arguments);},_setValueAttr:function(_19){if(!_4.isArray(_19)){_19=[_19];}var _1a=_1.filter(_19,function(v){return !!v;});this._setValueAndFireOnChange(_1a);if(_1a.length>0){this._set("value",_1a);}else{this._set("value",null);}this._started&&this.validate();},_setValueAndFireOnChange:function(_1b){if(epi.areEqual(this._categories,_1b)){return;}this._categories=_1b;this.onChange(this._categories);this._updateDisplayNode();},_getValueAttr:function(){return this._categories;},_setReadOnlyAttr:function(_1c){this._set("readOnly",_1c);_9.set(this.button.domNode,"display",_1c?"none":"");_7.toggle(this.domNode,"dijitReadOnly",_1c);},focus:function(){this.button.focus();},_createCategoryButton:function(_1d){if(_a("div[data-epi-category-id="+_1d.id+"]",this.categoriesGroupContainer).length!==0){return;}var _1e=_8.create("div",{"class":"dijitReset dijitLeft dijitInputField dijitInputContainer epi-categoryButton"});var _1f=_8.create("div",{"class":"dijitInline epi-resourceName"});var _20=_8.create("div",{"class":"dojoxEllipsis",innerHTML:_10.encode(_1d.description)});_8.place(_20,_1f);_8.place(_1f,_1e);this._tooltip=new _f({connectId:_20,label:_10.encode(this._getCategoryPath(_1d))});var _21=_8.create("div",{"class":"epi-removeButton",innerHTML:"&nbsp;"});_6.set(_21,"data-epi-category-id",_1d.id);var _22=_21.onClick?"onClick":"onclick";if(!this.readOnly){this.connect(_21,_22,_4.hitch(this,this._onRemoveClick));_8.place(_21,_1f);}else{_8.place(_8.create("span",{innerHTML:"&nbsp;"}),_1f);}_8.place(_1e,this.categoriesGroupContainer);},_getCategoryPath:function(_23){if(!_23.parentsNameCollection||_23.parentsNameCollection.length==1){return "";}var _24=_23.parentsNameCollection[1];for(i=2;i<_23.parentsNameCollection.length;i++){_24=_24+"/"+_23.parentsNameCollection[i];}return _24;},_createNoCategoriesChosenSpan:function(){this.categoriesGroupContainer.innerHTML="";_8.create("span",{innerHTML:this.localization.nocategorieschosen},this.categoriesGroupContainer);},_getCategory:function(_25){var _26=new _3();_3.when(this.store.refresh(_25),function(cat){_26.callback(cat);});return _26;},_updateDisplayNode:function(){if(this._displayUpdateDfd){this._displayUpdateDfd.cancel();this._displayUpdateDfd=null;}this.categoriesGroupContainer.innerHTML="";if(!this._categories||this._categories.length===0){this._createNoCategoriesChosenSpan();return;}this._categoriesParentsName={};var _27=[];_1.forEach(this._categories,_4.hitch(this,function(_28){_27.push(this._getCategory(_28));}));this._displayUpdateDfd=new _5(_27);_3.when(this._displayUpdateDfd,_4.hitch(this,function(_29){_1.forEach(_29,_4.hitch(this,function(_2a){if(!_2a[0]){return;}var cat=_2a[1];if(cat&&cat.visible){this._categoriesParentsName[cat.id]=cat.parentsNameCollection;this._createCategoryButton(cat);}else{var _2b=this._categories.indexOf(cat.id);if(_2b!=-1){this._categories.splice(_2b,1);}}if(this._categories.length===0){this._createNoCategoriesChosenSpan();}}));this._displayUpdateDfd=null;}),_4.hitch(this,function(){this._displayUpdateDfd=null;}));},_onRemoveClick:function(arg){if(!this._categories){return;}var _2c=parseInt(_6.get(arg.target,"data-epi-category-id"),10);var _2d=this._categories.indexOf(_2c);if(_2d==-1){return;}var _2e=_4.clone(this._categories);_2e.splice(_2d,1);this.set("value",_2e);},_getCategoriesParentsNameClone:function(){var _2f={};_1.forEach(this._categories,_4.hitch(this,function(_30){_2f[_30]=this._categoriesParentsName[_30];}));return _2f;},_onShow:function(){this.categorySelectorDialog.set("value",_4.clone(this._categories));this.categorySelectorDialog.setCategoriesParentsNameClone(this._getCategoriesParentsNameClone());this.isShowingChildDialog=true;this.categorySelectorDialog.onShow();},_onExecute:function(){var _31=this.categorySelectorDialog.get("value");this.set("value",_31);},_isEmptyArray:function(_32){return !_32||_32.length===0;},_onDialogHide:function(){this.focus();this.isShowingChildDialog=false;},_createDialog:function(){this.categorySelectorDialog=new _12({});this.dialog=new _15({title:this.localization.popuptitle,content:this.categorySelectorDialog,dialogClass:"epi-dialog-portrait"});this.connect(this.dialog,"onExecute","_onExecute");this.connect(this.dialog,"onShow","_onShow");this.connect(this.dialog,"onHide","_onDialogHide");this.dialog.startup();},_onButtonClick:function(){if(!this.dialog){this._createDialog();}this.dialog.show(true);}});});