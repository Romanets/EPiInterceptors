//>>built
require({cache:{"url:epi/cms/widget/templates/BlockArea.html":"<div data-dojo-attach-point=\"item\" class=\"epi-overlay-item\">\r\n    <div class=\"epi-overlay-item-container\">\r\n        <span class=\"epi-overlay-item-info\">${displayName}</span>\r\n        <div class=\"epi-overlay-bracket\"></div>\r\n    </div>\r\n    <div data-dojo-attach-point=\"containerNode\" class=\"epi-overlay-blockarea-container\"></div>\r\n    <div data-dojo-attach-point=\"actionsNode\" class=\"epi-overlay-blockarea-actionscontainer\">\r\n        <div data-dojo-attach-point=\"actionsNodeControls\" class=\"epi-overlay-blockarea-actions\">\r\n        </div>\r\n    </div>\r\n</div>"}});define("epi/cms/widget/overlay/BlockArea",["dojo/_base/array","dojo/_base/connect","dojo/_base/declare","dojo/_base/json","dojo/_base/lang","dojo/dom-attr","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/_base/Deferred","dojo/NodeList-dom","dojo/on","dojo/query","dojo/topic","dijit/_Container","dijit/registry","epi/shell/widget/overlay/Item","epi/shell/dnd/Source","epi/shell/dnd/_MarkerSource","epi/shell/widget/TextWithActionLinks","epi/cms/widget/overlay/Block","epi/cms/contentediting/editors/ContentBlockEditor","epi/cms/widget/command/CreateNewBlockSelector","dojo/text!../templates/BlockArea.html","epi/i18n!epi/cms/nls/episerver.cms.widget.overlay.blockarea"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,on,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19){var _1a=_3([_12,_13]);return _3("epi.cms.widget.overlay.BlockArea",[_11,_f],{"class":"epi-overlay-blockarea",contentModel:null,dropTargetType:["epi.cms.content.light"],layout:"",selectedBlockIndex:null,templateString:_18,hasChildren:false,_setHasChildrenAttr:function(_1b){this._set("hasChildren",_1b);_a.set(this.actionsNode,"display",_1b?"none":"");},_getMinHeightAttr:function(){if(!this.hasMinHeight){this._set("minHeight",_a.get(this.sourceItemNode,"minHeight"));this.hasMinHeight=true;}return this.minHeight;},onValueChange:function(_1c){},buildRendering:function(){this.inherited(arguments);this._setupEmptyInfo();},postCreate:function(){this.inherited(arguments);this._setupDirectionality();this._setupBlocks();},destroy:function(){this.inherited(arguments);this._source.destroy();if(this._emptyWidget){this._emptyWidget.destroyRecursive();this._emptyWidget=null;}},resize:function(_1d){},updatePosition:function(_1e){if(!this.canUpdatePosition()){return false;}var _1f=this.inherited(arguments);var _20;var _21;var _22;var _23;if(this.hasChildren){this._setupDirectionality();this._positionBlocks();}else{_20=Math.floor(_9.position(this.actionsNodeControls,false).h);_22=Math.floor(_9.position(this.sourceItemNode,false).h);if(_20===0){this._clearPosition();return false;}if(!this.actionNodeHeight&&_20<=_22||this.actionNodeHeight&&this.actionNodeHeight===_20){_1f=false;}else{_21=this.get("minHeight");_23=Math.min(_21,_22);_23=Math.max(_23,_20);_a.set(this.sourceItemNode,"minHeight",_23+"px");this.actionNodeHeight=_20;_1f=true;}}return _1f;},refresh:function(){this._showStandby(false);this._reset();this._setupBlocks();this.onResize();},_setupDnd:function(){this._source=new _1a(this.domNode,{_skipStartup:true,creator:_5.hitch(this,this._creator),copyOnly:false,alwaysCopy:false,dropParent:this.containerNode,type:this.dropTargetType,accept:this.dropTargetType,singular:true,propertyName:this.name});this._source.defaultCheckAcceptance=this._source.checkAcceptance;this._source.checkAcceptance=_5.hitch(this,this._checkAcceptance),this.connect(this._source,"onDropData",this._onDrop);},_creator:function(_24,_25){var _26,_27,_28={};if(_25=="avatar"){_26=_8.create("div");}else{_26=this._createBlock(null,false).domNode;}if(_24.getNormalizedData){_27=_24.getNormalizedData().data;}else{_27=_24;}_28.contentLink=_27.contentLink;_28.name=_27.name;return {"node":_26,"type":this.dropTargetType,"data":_28};},_setupBlocks:function(){if(!this.sourceItemNode){return;}var _29=this._getBlockNodes();if(_29.length>0){_1.forEach(_29,function(_2a){this._createBlock(_2a,true);},this);this.set("hasChildren",true);}else{this.set("hasChildren",false);}},_createBlock:function(_2b,_2c){var id,_2d,_2e=this.contentModel.get(this.name),_2f,_30,_31;if(!this.hasChildren){this.set("hasChildren",true);}if(_2b){id=_6.get(_2b,"data-epi-block-id");_2d=_4.fromJson(_6.get(_2b,"data-epi-block-info"));}else{_2b=this.sourceItemNode;}_1.some(_2e,function(_32){if(_32&&_32.contentLink===id){_2f=_32;return true;}return false;},this);_31={displayName:_2f?_2f.name:"",disabled:this.disabled,sourceItemNode:_2b,blockInfo:_2d,contentLink:id};_30=new _15(_31);this.addChild(_30);if(_2c){this._source.setItem(_30.domNode.id,{name:_2f?_2f.name:"",data:_2f,type:this.dropTargetType});this.connect(_30,"onClick",this._onBlockClick);this.connect(_30,"onChange",this._onBlockChange);}return _30;},_positionBlocks:function(){var _33=this.getChildren(),_34=[],_35=this.get("position");_1.forEach(_33,function(_36,i){var _37,_38,_39;if(!_34[i]){_34[i]=_9.position(_36.sourceItemNode,false);}_37=_34[i];_37.x-=_35.x;_37.y-=_35.y;_36.resize(_37);},this);},_showStandby:function(_3a){_7.toggle(this.domNode,"epi-overlay-block-standby",_3a);},_reset:function(){this.inherited(arguments);if(this.hasMinHeight&&this.sourceItemNode){_a.set(this.sourceItemNode,"minHeight",this.get("minHeight")+"px");}this._source.clearItems();this.destroyDescendants();this.set("hasMinHeight",false);this.set("actionNodeHeight",null);this.set("hasChildren",false);this.set("selectedBlock",null);},_checkAcceptance:function(_3b,_3c){var _3d=_10.getEnclosingWidget(_3c[0]);if(_3d.isInstanceOf(_16)){return false;}return this._source.defaultCheckAcceptance(_3b,_3c);},_getBlockNodes:function(){var _3e=_d("[data-epi-block-id]",this.sourceItemNode);var _3f=_d("[data-epi-block-id] [data-epi-block-id]",this.sourceItemNode);return _1.filter(_3e,function(_40){return _3f.indexOf(_40)===-1;});},_setupDirectionality:function(){if(this.layout==="vertical"){this._isHorizontal=false;}else{if(this.layout==="horizontal"){this._isHorizontal=true;}else{if(this.sourceItemNode){_1.some(this._getBlockNodes(),function(_41){var _42=_a.get(_41),_43=false,_44=false;if(_42){_43=/left|right/.test(_42.cssFloat),_44=/inline|inline-block/.test(_42.display);}this._isHorizontal=_43||_44;return this._isHorizontal;},this);}else{this._isHorizontal=false;}}}this._source.setHorizontal(this._isHorizontal);},_setupEmptyInfo:function(){this._emptyWidget=new _14({contentString:_19.emptyactions.template,namedActions:_19.emptyactions.actions});this._connects.push(on(this._emptyWidget,"onActionClick",_5.hitch(this,function(_45){if(_45==="createnewblock"){var _46=new _17();_46.set("model",{save:_5.hitch(this,function(_47){this.onValueChange({propertyName:this._source.propertyName,value:[_47]});})});_46.execute();}else{_e.publish("/epi/layout/pinnable/"+_45+"/toggle",true);}})));this._emptyWidget.placeAt(this.actionsNodeControls);},_onDrop:function(_48,_49,_4a,_4b){var _4c,_4d,_4e,_4f,_50;var _51=_48?(_48.length?_48[0]:_48):null;if(!_51){return;}this._showStandby(true);_b.when(_51,_5.hitch(this,function(_52){_4c=_1.map(this._source.getOrderedItems(),function(_53){return _53.data;});_50=_4d={propertyName:this._source.propertyName,value:_4c};if(this._source!==_49&&_49.propertyName&&!_4b){_4e=_1.map(_49.getOrderedItems(),function(_54){return _54.data;});_4f={propertyName:_49.propertyName,value:_4e};_50=[_4f,_4d];}this.onValueChange(_50);}));},_onBlockChange:function(_55,_56){var _57,_58;switch(_56){case "moveUp":this._source.current=_55.domNode.previousSibling;this._source.before=true;this._source.onDrop(this._source,[_55.domNode],false);break;case "moveDown":this._source.current=_55.domNode.nextSibling;this._source.before=false;this._source.onDrop(this._source,[_55.domNode],false);break;case "remove":this._source.delItem(_55.id);this.removeChild(_55);_55.destroyRecursive();this._onDrop({data:{}},this._source,[_55.domNode],false);break;case "edit":_57=this._source.getItem(_55.id);_58={uri:"epi.cms.contentdata:///"+_57.data.contentLink};_2.publish("/epi/shell/context/request",[_58,{}]);break;default:}},_onBlockClick:function(_59,e){var _5a=-1;_1.some(this.getChildren(),function(_5b,i){if(_5b===_59){_5a=i;return true;}},this);this.selectedBlockIndex=_5a;this.onClick(this,e);}});});