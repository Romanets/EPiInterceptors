//>>built
define("epi/cms/widget/_GridWidgetBase",["dojo","dojo/_base/lang","dojo/aspect","dojo/dom-construct","dgrid/Keyboard","dgrid/OnDemandGrid","dgrid/Selection","dijit","dijit/_WidgetBase","dijit/layout/_LayoutWidget","epi","epi/datetime","epi/UriParser","epi/username","epi/cms/_ContentContextMixin","epi/cms/core/ContentReference","epi/cms/dgrid/DnD","epi/dependency","epi/shell/dgrid/util/misc","epi/shell/widget/dialog/Alert"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,DnD,_11,_12,_13){return _1.declare("epi.cms.widget._GridWidgetBase",[_9,_a,_f],{_gridClass:_1.declare([_6,_7,DnD,_5]),storeKeyName:null,grid:null,store:null,ignoreVersionWhenComparingLinks:true,defaultGridMixin:null,_typeDescriptor:null,postMixInProperties:function(){this.inherited(arguments);this.defaultGridMixin={selectionMode:"single",selectionEvents:"click,dgrid-cellfocusin",dndParams:{creator:_2.hitch(this,this._dndNodeCreator),copyOnly:true,selfAccept:false,accept:[]}};var _14=_11.resolve("epi.cms.Application");this._typeDescriptor=_14.getTypeUIDescriptors();if(!this.store&&this.storeKeyName){var _15=_11.resolve("epi.storeregistry");this.store=_15.get(this.storeKeyName);}},startup:function(){this.inherited(arguments);this.grid.on("dgrid-select",_1.hitch(this,this._onSelect));this.grid.on("dgrid-error",_1.hitch(this,this._onError));_3.after(this.grid,"insertRow",_1.hitch(this,this._selectActiveItem));},_onSelect:function(e){var row=e.rows[0],uri=row.data.uri,_16={uri:uri};if(this._isSameAsCurrentContext(uri)){return;}this._requestNewContext(_16,{sender:this});},_requestNewContext:function(_17,_18){_1.publish("/epi/shell/context/request",[_17,_18]);},_isSameAsCurrentContext:function(uri){if(this.currentContext){return this._compareUris(uri,this.currentContext.uri);}else{return false;}},_compareUris:function(_19,_1a){var _1b=new _d(_19);var _1c=new _d(_1a);if(this.ignoreVersionWhenComparingLinks&&_1b.getType()==="epi.cms.contentdata"&&_1c.getType()==="epi.cms.contentdata"&&_10.compareIgnoreVersion(_1b.getId(),_1c.getId())){return true;}else{if(_19===_1a){return true;}}return false;},_onError:function(_1d){var _1e=this.grid.errorMessage;if(_1d.status&&_1d.status===403){_1e=_b.resources.messages.nopermissiontoviewdata;}this._showErrorMessage(_1e);},restore:function(){this.resize();},_selectActiveItem:function(_1f){var _20=this.currentContext,row=this.grid.row(_1f);if(!row){return _1f;}rowUri=row.data.uri;if(_20&&this._compareUris(rowUri,_20.uri)){this.grid.select(row,null);}return _1f;},contextChanged:function(_21,_22){this.inherited(arguments);if(_21.type!=="epi.cms.contentdata"){return;}if(!_22||_22.sender!=this){this.onContextChanged();}},onContextChanged:function(){this.fetchData();},fetchData:function(){},_showErrorMessage:function(_23){this.grid.cleanup();this.grid.contentNode.innerHTML=_23;},contextChangeFailed:function(_24,_25,_26){this.inherited(arguments);if(_26&&_26.sender===this){this._selectActiveItem();}},_localizeDate:function(_27){return _c.toUserFriendlyHtml(_27);},_createUserFriendlyUsername:function(_28){return _e.toUserFriendlyHtml(_28);},_renderContentItem:function(_29,_2a,td,_2b){var _2c="epi-iconObjectPage";if(_29.typeIdentifier){var _2d=this._typeDescriptor[_29.typeIdentifier];if(_2d&&_2d.iconClass){_2c=_2d.iconClass;}}_4.place(_12.icon(_2c+" epi-objectIcon",_12.ellipsis(_12.htmlEncode(_2a))),td);},_dndNodeCreator:function(_2e,_2f){var _30;if(_2e.typeIdentifier){var _31=this._typeDescriptor[_2e.typeIdentifier];if(_31&&_31.dndTypes){_30=_31.dndTypes;}}if(!_30&&this.dndTypes){_30=this.dndTypes;}node=_4.create("div").appendChild(document.createTextNode(_2e.name));return {"node":node,"type":_30,"data":_2e};}});});