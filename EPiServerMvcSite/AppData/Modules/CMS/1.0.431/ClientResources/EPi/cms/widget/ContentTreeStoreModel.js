//>>built
define("epi/cms/widget/ContentTreeStoreModel",["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/_base/Deferred","dojo/_base/connect","dojo/aspect","epi/cms/contentediting/ContentActionSupport","epi/dependency","epi/shell/_StatefulGetterSetterMixin","epi/shell/_HierarchicalModelMixin"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){return _1("epi.cms.widget.ContentTreeStoreModel",[_9,_a],{store:null,application:null,root:null,stopAtSubRoot:true,notAllowToDelete:null,notAllowToCopy:null,typeIdentifiers:null,showAllLanguages:false,_observers:null,_defaultDataStoreName:"epi.cms.content.light",additionalQueryOptions:{},postscript:function(_b){this.inherited(arguments);_3.mixin(this,_b);this._observers={};this.store=this.store||_8.resolve("epi.storeregistry").get(this._defaultDataStoreName);this.application=this.application||_8.resolve("epi.cms.Application");this._queryOptions=_3.mixin({ignore:["query","allLanguages"],comparers:{"typeIdentifiers":_3.hitch(this,function(_c,_d){return _2.some(_c,_3.hitch(this,function(_e){return _e===_d.typeIdentifier||this.application.isBaseTypeIdentifier(_d.typeIdentifier,_e);}));}),"referenceId":function(_f,_10){return _f===_10.parentLink;}}},this.additionalQueryOptions);var _11=_5.subscribe("/epi/cms/contentdata/updated",this,function(_12){this.store.refresh(_12.contentLink).then(_3.hitch(this,function(){if(_12.recursive){this.onItemChildrenReload(_12);}}));});var _13=_5.subscribe("/epi/cms/contentdata/childrenchanged",_3.hitch(this,this._childrenChanged));var _14=_5.subscribe("/epi/cms/contentdata/restored",this,function(_15){this._childrenChanged(_15);});var _16=_6.after(this.store,"onItemChanged",_3.hitch(this,function(id,_17){this.onChange(_17);}),true);this._handles=[_11,_13,_14,_16];},destroy:function(){for(var id in this._observers){this._observers[id].cancel();delete this._observers[id];}if(this._handles){_2.forEach(this._handles,function(_18){_18.remove();});}},_setShowAllLanguagesAttr:function(_19){this._set("showAllLanguages",_19);this.onItemChildrenReload(this.root);},getRoot:function(_1a,_1b){if(_3.isArray(this.root)){_1a({});}else{_4.when(this.store.get(this.root),_1a,_1b);}},mayHaveChildren:function(_1c){return _1c.hasChildren;},getChildren:function(_1d,_1e){var id=this.getIdentity(_1d),_1f=this._createQuery({referenceId:id,query:"getchildren"}),_20=this.store.query(_1f,this._queryOptions);var _21=_3.hitch(this,function(_22,_23,_24){if(_23===_24){this.onChange(_22);}_4.when(this.store.query(_1f,this._queryOptions),_3.hitch(this,function(_25){this.onChildrenChange(_1d,_25);}));});var _26=this._observers[id];if(_26){_26.cancel();delete this._observers[id];}this._observers[id]=_20.observe(_21,true);_4.when(_20,_1e);},_createQuery:function(_27,_28){var _29=this.typeIdentifiers&&(_3.isArray(this.typeIdentifiers)?this.typeIdentifiers:this.typeIdentifiers.split(","));var _2a=this.showAllLanguages?{allLanguages:true}:{},_2b=_28?{}:{typeIdentifiers:_29};var _2c=_3.mixin(_27,_2b,_2a);return _2c;},move:function(_2d,_2e){if(!_2e.contentLink){_2e=this.store.get(_2e);}return _4.when(_2e,_3.hitch(this,function(_2f){return _4.when(this.store.get(_2d.parentLink),_3.hitch(this,function(_30){return this.pasteItem(_2d,_30,_2f,false);}));}));},copy:function(_31,_32){return _4.when(this.store.get(_31.parentLink),_3.hitch(this,function(_33){return this.pasteItem(_31,_33,_32,true);}));},pasteItem:function(_34,_35,_36,_37,_38){var id=this.getIdentity(_34);var _39=_37?this.store.copy:this.store.move,_3a={targetId:this.getIdentity(_36),sortIndex:_38};return _39.call(this.store,id,_3a).then(_3.hitch(this,function(_3b){if(_3b.isSuccess||_3b.isPartialSuccess){var _3c=true;if(!_37&&(this.getIdentity(_35)!==this.getIdentity(_36))){_3c=this._childrenChanged(_35);}var _3d=_4.when(_3c,_3.hitch(this,function(){if(_36&&_36.isWastebasket){this.onDelete(_34,true);}this._updateItemChanged(_36.contentLink);this.store.refresh(_34.contentLink);}));}return _3b;}));},_updateItemChanged:function(_3e){_4.when(this.store.refresh(_3e),_3.hitch(this,function(_3f){this._childrenChanged(_3f);}));},_childrenChanged:function(_40){var dfd=new _4();this.getChildren(_40,_3.hitch(this,function(_41){this.onChildrenChange(_40,_41);dfd.resolve(_41);}));return dfd;},isAncestor:function(_42,_43){if(_42.contentLink==_43.contentLink){return true;}if(!_43.parentLink){return false;}return _4.when(this.store.get(_43.parentLink),_3.hitch(this,function(_44){return this.isAncestor(_42,_44);}));},getIdentity:function(_45){if(_3.isObject(_45)){return this.store.getIdentity(_45);}return _45;},getLabel:function(_46){return _46.name;},canCopy:function(_47){var _48=_47.contentLink,_49=_48===this.root||(_2.indexOf(this.notAllowToCopy,_48)>=0);return !_49&&_7.hasAccess(_47.accessMask,_7.accessLevel.Read)&&_7.hasProviderCapability(_47.providerCapabilityMask,_7.providerCapabilities.Copy);},canCut:function(_4a){var _4b=_4a.contentLink,_4c=_4b===this.root||(_2.indexOf(this.notAllowToDelete,_4b)>=0);return !_4c&&_7.isActionAvailable(_4a,_7.action.Delete,_7.providerCapabilities.Move,true);},canDelete:function(_4d){var _4e=_4d.contentLink,_4f=_4e===this.root||(_2.indexOf(this.notAllowToDelete,_4e)>=0);return !_4f&&_7.isActionAvailable(_4d,_7.action.Delete,_7.providerCapabilities.Delete,true);},canPaste:function(_50,_51,_52){var _53=_52&&_51.isWastebasket;return !_51.isDeleted&&!_53&&_7.isActionAvailable(_51,_7.action.Create,_7.providerCapabilities.Create);},canPasteItem:function(_54,_55,_56,_57,_58){var _59=_57||this.canDelete(_54);return _59&&this.canPaste(_54,_56,_57);},onItemChildrenReload:function(_5a){},onChange:function(){},onChildrenChange:function(){},onDelete:function(){}});});