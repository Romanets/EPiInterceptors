//>>built
define("epi/cms/contentediting/InUseNotificationManager",["dojo","dojo/_base/array","dojo/_base/declare","dojo/date","dojo/aspect","epi","epi/dependency","epi/datetime","epi/cms/core/ContentReference","epi/i18n!epi/cms/nls/episerver.cms.contentediting.permanenteditindication"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){return _3([],{contextTypeName:"",_postFlag:false,_inUseNotificationStore:null,_currentUsername:null,_messageService:null,currentModel:null,_eventHandlers:null,ignoreOthersNotifications:null,constructor:function(_b){this.inherited(arguments);_1.mixin(this,_b);this._inUseNotificationStore=this.store||_7.resolve("epi.storeregistry").get("epi.cms.inusenotification");this._currentUsername=this.username||_7.resolve("epi.cms.Application").getUserName();this._messageService=this.messageService||_7.resolve("epi.shell.MessageService");this._eventHandlers=[];},updateCommandModel:function(_c){this.inherited(arguments);if(this.currentModel&&!_9.compareIgnoreVersion(this.currentModel.contentData.contentLink,_c.contentData.contentLink)){this.ignoreOthersNotifications=false;}this.currentModel=_c;_2.forEach(this._eventHandlers,function(_d){_d.remove();});this.updateMessageService(this.currentModel.contentData);this._eventHandlers=[_5.after(_c,"suspend",_1.hitch(this,this._onViewModelSuspended)),_5.after(_c,"destroyed",_1.hitch(this,this._onViewModelSuspended)),_5.after(_c,"onPropertyEdited",_1.hitch(this,this._onPropertyEdited)),_5.around(_c,"canChangeContent",_1.hitch(this,this._canChangeContentAdvisor))];},_canChangeContentAdvisor:function(_e){return _1.hitch(this,function(){if(!this.ignoreOthersNotifications){var _f=this.getOtherUsersInUseNotifications(this.currentModel.contentData.inUseNotifications);if(_f&&_f.length){return false;}}return _e.apply(this.currentModel,arguments);});},_onViewModelSuspended:function(){var _10=this.currentModel.contentData;this.removeAutomaticInUseNotification(_10);},_onPropertyEdited:function(){var _11=this.currentModel.contentData;this.ensureAutomaticInUseNotification(_11);},ensureAutomaticInUseNotification:function(_12){var _13;_1.some(_12.inUseNotifications,function(_14){if(_14.userName==this._currentUsername){_13=_14;return true;}},this);if(!_13){return this.put(this._createNotification(_12,false),_12.inUseNotifications);}else{if(_13.addedManually){return;}else{var _15=_8.deserialize(_13.modified);if(_4.difference(_15,new Date(),"minute")>30){return this.put(_13,_12.inUseNotifications);}}}},removeAutomaticInUseNotification:function(_16){_1.forEach(_16.inUseNotifications,function(_17){if(_17.userName==this._currentUsername&&!_17.addedManually){this.remove(_17,_16.inUseNotifications);}},this);},_createNotification:function(_18,_19){var _1a=_8.serialize(new Date());return {userName:this._currentUsername,contentLink:_18.contentLink,languageBranch:_18.currentLanguageBranch.languageId,addedManually:_19,created:_1a,modified:_1a};},put:function(_1b,_1c){_1b.modified=_8.serialize(new Date());if(!this._postFlag){this._postFlag=true;return _1.when(this._inUseNotificationStore.put(_1b),_1.hitch(this,function(_1d){var _1e=_1.indexOf(_1c,_1b);if(_1e>=0){_1c[_1e]=_1b;}else{_1c.push(_1b);}this._updateDependentStores(_1b.contentLink,_1c);this._postFlag=false;}));}},remove:function(_1f,_20){return _1.when(this._inUseNotificationStore.remove(_1f.id),_1.hitch(this,function(){var _21=_1.indexOf(_20,_1f);_20.splice(_21,1);this._updateDependentStores(_1f.contentLink,_20);}));},_updateDependentStores:function(_22,_23){var _24={contentLink:_22,inUseNotifications:_23};this._inUseNotificationStore.updateDependentStores(_24);},togglePermanentEditIndication:function(_25,_26){var _27;var _28=_1.some(_25.inUseNotifications,function(_29){if(_29.userName==this._currentUsername){_27=_29;if(_29.addedManually){return true;}}},this);if(_28){if(_26){_27.addedManually=false;return this.put(_27,_25.inUseNotifications);}else{return this.remove(_27,_25.inUseNotifications);}}else{if(_27&&_26){_27.addedManually=true;}else{_27=this._createNotification(_25,true);}return this.put(_27,_25.inUseNotifications);}},updateMessageService:function(_2a){var _2b=_2a.contentLink+"_permanentEdit";this._messageService.remove({externalItemId:_2b});var _2c=this._getManualInUseNotification(_2a.inUseNotifications);if(_2c){this._notificationHandlerId=this._messageService.put("note",_a.permanenteditison,this.contextTypeName,_2a.contentLink,_2b,null);}},_getManualInUseNotification:function(_2d){var _2e;var _2f=_1.forEach(_2d,function(_30){if(_30.userName==this._currentUsername&&_30.addedManually){_2e=_30;}},this);return _2e;},currentUserHasInUseNotification:function(_31,_32){return _1.some(_31,function(_33){return _33.userName==this._currentUsername&&(!_32||_33.addedManually);},this);},getOtherUsersInUseNotifications:function(_34){var _35=[];_1.forEach(_34,function(_36){if(_36.userName!=this._currentUsername){_35.push(_36.userName);}},this);return _35;},hasInUseNotificationWarning:function(_37){if(this.ignoreOthersNotifications){return false;}return this.getOtherUsersInUseNotifications(_37).length;}});});