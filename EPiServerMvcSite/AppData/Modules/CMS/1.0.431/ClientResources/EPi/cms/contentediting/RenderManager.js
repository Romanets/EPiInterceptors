//>>built
define("epi/cms/contentediting/RenderManager",["dojo","dojo/_base/declare","dojo/_base/lang","dojo/_base/Deferred","dojo/_base/json","dojo/_base/array","epi","epi/dependency","epi/string","epi/datetime","dojox/encoding/digests/SHA1","dojo/Stateful","epi/cms/contentediting/PropertyRenderer"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){return _2("epi.cms.contentediting.RenderManager",[_c],{_cache:null,_queue:null,defaultRenderer:null,_rendererPool:{},rendering:false,processQueueOnRenderValue:true,numberOfItemsInQueue:0,numberOfItemsRendering:0,concurrentProcessedItems:2,processInterval:200,_processIntervalId:0,_itemsBeingRendered:null,viewSettingsManager:null,_viewSettingsToCopy:["visitorgroup"],constructor:function(_e){this._cache={};this._queue=[];this._itemsBeingRendered={};_3.mixin(this,_e);this.defaultRenderer=this.defaultRenderer||new _d();},postscript:function(){this.viewSettingsManager=this.viewSettingsManager||_8.resolve("epi.viewsettingsmanager");},destroy:function(){this._stopRenderingInterval();this._isDestroyed=true;for(var i in this._cache){delete this._cache[i];}for(var j in this._itemsBeingRendered){delete this._itemsBeingRendered[j];}this._cache=null;this._itemsBeingRendered=null;this._queue=null;this.inherited(arguments);},_getRenderer:function(_f){var def=new _4();if(_f){if(this._rendererPool[_f]){return this._rendererPool[_f];}else{var _10=_9.slashName(_f);require([_10],function(_11){def.resolve(new _11());});}}else{return this.defaultRenderer;}return def;},renderValue:function(_12,_13,_14,_15,_16){var def;if(this._isSuspending){def=new _4();def.cancel();return def;}_14=_a.transformDate(_14);_15=_15||{};_15.propertyRenderSettings=_15.propertyRenderSettings||"";var _17=_3.clone(_15);_6.forEach(this.viewSettingsManager.getRenderingViewSettings(),_3.hitch(this,function(_18){var _19=this.viewSettingsManager.getSettingProperty(_18.key);if(_19){this.updateRenderSettings(_17,_19,_18.key,_18.isTagItem);}}));var _1a=this._get(_13,_17,_14);if(_1a){def=new _4();def.resolve(_1a);}else{if(_17&&_17.isFullReload){def=new _4();def.resolve({doReload:true});}else{def=new _4();_4.when(this._getRenderer(_16),_3.hitch(this,function(_1b){if(!_1b){_1b=this.defaultRenderer;}if(this.processQueueOnRenderValue&&!this._isSuspending){this._startRenderingInterval();}_4.when(this._queueItem(_1b,_12,_13,_17,_14),function(_1c){def.resolve(_1c);});}));}}return def;},updateRenderSettings:function(_1d,_1e,key,_1f){var _20=[],_21=[],_22="",_23=(_1f?"Tag":key),_24=!_1f,_25=null;if(_1f){_1d.propertyRenderSettings=_1d.propertyRenderSettings||"";_25=(_1d.propertyRenderSettings?_1.fromJson(_1d.propertyRenderSettings):{});}else{_25=(_1d?_1d:{});}if(!_25[_23]||_24){_22=_1e;}else{_20=_25[_23].split(",");_6.forEach(_20,function(_26,idx){_26=_3.trim(_26);if(_26.toLowerCase()!=_1e.toLowerCase()){_21.push(_26);}});_21.push(_1e);_22=_21.join(", ");}_25[_23]=_22;if(_1f){_1d.propertyRenderSettings=_1.toJson(_25);}},processQueue:function(){if(this._isSuspending){return;}if(this._queue.length===0){this._stopRenderingInterval();return;}if(this.numberOfItemsRendering>=this.concurrentProcessedItems){return;}var _27=this._nextItemToProcessIndex();while(_27>=0&&this.numberOfItemsRendering<this.concurrentProcessedItems){this._processItemInQueue(_27);_27=this._nextItemToProcessIndex();}},suspend:function(){if(this._isSuspending){return;}this._isSuspending=true;this._stopRenderingInterval();},clear:function(){this.set("numberOfItemsRendering",0);for(var key in this._itemsBeingRendered){this._itemsBeingRendered[key].deferred.cancel();delete this._itemsBeingRendered[key];}this._itemsBeingRendered={};this.set("numberOfItemsInQueue",0);for(var i=this._queue.length-1;i>=0;i--){delete this._queue[i];}this._queue=[];},resume:function(){if(!this._isSuspending){return;}this._isSuspending=false;this._startRenderingInterval();},_nextItemToProcessIndex:function(){var _28=-1;var i=0;while(i<this._queue.length&&_28==-1){var _29=this._queue[i];var key=this._getRenderHash(_29.propertyName,_29.renderSettings);if(!(key in this._itemsBeingRendered)){_28=i;}i++;}return _28;},_processItemInQueue:function(_2a){var _2b=this._queue.splice(_2a,1)[0];this.set("numberOfItemsRendering",this.numberOfItemsRendering+1);this.set("numberOfItemsInQueue",this._queue.length);var key=this._getRenderHash(_2b.propertyName,_2b.renderSettings);this._itemsBeingRendered[key]=_2b;this.set("rendering",true);var _2c=_3.hitch(this,function(_2d){if(this._isDestroyed){_2b.deferred.cancel();return;}if(_2d&&_2d.content){this._put(_2b.propertyName,_2b.renderSettings,_2b.value,{doReload:false,content:_2d.content});}delete this._itemsBeingRendered[key];this.set("numberOfItemsRendering",this.numberOfItemsRendering-1);this.set("rendering",false);_2b.deferred.resolve(_2d);});var _2e=_3.hitch(this,function(err){if(this._isDestroyed){_2b.deferred.cancel();return;}delete this._itemsBeingRendered[key];this.set("numberOfItemsRendering",this.numberOfItemsRendering-1);this.set("rendering",false);_2b.deferred.reject(err);});_4.when(_2b.renderer.render(_2b.contentLink,_2b.propertyName,_2b.value,_2b.renderSettings),_2c,_2e);},cacheRender:function(_2f,_30,_31,_32){data={content:_32,doReload:false};this._put(_2f,_30,_31,data);},_queueItem:function(_33,_34,_35,_36,_37){var key=this._getRenderHash(_35,_36);var _38;var _39=this._itemsBeingRendered[key];if(_39&&!_39.deferred.fired&&_39.value===_37){_38=_39.deferred;}else{var _3a=this._queueIndex(_33,_34,_35,_36,_37);var _3b=_37!=null?_37:"";if(_3a<0){_38=new _4();this._queue.push({contentLink:_34,renderer:_33,propertyName:_35,renderSettings:_36,renderSettingsString:_5.toJson(_36),value:_3b,deferred:_38});this.set("numberOfItemsInQueue",this._queue.length);}else{var _3c=this._queue[_3a];_3c.contentLink=_34;_3c.renderer=_33;_3c.value=_3b;_38=_3c.deferred;}}return _38;},_startRenderingInterval:function(){if(!this._processIntervalId){this.processQueue();this._processIntervalId=setInterval(_3.hitch(this,function(){this.processQueue();}),this.processInterval);}},_stopRenderingInterval:function(){if(this._processIntervalId){clearInterval(this._processIntervalId);this._processIntervalId=0;}this.set("rendering",false);},_getRenderHash:function(_3d,_3e){return _b(_5.toJson({p:_3d,r:_3e}));},_queueIndex:function(_3f,_40,_41,_42,_43){var _44=-1;var _45=_5.toJson(_42);_6.some(this._queue,function(_46,i){if((_46.propertyName===_41)&&(_46.renderSettingsString==_45)){_44=i;return true;}});return _44;},_put:function(_47,_48,_49,_4a){if(!_48.cacheResults){return;}var _4b=this._getCacheHash(_47,_48,_49);this._cache[_4b]={data:_4a};},_get:function(_4c,_4d,_4e){var _4f=this._getCacheHash(_4c,_4d,_4e);var _50=this._cache[_4f];return (_50?_50.data:undefined);},_getCacheHash:function(_51,_52,_53){return _b(_5.toJson({p:_51,r:_52,v:_53}));}});});