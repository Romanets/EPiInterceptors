//>>built
define("epi/cms/contentediting/EditingBase",["dojo/_base/array","dojo/_base/declare","dojo/_base/Deferred","dojo/_base/event","dojo/_base/json","dojo/_base/lang","dojo/date/stamp","dojo/dom-attr","dojo/on","dojo/query","dojo/topic","dijit/_Widget","epi/dependency","epi/datetime","epi/string","epi/Url","epi/cms/contentediting/_View","epi/cms/contentediting/AutoSaveButton","epi/cms/contentediting/MappingManager","epi/cms/contentediting/RenderManager","epi/cms/contentediting/UpdateController","epi/cms/widget/overlay/overlayFactory","epi/i18n!epi/cms/nls/episerver.cms.contentediting"],function(_1,_2,_3,_4,_5,_6,_7,_8,on,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,res){return _2("epi.cms.contentediting.EditingBase",[_10],{toolbar:null,editorFactory:null,syncInterval:10000,activePropertyOnStartup:null,_renderManager:null,_mappingManager:null,_activeEditor:null,_autoSaveButton:null,_reloadRequiredProperty:null,_eventHandlers:null,constructor:function(){this.defaultQueryParameters={epieditmode:true,epiworkspaceactive:false};},postMixInProperties:function(){this.inherited(arguments);this.editorFactory=this.editorFactory||_c.resolve("epi.cms.contentediting.EditorFactory");this._mappingManager=new _12();this._eventHandlers=[];},postCreate:function(){this.inherited(arguments);if(this.syncInterval>0){this._syncIntervalId=window.setInterval(_6.hitch(this,"_save"),this.syncInterval);}this.subscribe("/epi/cms/action/save",this._save);this.subscribe("/epi/cms/action/undo",this._undo);this.subscribe("/epi/cms/action/redo",this._redo);this.subscribe("/epi/cms/action/disableundoredoactions",this._toggleUndoRedoActions);},startup:function(){this.overlay.set("enabled",true);},destroy:function(){this._unwatchViewModelHandles();if(this._renderManager){this._renderManager.destroy();}if(this._autoSaveButton){this._autoSaveButton.destroyRecursive();}this._mappingManager.clear();if(this.toolbar){this.toolbar=null;}if(this._syncIntervalId){clearInterval(this._syncIntervalId);}this._disconnectEventHandlers();this.inherited(arguments);},_setCommandEnabled:function(_16,_17){if(this.toolbar){this.toolbar.setItemProperty(_16,"disabled",!_17);}},onContentLinkSyncChange:function(){this.inherited(arguments);this._setButtonState();},_setViewModelAttr:function(_18){if(_18===this.viewModel){return;}this.inherited(arguments);this._disconnectEventHandlers();this._connectEventHandler(this.viewModel,"onContentChange",_6.hitch(this,function(){if(this._activeEditor!=null){this._activeEditor.tryToStopEditing();}}));this._connectEventHandler(this.viewModel,"onSetActiveProperty",this.onSetActiveProperty);},onSetActiveProperty:function(_19){var _1a=this._mappingManager.findOne("propertyName",_19);if(_1a){if(_1a.wrapper){_1a.wrapper.startEdit();}else{if(_1a.overlayItem){this._onOverlayItemClick(_1a.overlayItem);}}}},onPreviewReady:function(_1b,doc){if(_1b!=this.viewModel){this.set("viewModel",_1b);this.setupEditMode(doc);}else{if(_1b){this.remapEditMode(doc);}}},_setButtonState:function(){this._setCommandEnabled("reverttopublished",this.viewModel&&!this.viewModel.contentData.isPendingPublish);},_setNoPreviewAttr:function(_1c){this._set("noPreview",_1c);if(_1c){this._renderManager.suspend();}else{this.set("reloadRequired",true);this._renderManager.resume();}},setupEditMode:function(doc){this.viewModel.getContentModelAndMetadata().then(_6.hitch(this,function(){this._mappingManager.clear();this._renderManager=new _13();if(this.toolbar&&!this._autoSaveButton){this._autoSaveButton=new _11({button:this.toolbar._getWidget("save"),model:this.viewModel});}else{this._autoSaveButton.set("model",this.viewModel);}var _1d=_6.hitch(this,function(){this._toggleUndoRedoActions(this.viewModel.hasUndoSteps,this.viewModel.hasRedoSteps);});this.viewModel.resetNotifications();this._unwatchViewModelHandles();this._viewModelHandles=[this.viewModel.watch("hasUndoSteps",_1d),this.viewModel.watch("hasRedoSteps",_1d)];_1d();this.onReadySetupEditMode(doc);this._setButtonState();this.onPrepareOverlayComplete();}));},remapEditMode:function(doc){this.viewModel.getMetadataThenUpdateModel().then(_6.hitch(this,function(){this._renderManager.resume();if(doc){setTimeout(_6.hitch(this,function(){this._remapUpdateControllers(doc);this.onPrepareOverlayComplete();this._toggleUndoRedoActions(this.viewModel.hasUndoSteps,this.viewModel.hasRedoSteps);this._autoSaveButton.set("model",this.viewModel);}),1);}}));},_unwatchViewModelHandles:function(){if(this._viewModelHandles){_1.forEach(this._viewModelHandles,function(_1e){_1e.unwatch();});this._viewModelHandles=null;}},onReadySetupEditMode:function(doc){if(doc){this._createUpdateControllers(doc);}},onSetupEditModeComplete:function(){if(this.activePropertyOnStartup){this.onSetActiveProperty(this.activePropertyOnStartup);this.activePropertyOnStartup=null;}},_connectEventHandler:function(obj,_1f,_20){this._eventHandlers.push(this.connect(obj,_1f,_20));},_disconnectEventHandlers:function(){_1.forEach(this._eventHandlers,this.disconnect);this._eventHandlers=[];},_getPropertyNodes:function(doc){var _21=_9("[data-epi-property-name]",doc);var _22=_9("[data-epi-property-name] [data-epi-property-name]",doc);return _1.filter(_21,function(_23){return _22.indexOf(_23)===-1;});},_getEditableNodes:function(doc){var _24=this._getPropertyNodes(doc);var _25=[];_1.forEach(_24,function(_26){var _27=_e.pascalToCamel(_8.get(_26,"data-epi-property-name"));var _28=this.viewModel.getPropertyMetaData(_27);if(!_28){return;}var _29=_e.pascalToCamel(_28.name);var _2a=_8.get(_26,"data-epi-property-display-name");if(_2a){_28=_6.delegate(_28,{displayName:_2a});}if(_28!=null&&_28.showForEdit){var _2b={cacheResults:true,rerenderOnCancel:false,propertyRenderSettings:_8.get(_26,"data-epi-property-rendersettings")||undefined,useMvc:_8.has(_26,"data-epi-use-mvc")?_8.get(_26,"data-epi-use-mvc").toLowerCase()==="true":false};_2b=_6.mixin(_2b,_28.additionalValues.renderSettings);var _2c=_8.has(_26,"data-epi-property-editorsettings")?_5.fromJson(_8.get(_26,"data-epi-property-editorsettings")):null;var _2d=_8.has(_26,"data-epi-property-overlaysettings")?_5.fromJson(_8.get(_26,"data-epi-property-overlaysettings")):null;_2d=_6.mixin(_2d,_28.overlaySettings);_25.push({node:_26,disabled:(_8.get(_26,"data-epi-disabled")=="true"),useOverlay:(_8.get(_26,"data-epi-useoverlay")=="true"),overlayZIndex:parseInt(_8.get(_26,"data-epi-overlay-z-index"),10)||0,property:{name:_29,contentLink:this.viewModel.contentLink,contentModel:this.viewModel.contentModel,type:_8.get(_26,"data-epi-property-type"),wrapperType:_8.get(_26,"data-epi-property-edittype"),editorParams:_2c,overlayParams:_2d,editorWidgetType:_8.get(_26,"data-epi-property-editor"),renderSettings:_2b,rendererClass:(_8.get(_26,"data-epi-property-render")==="client")?"epi.cms.contentediting.ClientRenderer":_28.customEditorSettings.rendererClass,metadata:_28,propertyNodeName:_27}});}},this);_25.sort(function(a,b){if(a.overlayZIndex<b.overlayZIndex){return -1;}else{if(a.overlayZIndex>b.overlayZIndex){return 1;}else{return 0;}}});return _25;},_createUpdateControllers:function(doc){var _2e=this._createFullPageUpdateController(doc);if(_2e){this._connectUpdateControllerAndOverlayEvents(_2e,null);this._mappingManager.add({node:doc.body,updateController:_2e});}var _2f=this._getEditableNodes(doc);_1.forEach(_2f,function(_30){var _31=_30.property;var _32=_30.node.innerHTML;var _33=this._createNodeUpdateController(_30);_3.when(this._createNodeOverlay(_30),_6.hitch(this,function(_34){this._connectUpdateControllerAndOverlayEvents(_33,_34);this._mappingManager.add({blockPropertyInfo:_31,node:_30.node,updateController:_33,overlayItem:_34});}));this._renderManager.cacheRender(_31.name,_31.renderSettings,this.viewModel.getProperty(_31.name),_32);},this);},_createNodeOverlay:function(_35){var _36=new _3();_3.when(_15.create(_35),_6.hitch(this,function(_37){this.overlay.addChild(_37);_36.resolve(_37);}));return _36;},_createNodeUpdateController:function(_38){var _39=_38.property;var _3a=_39.metadata;var _3b=new _14({displayName:_3a.displayName,renderManager:this._renderManager,contentModel:_39.contentModel,contentLink:_39.contentLink,modelPropertyName:_39.name,nodePropertyName:_39.propertyNodeName,renderSettings:_39.renderSettings,rendererClass:_39.rendererClass,displayNode:_38.node});return _3b;},_createFullPageUpdateController:function(doc){var _3c=[];var _3d=_9("input[data-epi-full-refresh-property-names][type='hidden']",doc);_1.forEach(_3d,function(tag){_1.forEach(_8.get(tag,"data-epi-full-refresh-property-names").split(","),function(_3e){if(!_1.some(_3c,function(p){return p===_3e;})){_3c.push(_e.pascalToCamel(_3e));}});});if(!_3c.length){return null;}var _3f=new _14({displayName:"",renderManager:this._renderManager,contentModel:this.viewModel.contentModel,modelPropertyName:_3c,renderSettings:{isFullReload:true},displayNode:doc.body});return _3f;},_remapUpdateControllers:function(doc){var _40=this._getEditableNodes(doc);var _41=this._mappingManager.remap(_40,doc.body);_1.forEach(_41,function(_42){var _43=_42.property;var _44=this._createNodeUpdateController(_42);var _45=this._mappingManager.find(function(m){return (m.updateController===undefined||m.updateController===null)&&(m.propertyName.indexOf(_43.name)===0);});_3.when(this._createNodeOverlay(_42),_6.hitch(this,function(_46){this._connectUpdateControllerAndOverlayEvents(_44,_46);if(_45&&_45.length){this._mappingManager.update(_45[0],{updateController:_44,overlayItem:_46,node:_42.node});}else{this._mappingManager.add({blockPropertyInfo:_43,node:_42.node,updateController:_44,overlayItem:_46});}}));this._renderManager.cacheRender(_43.name,_43.renderSettings,this.viewModel.getProperty(_43.name),_42.node.innerHTML);},this);},_connectUpdateControllerAndOverlayEvents:function(_47,_48){if(_47){this.connect(_47,"onReloadRequired",this._onBlockReloadRequired);this.connect(_47,"onRender",this._onBlockRender);}if(_48){this.connect(_48,"onClick",this._onOverlayItemClick);this.connect(_48,"onValueChange",_6.hitch(this,"_onOverlayValueChange",_48));}},_getEditor:function(_49){var _4a=this._mappingManager.findOne("overlayItem",_49);return (_4a.wrapper&&_4a.wrapper.editorWidget)?_4a.wrapper.editorWidget:null;},_onOverlayItemClick:function(_4b,e){if(e){_4.stop(e);}var _4c=this._mappingManager.findOne("overlayItem",_4b);var _4d=_4c.blockPropertyInfo;var val=this.viewModel.getProperty(_4c.propertyName);var _4e=_6.clone(val,true);var _4f;var _50=_6.hitch(this,function(_51){_4c.wrapper=_51;_a.publish("/epi/layout/pinnable/propertyEditor/show",null);_1.forEach(this._mappingManager.find(),function(m){if(m.overlayItem){m.overlayItem.set("active",false);}});_4c.overlayItem.set("active",true);var _52={value:_4e,parent:_51};_51.startEdit(_52);this._activeEditor=_51;});if(_4c.wrapper){_4f=_4c.wrapper;_4f.set("blockDisplayNode",_4c.node);_4f.set("value",_4e);_50(_4f);}else{_3.when(this._createEditorWrapperForBlock(_4d,_4b,_4c.node,_4e),_6.hitch(this,function(_53){_50(_53);}));}},_createEditorWrapperForBlock:function(_54,_55,_56,_57){var def=new _3(),_58={overlayItem:_55};_3.when(this.editorFactory.createEditor(_54,_56,_57,_58),_6.hitch(this,function(_59){this.connect(_59,"onValueChange","_onWrapperValueChange");this.connect(_59,"onCancel","_onWrapperCancel");this.connect(_59,"onStopEdit","_onWrapperStopEdit");def.resolve(_59);}),def.reject);return def;},_onBlockReloadRequired:function(_5a){var rm=this._renderManager;setTimeout(function(){rm.suspend();rm.clear();},1);this._reloadRequiredProperty=_5a.modelPropertyName;this._reloadPropertyPreview();},_onBlockRender:function(_5b){var _5c=this._mappingManager.findOne("updateController",_5b);if(_5c&&_5c.overlayItem){_5c.overlayItem.refresh();}},_saveEditorChanges:function(_5d,_5e){var _5f=this._getEditor(_5d);if(_5f&&_5f.saveChanges){_5f.saveChanges(_5f,_5e);}},_onOverlayValueChange:function(_60,_61){this._saveEditorChanges(_60,_61.value);if(_61 instanceof Array){this.viewModel.commitProperties(_61);}else{this.viewModel.commitProperty(_61.propertyName,_61.value);}this._save();},_onOverlayItemDrop:function(_62,_63){var _64=this._mappingManager.findOne("overlayItem",_62);var _65=_64.propertyName;var _66=_63;_3.when(_66.data,_6.hitch(this,function(_67){if(!epi.areEqual(this.viewModel.getProperty(_65),_67)){this.viewModel.commitProperty(_65,_67);this._save();}else{_62.refresh();}}));},_onDoubleValueChange:function(_68,_69,_6a,_6b){var _6c=this._mappingManager.findOne("wrapper",_68);var _6d=this._mappingManager.findOne("wrapper",_6a);var _6e=[{propertyName:_6d.propertyName,value:_6b},{propertyName:_6c.propertyName,value:_69}];this.viewModel.commitProperties(_6e);this._save();},_onWrapperValueChange:function(_6f,_70){var _71=this._mappingManager.findOne("wrapper",_6f);var _72=_71.propertyName;if(_71.overlayItem){_71.overlayItem.set("updated",true);}this.viewModel.setProperty(_72,_70);},_onWrapperStopEdit:function(_73,_74,_75,_76){var _77=this._mappingManager.findOne("wrapper",_73);var _78=_77.propertyName;this.viewModel.commitProperty(_78,_74,_75);this._save();if(_77.overlayItem){_77.overlayItem.set("active",false);}this._activeEditor=null;},_onWrapperCancel:function(_79,_7a){var _7b=this._mappingManager.findOne("wrapper",_79);var _7c=_7b.updateController;if(_7c&&_7c.renderSettings&&_7c.renderSettings.rerenderOnCancel){_7c.render();}if(_79.get("isModified")){this._save();}if(_7b.overlayItem){_7b.overlayItem.set("active",false);}this._activeEditor=null;},_undo:function(){setTimeout(_6.hitch(this,function(){this.viewModel.undo();}),0);},_redo:function(){setTimeout(_6.hitch(this,function(){this.viewModel.redo();}),0);},_toggleUndoRedoActions:function(_7d,_7e){this._setCommandEnabled("undo",!!_7d);this._setCommandEnabled("redo",!!_7e);},_save:function(){if(!this.viewModel||!this.viewModel.hasPendingChanges){return;}_3.when(this.viewModel.save(),_6.hitch(this,this._reloadPropertyPreview));},_reloadPropertyPreview:function(){if(!this.viewModel.isSaved){this._save();return;}var _7f=this._activeEditor&&(this._activeEditor.propertyName===this._reloadRequiredProperty);if(this._reloadRequiredProperty&&!_7f){this._toggleUndoRedoActions(false,false);this.onReloadRequired();this._reloadRequiredProperty=null;}}});});