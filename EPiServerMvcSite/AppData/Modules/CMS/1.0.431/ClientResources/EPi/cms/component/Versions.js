//>>built
define("epi/cms/component/Versions",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/_base/Deferred","dojo/_base/connect","dojo/aspect","dojo/dom-class","dojo/on","dojo/string","dojo/topic","dgrid/OnDemandGrid","dgrid/Selection","epi/shell/widget/Tooltip","epi/username","epi/shell/command/withConfirmation","epi/dependency","epi/cms/component/command/DeleteVersion","epi/cms/component/command/SetCommonDraft","epi/cms/contentediting/ContentActionSupport","epi/cms/core/ContentReference","epi/cms/widget/_GridWidgetBase","epi/i18n!epi/cms/nls/episerver.cms.components.versions","epi/shell/command/_WidgetCommandProviderMixin","epi/cms/component/command/ShowAllLanguages","epi/shell/widget/dialog/Alert","epi/shell/widget/dialog/Confirmation","epi/shell/widget/_FocusableMixin"],function(_1,_2,_3,_4,_5,_6,_7,on,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a){return _2("epi.cms.component.Versions",[_14,_16,_1a],{showAllLanguages:false,isMultiLingual:false,_tooltips:[],postMixInProperties:function(){this._commonDrafts={};this.storeKeyName="epi.cms.contentversion";this.ignoreVersionWhenComparingLinks=false;this.inherited(arguments);var _1b=_f.resolve("epi.cms.Application");this._currentContentLanguage=_1b.currentContentLanguage();this.connect(this.store,"onItemChanged","_onItemChanged");},buildRendering:function(){this.inherited(arguments);var _1c=dojo.declare([_a,_b]);this.grid=new _1c({columns:{language:{label:epi.resources.header.language},statusName:{label:epi.resources.header.status,renderCell:function(_1d,_1e,_1f,_20){var _21=_1d.statusName;if(_1d.isCommonDraft){_21="<span class=\"dijitReset dijitInline dijitIcon epi-iconPrimary epi-floatRight\"></span>"+_1d.statusName;}_1f.innerHTML=_21;}},savedDate:{label:epi.resources.header.saved,formatter:this._localizeDate},savedBy:{label:epi.resources.header.by,formatter:this._createUserFriendlyUsername}},store:this.store,selectionMode:"single",sort:[{attribute:"savedDate",descending:true}]},this.domNode);},postCreate:function(){this.add("commands",new _17({model:this}));this._commonDraftCommand=new _11();_6.after(this._commonDraftCommand,"execute",_3.hitch(this,function(_22){_22.then(null,_3.hitch(this,this._onSetCommonDraftFailure));}));this._deleteVersionCommand=new _10();_6.after(this._deleteVersionCommand,"execute",_3.hitch(this,function(_23){_23.then(_3.hitch(this,this._onDeleteVersionSuccess),_3.hitch(this,this._onDeleteVersionFailure));}));this.add("commands",this._commonDraftCommand);this.add("commands",_e(this._deleteVersionCommand,null,{title:_15.deletemenuitemtitle,heading:_15.deleteversion.note,description:_15.deleteversion.confirmquestion}));},startup:function(){if(this._started){return;}this.inherited(arguments);_6.around(this.grid,"renderRow",_3.hitch(this,this._aroundRenderRow));this._toggleLanguage(false);this.fetchData();_5.subscribe("/epi/cms/action/pageexpirationchange",_3.hitch(this,function(_24){this.grid.set("store",this.store);}));},_setShowAllLanguagesAttr:function(_25){this._set("showAllLanguages",_25);this._toggleFilterByLanguage(_25);},destroy:function(){this.inherited(arguments);this._destroyTooltips();},_onItemChanged:function(){this.fetchData();},fetchData:function(){_4.when(this.getCurrentContent(),_3.hitch(this,function(_26){if(!_26){return;}this._destroyTooltips();if(_26.accessMask&&!_12.hasAccess(_26.accessMask,_12.accessLevel.Edit)||_26.providerCapabilityMask&&!_12.hasProviderCapability(_26.providerCapabilityMask,_12.providerCapabilities.Edit)){this._showErrorMessage(epi.resources.messages.nopermissiontoviewdata);this.set("isMultiLingual",false);return;}var _27={contentLink:_26.contentLink};if(!this._allLanguages){_27.language=this._currentContentLanguage;}this.grid.set("query",_27);this.set("isMultiLingual",true);}));},_destroyTooltips:function(){_1.forEach(this._tooltips,function(_28){_28.destroyRecursive();});this._tooltips=[];},_aroundRenderRow:function(_29){return _3.hitch(this,function(_2a){if(_2a.isCommonDraft){var _2b=this._commonDrafts[_2a.language];if(_2b&&_2b!=_2a.contentLink){this._removeCommonDraft(_2b);}this._commonDrafts[_2a.language]=_2a.contentLink;}var row=_29.apply(this.grid,arguments);_7.toggle(row,"dgrid-row-published",_2a.status===_12.versionStatus.Published);this._createTooltip(_2a,row);return row;});},_onSelect:function(e){var _2c=e.rows[0].data;this._updateMenu(_2c);this.inherited(arguments);},_updateMenu:function(_2d){this._commonDraftCommand.set("model",_2d);this._deleteVersionCommand.set("model",_2d);},_showNotificationMessage:function(_2e){var _2f=new _18({title:_15.notificationtitle,description:_2e});_2f.show();},_selectCommonDraftVersion:function(uri){var _30={uri:uri};_9.publish("/epi/shell/context/request",_30,{sender:null});},_onDeleteVersionSuccess:function(){var _31=new _13(this.grid.get("query").contentLink);this._selectCommonDraftVersion("epi.cms.contentdata:///"+_31.id);},_onDeleteVersionFailure:function(_32){if(!_32||!_32.status){return;}else{if(_32.status===403){this._showNotificationMessage(_15.deleteversion.cannotdeletepublished);}else{this._showNotificationMessage(_15.deleteversion.cannotdelete);}}},_onSetCommonDraftFailure:function(){this._showNotificationMessage(_15.setcommondraft.failuremessage);},_removeCommonDraft:function(_33){if(_33){var _34=this.grid.row(_33).data;if(_34){_34.isCommonDraft=false;this.store.put(_34);}}},_toggleFilterByLanguage:function(_35){var _36={contentLink:this.currentContext.id};if(!_35){_36.language=this._currentContentLanguage;}this._toggleLanguage(_35);this.grid.set("query",_36);this._allLanguages=_35;},_toggleLanguage:function(_37){var _38=_37?"table-cell":"none";this.grid.styleColumn("language",_8.substitute("display:${0};",[_38]));},_createTooltip:function(_39,row){var _3a=[{label:epi.resources.header.language,text:epi.resources.language[_39.language]},{label:epi.resources.header.name,text:_39.name},{label:epi.resources.header.status,text:_12.getVersionStatus(_39.status)},{label:_15.saved,text:this._localizeDate(_39.savedDate),htmlEncode:false},{label:_15.by,text:_d.toUserFriendlyString(_39.savedBy,null,true)}];var _3b=new _c({connectId:row,tooltipRows:_3a});this._tooltips.push(_3b);}});});