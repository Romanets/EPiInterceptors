//>>built
define("epi/cms/contentediting/ViewSettingsManager",["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/_base/connect","dojo/_base/Deferred","dojo/Stateful","epi/epi","epi/dependency","epi/shell/_StatefulGetterSetterMixin","epi/UriParser","epi/Url"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){return _1("epi.cms.contentediting.ViewSettingsManager",[_6,_9],{_hashWrapper:null,viewSettings:null,_viewSettingsMap:null,viewSettingsHashValue:[],_activeKey:"active",_settingEnabled:false,previewParams:null,postscript:function(){this.inherited(arguments);this._hashWrapper=_8.resolve("epi.shell.HashWrapper");this.previewParams={};this._viewSettingsMap={};_2.forEach(this.viewSettings,_3.hitch(this,function(_c){if(!this._viewSettingsMap[_c.key]){this._viewSettingsMap[_c.key]=_c;}else{throw "Duplicated view settings key.";}}));_4.subscribe("/epi/cms/action/viewsettingvaluechanged",_3.hitch(this,this._viewSettingChanged));_4.subscribe("/epi/cms/action/eyetoggle",_3.hitch(this,this._viewSettingEnabledChanged));var _d=this._hashWrapper.getHash();if(_d&&_d.viewsetting){this.viewSettingsHashValue=this._toObjects(_d.viewsetting);}this._settingEnabled=this._loadProperty(this._activeKey)==="true";_2.forEach(this.viewSettingsHashValue,_3.hitch(this,function(_e){var _f=this._viewSettingsMap[_e.type];if(_f){_f.value=_e.id;_f.beforePreviewLoad(this.previewParams,this._settingEnabled);}}));},onReloadRequired:function(){},onPreviewReady:function(_10){this._preview=_10;_2.forEach(this.viewSettings,_3.hitch(this,function(_11){_11.afterPreviewLoad(_10,this._settingEnabled);}));},getSettingProperty:function(_12){var _13=_2.filter(this.viewSettingsHashValue,function(_14){return _14.type==_12;});return _13.length>0?_13[0].id:null;},hasVisitorGroup:function(){return this.getSettingProperty("visitorgroup")!==null&&this.getSettingProperty("visitorgroup").id!==null;},_getEnabledAttr:function(){return this._settingEnabled;},_setEnabledAttr:function(_15){this._settingEnabled=_15;var _16={};_2.forEach(this.viewSettings,_3.hitch(this,function(_17){_17.beforePreviewLoad(_16,_15);}));if(!_7.areEqual(this.previewParams,_16)){this.previewParams=_16;this.onReloadRequired();}else{_2.forEach(this.viewSettings,_3.hitch(this,function(_18){_18.afterPreviewLoad(this._preview,_15);}));}},_applyViewSettingValue:function(key,_19){var _1a,_1b=this._viewSettingsMap[key];if(_1b){_1a=_3.clone(this.previewParams);_1b.value=_19;_1b.beforePreviewLoad(_1a,true);if(!_7.areEqual(this.previewParams,_1a)){this.previewParams=_1a;this.onReloadRequired();}else{_1b.afterPreviewLoad(this._preview,true);}}},_viewSettingChanged:function(key,_1c){this._saveProperty(key,_1c);this._applyViewSettingValue(key,_1c);},_viewSettingEnabledChanged:function(_1d){var _1e=this._hasSetting();if(_1d){this._saveProperty(this._activeKey,"true");}else{this._saveProperty(this._activeKey,_1e?false:null);}this.set("enabled",_1d);},_addProperty:function(_1f,_20){this.viewSettingsHashValue.push({type:_1f,id:_20});},_updateProperty:function(_21,_22){var _23=-1;_2.forEach(this.viewSettingsHashValue,function(_24,_25){if(_24.type==_21){_23=_25;return;}});if(_23>-1){this.viewSettingsHashValue[_23].id=_22;}else{this._addProperty(_21,_22);}},_toObjects:function(url){var _26=[];_2.forEach(url.split("|"),function(_27,_28){var uri=new _a(_27);_26.push({type:uri.getType(),id:uri.getId()});});return _26;},_deleteProperty:function(_29){var _2a=-1;_2.forEach(this.viewSettingsHashValue,function(_2b,_2c){if(_2b.type==_29){_2a=_2c;return;}});if(_2a>-1){this.viewSettingsHashValue.splice(_2a,1);}},_updateHash:function(){var obj=this._hashWrapper.getHash();var _2d=[];_2.forEach(this.viewSettingsHashValue,function(_2e,_2f){_2d.push(_2e.type+":///"+_2e.id);});if(_2d.length>0){obj.viewsetting=_2d.join("|");}else{delete obj.viewsetting;}this._hashWrapper.setHash(obj);},_saveProperty:function(_30,_31){var obj=this._hashWrapper.getHash();if(obj&&obj.viewsetting){this.viewSettingsHashValue=this._toObjects(obj.viewsetting);if(_31!=null){this._updateProperty(_30,_31);}else{this._deleteProperty(_30);}this._updateHash();}else{if(_31!=null){this._updateProperty(_30,_31);this._updateHash();}}},_loadProperty:function(_32){var obj=this._hashWrapper.getHash();var _33=null;if(obj&&obj.viewsetting){var _34=this._toObjects(obj.viewsetting);var _35=_2.filter(_34,function(_36){return _36.type==_32;})[0];if(_35){_33=_35.id;}}return _33;},_hasSetting:function(){var obj=this._hashWrapper.getHash();if(obj&&obj.viewsetting){if(obj.viewsetting.split("|").length>1){return true;}}return false;},getRenderingViewSettings:function(){return _2.filter(this.viewSettings,_3.hitch(this,function(_37){return _37.usedForRendering;}));}});});