//>>built
define("epi/shell/widget/ComponentController",["dojo","dojo/_base/array","dojo/_base/Deferred","dijit","epi","epi/dependency","epi/routes","dijit/_Widget","dijit/layout/ContentPane","dojo/store/JsonRest","dojo/store/Memory"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){return _1.declare("epi.shell.widget.ComponentController",_8,{moduleArea:null,widgetFactory:null,_componentsMemoryStore:null,_componentsStore:null,_componentsSortOrderStore:null,_viewController:null,postMixInProperties:function(){this.inherited(arguments);this.widgetFactory=this.widgetFactory||_6.resolve("epi.shell.widget.WidgetFactory");var _c=_6.resolve("epi.storeregistry");this._componentsStore=_c.get("epi.shell.component");this._componentsSortOrderStore=_c.get("epi.shell.componentsortorder");var _d=new _b();this._componentsMemoryStore=_d;this._viewController=_6.resolve("epi.shell.controller.Views");},postCreate:function(){this.inherited(arguments);_1.connect(this.widgetFactory,"onWidgetCreated",this,this.onComponentCreated);},startup:function(){this.inherited(arguments);},onComponentCreated:function(_e,_f){var cd=_1.clone(_f);cd._widgetId=_e.get("id");this._componentsMemoryStore.put(cd);},_queryComponentDefinitions:function(_10){return this._componentsMemoryStore.query(_10);},getComponentDefinition:function(_11){return this._queryComponentDefinitions({_widgetId:_11})[0];},getEmptyComponentDefinition:function(_12,_13){_1.when(this._componentsStore.query({componentTypeName:_12}),_13);},getComponentsForContainer:function(_14){var _15=this.getComponentDefinition(_14.id).id;return this._componentsStore.query({viewName:this._viewController.viewName,parentId:_15});},getComponentsForView:function(_16,_17){return this._componentsStore.query({viewName:_16});},removeComponent:function(_18){var _19=this;_1.when(this._componentsStore.remove(_18+"?viewName="+this._viewController.viewName),function(){_19._componentsMemoryStore.remove(_18);});},saveComponent:function(_1a,_1b,_1c,_1d){var _1e=_1.clone(_1b);delete _1e["components"];_1.when(this._componentsStore.put(_1e),_1c,_1d);},sortComponents:function(_1f,_20,_21){var _22=this.getComponentDefinition(_1f.id).id;_1.when(this._componentsSortOrderStore.put({id:_22,viewName:this._viewController.viewName,components:_20}),_21);},addComponent:function(_23,_24,_25,_26){var _27=this.getComponentDefinition(_23.id).id;var _28=_1.clone(_24);delete _28["id"];_28.parentId=_27;_28.viewName=this._viewController.viewName;var _29=this;_1.when(this._componentsStore.put(_28),function(){if(_28.settings["routeData"]){_28.settings.routeData.gadgetId=_28.id;}if(_25){_3.when(_29.createComponents([_28],_23),function(def){if(def){if(typeof _26=="function"){_26(true,_28);}}});}},function(){alert("Error: could not add component");if(typeof _26=="function"){_26(false,_28);}});},loadComponents:function(_2a){if(!_1.isArray(_2a)){_2a=[_2a];}var _2b=this;var def=new _3();_1.when(this.getComponentsForView(this._viewController.viewName),function(_2c){var _2d=_2b._convertListToHierarchyByMatchingParent(_2c,"id","parentId","components");_3.when(_2b.createComponents(_2d,_2a),function(){def.resolve();},function(e){console.error(e.stack||e);def.reject(e);});},function(){def.reject();});return def;},_convertListToHierarchyByMatchingParent:function(_2e,_2f,_30,_31){var map={};var _32=[];_2.forEach(_2e,function(_33){var id=_33[_2f];map[id]=_33;});_2.forEach(_2e,function(_34){var _35;var id=_34[_2f];var _36=_34[_30];if(!(_31 in _34)){_34[_31]=[];}_35=map[_36];if(!_35||_35==_34){if(_2.indexOf(_32,_34)<0){_32.push(_34);}}else{if(!_35[_31]){_35[_31]=[];}_35[_31].push(_34);}});return _32;},createComponents:function(_37,_38){var _39=this.widgetFactory;var _3a=_37;if(_1.isArray(_3a)&&_3a.length>0){if(_1.isArray(_3a[0])){var _3b=[];var _3c=[];for(var i=0;i<_3a.length;i++){var _3d=_3a[i];_3c.push(_39.createWidgets(_38[i],_3d).then(function(_3e){_3b[i]=_3e;}));}return new _1.DeferredList(_3c).then(function(){return _3b;});}else{var _3f=_38;if(_1.isArray(_3f)){_3f=_3f[0];}return _39.createWidgets(_3f,_3a);}}return [];}});});