//>>built
define("epi/shell/XhrWrapper",["dojo","dojo/_base/array","dojo/_base/connect","dojo/_base/declare","dojo/_base/lang","dojo/_base/Deferred","epi","epi/shell/widget/dialog/Dialog","epi/shell/widget/LoginForm"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){var _a;var _b=_4("epi.shell.XhrWrapper",null,{xhrHandler:null,_headerKeys:{validation:"X-EpiRestAntiForgeryToken",loginScreen:"X-EPiLogOnScreen",postUrl:"X-EPiLogOnScreen-PostUrl"},constructor:function(_c){_4.safeMixin(this,_c);if(!this.xhrHandler){this.xhrHandler=_1.xhr;}},xhr:function(_d,_e,_f){var _10=arguments;if(_e.xsrfProtection){var _11=new _6();_6.when(this._getXsrfHeader(_e.url),_5.hitch(this,function(_12){_e.headers=_5.mixin({},_e.headers,_12);_6.when(this._xhr.apply(this,_10),_11.resolve,_11.reject);}),_11.reject);return _11;}else{return this._xhr.apply(this,_10);}},xhrDelete:function(_13){return this.xhr("DELETE",_13);},xhrGet:function(_14){return this.xhr("GET",_14);},xhrPost:function(_15){return this.xhr("POST",_15,true);},xhrPut:function(_16){return this.xhr("PUT",_16,true);},_getXsrfHeader:function(_17){if(_b.sharedXsrfHeader){return _b.sharedXsrfHeader;}var _18={url:_17,handleAs:"json",headers:{}};_18.headers[this._headerKeys.validation]="_CreateToken_";var _19=new _6();this.xhrGet(_18).then(_5.hitch(this,function(){_19.resolve(_b.sharedXsrfHeader);}),_19.reject);return _19;},_xhr:function(_1a,_1b,_1c){var _1d=arguments;var _1e=this.xhrHandler.apply(this,arguments);var _1f=new _6();_1f.ioArgs=_1e.ioArgs;_6.when(_1e,_5.hitch(this,function(_20){var _21=_1e.ioArgs.xhr.getResponseHeader(this._headerKeys.validation);if(_21){if(!_b.sharedXsrfHeader){_b.sharedXsrfHeader={};}_b.sharedXsrfHeader[this._headerKeys.validation]=_21;}_1f.ioArgs=_1e.ioArgs;_1f.resolve(_20);}),_5.hitch(this,function(err){var _22=_1e.ioArgs.xhr.getResponseHeader(this._headerKeys.loginScreen);if(_22==="true"||_1e.ioArgs.xhr.status==="401"){var _23={postUrl:_1e.ioArgs.xhr.getResponseHeader(this._headerKeys.postUrl)};_b.sharedXsrfHeader=undefined;var _24=this._showLogin(_23);_6.when(_24,_5.hitch(this,function(){_6.when(this.xhr.apply(this,_1d),_1f.resolve,_1f.reject);}),function(){_1f.reject(err);});}else{_1f.reject(err);}}));return _1f;},_showLogin:function(_25){if(!_a){_a=new _6();var _26=new _9();var _27=new _8({title:_7.resources.action.login,confirmActionText:_7.resources.action.login,content:_26,dialogClass:"",destroyOnHide:true,_onAfterShow:function(){}});var _28=[];var _29=function(_2a){_2.forEach(_28,_3.disconnect);_26.destroyRecursive();_27.hide();if(_2a){_a.resolve();}else{_a.reject();}_a=null;};_27.addValidator(_5.hitch(this,function(){var _2b=new _6();var _2c=_26.serializeForm();var _2d=this.xhr("POST",{url:_25.postUrl,content:_2c,xsrfProtection:false,handleAs:"json"},true);_6.when(_2d,function(_2e){if(_2e.authenticationSuccessful){_29(true);_2b.resolve();}else{_26.authenticationFailed();_2b.reject();}},function(){_29(false);_2b.reject();});return _2b;}));_27.show();_28.push(_3.connect(_27,"onCancel",function(){_29(false);}));}return _a;}});_b.sharedXsrfHeader=undefined;return _b;});