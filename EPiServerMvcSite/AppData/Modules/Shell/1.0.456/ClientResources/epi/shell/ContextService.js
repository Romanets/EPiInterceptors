//>>built
define("epi/shell/ContextService",["dojo","dojo/DeferredList","epi/dependency","epi/shell/widget/dialog/Confirmation","epi/UriParser","epi/i18n!epi/shell/ui/nls/EPiServer.Shell.UI.Resources.ContextService"],function(_1,_2,_3,_4,_5,_6){return _1.declare("epi.shell.ContextService",[],{currentContext:null,_contextStore:null,_listeners:[],_profile:null,_routes:{},res:_6,_requestQueue:null,_requestInterceptors:null,initialUri:null,constructor:function(_7,_8,_9){this._contextStore=_8;if(_9===undefined){this._profile=_3.resolve("epi.shell.Profile");}this._requestInterceptors=[];this._requestQueue=[];this._initialize();},destroy:function(){_1.forEach(this._listeners,function(_a){_a.remove();});},_initialize:function(){this._listeners.push(_1.subscribe("/epi/shell/context/request",this,"_handleContextChangeRequest"));this._listeners.push(_1.subscribe("/epi/shell/context/updateRequest",this,"_handleContextUpdateRequest"));this._listeners.push(_1.subscribe("/epi/shell/context/requestcurrent",this,"_handleRequestCurrentContext"));},registerRoute:function(_b,_c){this._routes[_b]=_c;},registerRequestInterceptor:function(_d){var _e=_1.indexOf(this._requestInterceptors,_d);if(_e==-1){this._requestInterceptors.push(_d);}return {remove:_1.hitch(this,function(){this.unregisterRequestInterceptor(_d);})};},unregisterRequestInterceptor:function(_f){var _10=_1.indexOf(this._requestInterceptors,_f);if(_10!=-1){this._requestInterceptors.splice(_f,1);return _f;}return null;},_handleContextChangeRequest:function(_11,_12){if(_11===null){return;}if(this._requestInterceptors.length===0){this._loadNewContext(_11,_12,this._publishContextChanged);return;}var _13=_1.map(this._requestInterceptors,function(_14){return _14(_11,_12);},this);var _15=new _2(_13);_15.then(_1.hitch(this,function(_16){var _17=!_1.some(_16,function(_18){if(_18[0]===false){return true;}});if(_17){this._loadNewContext(_11,_12,this._publishContextChanged);}else{this._publishRequestFailed(_11,_12);}}));},_handleContextUpdateRequest:function(_19,_1a){if(_19===null){return;}this._loadNewContext(_19,_1a,this._publishContextUpdated);},_handleRequestCurrentContext:function(_1b){if(this.currentContext){_1.publish("/epi/shell/context/current",[this.currentContext,_1b]);}},_loadNewContext:function(_1c,_1d,_1e){if(_1d&&_1d.cancelIfCurrent){if("uri" in this.currentContext&&"uri" in _1c&&(this.currentContext.uri==_1c.uri||this.currentContext.requestedUri==_1c.uri)){return;}}var _1f={success:null,request:null,response:null,contextParameters:_1c,callerData:_1d,callback:_1e};var _20=_1.hitch(this,function(_21){if(_21){_1f.response=_21;_1f.success=true;this._handleContextLoaded();}else{_22(_21);}});var _22=_1.hitch(this,function(_23){_1f.response=_23;_1f.success=false;this._handleContextLoaded();});if(this._profile&&!this._profile.get("view_publicsite")){_1c.epiworkspaceactive=true;}this._requestQueue.push(_1f);var _24=this._getContextStore();var rq=_24.query(_1c);rq.then(_20,_22);_1f.request=rq;},_handleContextLoaded:function(){var _25=(this._requestQueue.length>0)?this._requestQueue[0]:null;while(_25&&_25.success!=null){this._requestQueue.shift();var _26=_25.callback;var _27=_25.response;var _28=_25.contextParameters;var _29=_25.callerData;var _2a=_25.success;var _2b=_25.request;if(_2a){var uri=new _5(_27.uri);_27.type=uri.getType();_27.id=uri.getId();this.currentContext=_25.response;if(this._routes&&this._routes[_27.type]){this._routes[_27.type](this.currentContext,_29,uri);}if(_26){_26(_27,_29,_2b);}}else{this._contextLoadFailed(_27,_28,_29);}_25=(this._requestQueue.length>0)?this._requestQueue[0]:null;}},_contextLoadFailed:function(_2c,_2d,_2e){var _2f=_1.hitch(this,function(_30){if(_30){this._loadNewContext(_2d,_2e,this._publishContextChanged);}else{this._publishRequestFailed(_2d,_2e,_2d);}});var _31=new _4({title:this.res.errors.couldnotloadcontext.title,description:this.res.errors.couldnotloadcontext.description,confirmActionText:this.res.errors.couldnotloadcontext.retry,cancelActionText:epi.resources.action.ignore,onAction:_2f,destroyOnHide:true});_31.show();},_getContextStore:function(){if(!this._contextStore){var _32=_3.resolve("epi.storeregistry");this._contextStore=_32.get("epi.shell.context");}return this._contextStore;},_publishContextChanged:function(_33,_34,_35){_1.publish("/epi/shell/context/changed",[_33,_34,_35]);},_publishContextUpdated:function(_36,_37,_38){_1.publish("/epi/shell/context/updated",[_36,_37,_38]);},_publishRequestFailed:function(_39,_3a){_1.publish("/epi/shell/context/requestfailed",[this.currentContext,_39,_3a]);}});});