//>>built
define("epi/shell/widget/WidgetFactory",["epi","dojo","dojo/_base/array","dojo/_base/Deferred","dojo/_base/lang","dojo/DeferredList","dojo/string","epi/string","epi/dependency"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){return _2.declare("epi.shell.widget.WidgetFactory",null,{_domNodeName:"[domnode]",_handlers:null,moduleManager:null,messageService:undefined,onWidgetHierarchyCreated:null,onWidgetCreated:null,constructor:function(_a){_2.safeMixin(this,_a);this._handlers=[];this._addDefaultHandlers();this.messageService=this.messageService||_9.resolve("epi.shell.MessageService");this.moduleManager=this.moduleManager||_9.resolve("epi.ModuleManager");},createWidgets:function(_b,_c){if(typeof (_b)==="string"){_b=_2.byId(_b);}if(_c&&!_2.isArray(_c)){_c=[_c];}var _d=[];var _e=[];var _f=_5.hitch(this,function(_10){if(_10 instanceof Array){for(var i in _10){_f(_10[i]);}}if(_10.components instanceof Array){_f(_10.components);}if(_10.moduleName){_e.push(this.moduleManager.startModules(_10.moduleName));}if(_10.widgetPackage){_d.push(_8.slashName(_10.widgetPackage));}else{if(_10.widgetType){_d.push(_8.slashName(_10.widgetType));}}});_f(_c);var _11=new _4();var _12=require.on("error",function(_13){console.error(_13.stack||_13);_12.remove();_11.reject(_13);});var _14=new _6(_e);_14.then(_5.hitch(this,function(){require(_d,_5.hitch(this,function(){this._createWidgets(_b,_c).then(function(_15){_2.forEach(_15,function(w){if(!w._started&&w.startup){w.startup();}});_11.resolve(_15);});}));}));return _11;},_createWidgets:function(_16,_17){var dfd=new _2.Deferred();var _18=[];var _19=this.getHandler(_16);if(!_19){dfd.resolve(_18);return dfd;}if(!_2.isArray(_17)){dfd.resolve(_18);return dfd;}var _1a=_2.map(_17,_2.hitch(this,function(_1b){var _1c=new _2.Deferred();var _1d=this._createInternal(_16,_1b,_19);_1d.then(function(_1e){if(_1e){_18.push(_1e);}_1c.resolve();},function(e){console.error(e.stack||e);_1c.reject(e);});return _1c;}));var dl=new _6(_1a);dl.then(_2.hitch(this,function(_1f){var _20=!_2.some(_1f,function(_21){if(_21[0]===false){return true;}});if(_20){dfd.resolve(_18);}else{console.error("WidgetFactory: Could not resolve one or more widgets");dfd.reject(_18);}}));return dfd;},_createInternal:function(_22,_23,_24){var _25=new _2.Deferred();_2.Deferred.when(_24.instantiateWidgetFunction(_23),_2.hitch(this,function(_26){if(_26){if(typeof this.onWidgetCreated=="function"){this.onWidgetCreated(_26,_23);}var _27=(_24.type==this._domNodeName);if(!_27){_24.addWidgetToRootFunction(_22,_26);}var _28=new _2.Deferred();if(_23.components&&_2.isArray(_23.components)&&_23.components.length>0){_28=this._createWidgets(_26,_23.components);}else{_28.resolve();}_28.then(_2.hitch(this,function(){if(_27){_24.addWidgetToRootFunction(_22,_26);}if(typeof this.onWidgetHierarchyCreated=="function"){this.onWidgetHierarchyCreated(_26,_23);}_25.resolve(_26);}),_25.reject);}else{_25.reject();}}),function(_29){console.error(_29.stack||_29);_25.reject(_29);});return _25;},defaultWidgetInstantiator:function(_2a){var def=new _2.Deferred();var _2b=_2.mixin({},_2a.settings,{componentId:_2a.id});var _2c=_8.slashName(_2a.widgetType);var _2d=_2a.widgetPackage&&_5.getObject(_2a.widgetType);var _2e=require.on("error",function(_2f){console.error(_2f.stack||_2f);_2e.remove();def.reject(_2f);});function _30(_31){var _32=new _31(_2b);if(_2a.connections){for(var evt in _2a.connections){if(_2a.connections[evt]){_32.connect(_32,evt,_2a.connections[evt]);}}}_2e.remove();def.resolve(_32);};if(_2d){_30(_2d);}else{require([_2c],_2.hitch(this,_30));}return def;},_notifyError:function(msg){if(this.messageService){this.messageService.put("error",msg);}},_addDefaultHandlers:function(){this.addHandler(this._domNodeName,function(_33,_34){_34.placeAt(_33);},null,function(){return true;});this.addHandler("dijit/_Widget",function(_35,_36){_35.set("content",_36);});this.addHandler("dijit/_Container",function(_37,_38){_37.addChild(_38);});this.addHandler("epi/shell/widget/ToolbarDropDownButton",function(_39,_3a){_39.addChild(_3a);});this.addHandler("dojox/layout/GridContainerLite",function(_3b,_3c){_3b.addChild(_3c,_3c.params.column);});},addHandler:function(_3d,_3e,_3f,_40){var _41=function(_42,_43){return _43&&_5.isFunction(_42.isInstanceOf)&&_42.isInstanceOf(_43);};var _44=_5.hitch(this,function(_45){var _46=this.getHandlerByTypeName(_3d);var _47=_40||_41;var _48=_46?true:false;if(!_48){_46={};}var _49=_3f||_2.hitch(this,this.defaultWidgetInstantiator);_46.type=_3d;_46.instantiateWidgetFunction=_49;_46.addWidgetToRootFunction=_3e;_46.widgetConstructor=_45;_46.canHandle=_47;if(!_48){this._handlers.push(_46);}});if(_3d!=this._domNodeName){require([_8.slashName(_3d)],_44);}else{_44();}},getHandler:function(_4a){var _4b=this._handlers;for(var i=_4b.length-1;i>=0;i--){if(_4b[i].canHandle(_4a,_4b[i].widgetConstructor)){return _4b[i];}}return null;},getHandlerByTypeName:function(_4c){var _4d=this._handlers;for(var i=0;i<_4d.length;i++){if(_4d[i].type===_4c){return _4d[i];}}return null;},removeHandler:function(_4e){var _4f=this._handlers;for(var i=0;i<_4f.length;i++){if(_4f[i].type===_4e){_4f.splice(i,1);}}},listHandlers:function(){var _50=this._handlers;return _2.map(_50,function(_51){return _51.type;});}});});